<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset Password ‚Ä¢ Tharaga</title>
  <meta name="description" content="Secure login and signup for Tharaga partner portals and listings." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>
    :root{
      /* Tharaga Brand Palette */
      --bg:#0a0a0a;          /* Deep Obsidian Background */
      --card:#151515;        /* Charcoal Card Surface */
      --muted:#9ca3af;       /* Muted Platinum Gray */
      --txt:#f5f5f5;         /* Platinum White Text */
      --acc:#d4af37;         /* Regal Gold (primary accent) */
      --acc2:#16a34a;        /* Emerald Green (secondary accent) */
      --warn:#f59e0b;        /* Amber Gold (warnings, classy) */
      --err:#dc2626;         /* Rich Crimson (errors) */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 80% -10%,#1c1c1c 0%,transparent 60%),
        radial-gradient(900px 700px at -10% 20%,#111111 0%,transparent 60%),
        var(--bg);
      color:var(--txt);
    }
    .container{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 20px;color:var(--txt);
    }
    header a, header button{color:var(--txt);text-decoration:none;font-weight:600;opacity:.85}
    header a:hover{opacity:1;color:var(--acc)}
    main{display:grid;place-items:center;padding:24px}
    .card{
      width:420px;max-width:95vw;
      background:linear-gradient(180deg,#1a1a1a,#0f0f0f);
      backdrop-filter:saturate(180%) blur(10px);
      border:1px solid rgba(212,175,55,.25); /* subtle gold tint */
      border-radius:16px;
      box-shadow:0 10px 40px rgba(0,0,0,.55);
      padding:22px;
      color:var(--txt);
    }
    h1{font-size:22px;margin:0 0 6px;color:var(--acc)}
    p.muted{color:var(--muted);margin:0 0 16px;font-size:14px}
    label{display:block;font-size:13px;margin:10px 0 6px;color:var(--txt)}
    input{
      position: relative;width:100%;padding:12px 12px;border-radius:10px;padding-right: 40px;;
      border:1px solid #333333;
      background:#1e1e1e;
      color:var(--txt);
      outline:none;
    }
    input:focus{
      border-color:var(--acc);
      box-shadow:0 0 0 3px rgba(212,175,55,.25);
    }

    /* wrapper around input + icon */
.input-pill {
  position: relative;   /* anchor for the absolute icon */
  width: 100%;
}

/* make sure the input leaves room for the icon */
.input-pill input {
  width: 100%;
  padding-right: 44px;  /* provide space so text doesn't overlap the eye */
  box-sizing: border-box;
}
    .toggle-eye{position:absolute;top:50%;right:12px;transform:translateY(-50%);cursor:pointer;font-size:14px;opacity:.7;color:var(--muted)}
    .toggle-eye:hover{opacity:1;color:var(--acc)}
    .row{display:flex;gap:10px}
    .btn{cursor:pointer;border:0;border-radius:10px;padding:12px 14px;font-weight:700;color:var(--txt)}
    .btn-primary{background:linear-gradient(180deg,var(--acc),#b8860b);color:black}
    .btn-ghost{background:transparent;border:1px solid #333333;color:var(--muted)}
    .btn-danger{background:linear-gradient(180deg,var(--err),#7f1d1d);color:white}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .msg{margin-top:12px;font-size:14px}
    .msg.ok{color:var(--acc2)}
    .msg.err{color:#fca5a5}
    .divider{height:1px;background:linear-gradient(90deg,transparent,#2d2d2d,transparent);margin:16px 0}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border:1px solid #333333;
      border-radius:999px;
      background:rgba(20,20,20,.6);
      font-size:12px;
      color:var(--muted)
    }
    footer{padding:18px 20px;color:var(--muted);font-size:12px;text-align:center}
    .hidden{display:none !important}
    .flex{display:flex;align-items:center;gap:10px}
    .right{margin-left:auto}
    .copy{cursor:pointer;font-size:12px;opacity:.8;color:var(--muted)}
    .copy:hover{opacity:1;color:var(--acc)}
    .small-link{font-size:12px;color:var(--acc2);text-decoration:none}
    .small-link:hover{text-decoration:underline;color:var(--acc)}
    .success-block{
      background:#0f1f12;
      border:1px solid #224422;
      border-radius:12px;
      padding:12px;
      margin-top:12px;
      color:var(--acc2)
    }
</style>
</head>
<body>
  <div class="container">
    <header>
      <a href="/">‚Üê Back to Tharaga</a>
      <span class="pill">Verified Listings ‚Ä¢ Direct Owner</span>
    </header>

    <main>
      <section class="card" aria-live="polite">
        <h1>Reset your password</h1>
        <p class="muted">"Choose a new password to secure your account"</p>

        <!-- request-reset form -->
<form id="requestForm" autocomplete="on">
  <label for="resetEmail">Email</label>
  <input id="resetEmail" type="email" placeholder="you@domain.com" required>
  <button id="sendResetBtn" class="btn btn-primary" type="button">Send Reset Link</button>
  <div id="reqMsg" class="msg" role="status"></div>
</form>

<!-- new password form (hidden until email link opens this page with session) -->
<form id="resetForm" class="hidden">
  <label for="newPwd">New Password</label>
  <input id="newPwd" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
  <span id="toggleNewEye" class="toggle-eye">üëÅ</span>

  <label for="newPwd2">Confirm Password</label>
  <input id="newPwd2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>

  <button id="doResetBtn" class="btn btn-primary" type="button">Update Password</button>
  <div id="resetMsg" class="msg" role="status"></div>
</form>
      </section>
    </main>

    <footer>
      ¬© <span id="year"></span> Tharaga
    </footer>
  </div>

  <!-- Auth + Gate Logic -->
  <script type="module">
    // ========================= CONFIG =========================
    // Fill these with your project values
    const SUPABASE_URL = 'https://wedevtjjmdvngyshqdro.supabase.co'; // <-- REQUIRED
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M';         // <-- REQUIRED
	
	// Make sure this exact URL is present in Supabase Auth Redirect URLs
    const POST_RESET_CALLBACK = `${location.origin}/reset_password`;

    // Domains we auto-protect when using the gate snippet on other pages
    const PROTECTED_DOMAINS = ['nobroker', 'magicbricks', '99acres', 'housing.com', 'makaan', 'quikrhomes'];

    // Callback page for magic links / email confirmations. Keep under your domain and add to Supabase Redirect URLs.
    //const POST_AUTH_CALLBACK = `${location.origin}/login_signup?post_auth=1`;

    // ========================= IMPORT =========================
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========================= UI HOOKS ========================
    const yearEl = document.getElementById('year');
    yearEl.textContent = new Date().getFullYear();

    // UI elements
const requestForm = document.getElementById('requestForm');
const resetForm   = document.getElementById('resetForm');
const resetEmail  = document.getElementById('resetEmail');
const sendResetBtn= document.getElementById('sendResetBtn');
const reqMsg      = document.getElementById('reqMsg');
const newPwd      = document.getElementById('newPwd');
const newPwd2     = document.getElementById('newPwd2');
const doResetBtn  = document.getElementById('doResetBtn');
const resetMsg    = document.getElementById('resetMsg');
const toggleNewEye= document.getElementById('toggleNewEye');

// Step 1: send reset email
sendResetBtn?.addEventListener('click', async () => {
  const email = resetEmail.value.trim();
  if (!email) return reqMsg.textContent = 'Enter a valid email';
  reqMsg.textContent = 'Sending reset link...';
  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: POST_RESET_CALLBACK
  });
  if (error) {
  reqMsg.textContent = error.message;
  reqMsg.className = 'msg err';
} else {
  reqMsg.textContent = 'Check your email for a password reset link.';
  reqMsg.className = 'msg ok';
}
});

// Step 2: when user lands here via reset link, show password form
async function trySetSessionFromHash() {
  const hash = location.hash.replace(/^#/, '');
  if (!hash) return false;
  const params = new URLSearchParams(hash);
  const access_token = params.get('access_token');
  const refresh_token = params.get('refresh_token');
  if (!access_token) return false;
  const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
  if (error) { console.warn('setSession error', error); return false; }
  // remove tokens from URL to avoid leaking them
  history.replaceState(null, '', location.pathname);
  return !!data?.session;
}

async function tryExchangeCode() {
  const code = new URLSearchParams(location.search).get('code');
  if (!code) return false;
  const { data, error } = await supabase.auth.exchangeCodeForSession(code);
  if (error) { console.warn('exchangeCodeForSession error', error); return false; }
  history.replaceState(null, '', location.pathname);
  return !!data?.session;
}

(async function checkRecovery() {
  // 1) see if tokens are in hash and set session
  const fromHash = await trySetSessionFromHash();
  if (fromHash) {
    requestForm.classList.add('hidden');
    resetForm.classList.remove('hidden');
    return;
  }

  // 2) if a PKCE code is present, exchange it for a session
  const fromCode = await tryExchangeCode();
  if (fromCode) {
    requestForm.classList.add('hidden');
    resetForm.classList.remove('hidden');
    return;
  }

  // 3) final fallback: listen for password recovery / signin event
  supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'PASSWORD_RECOVERY' || event === 'SIGNED_IN') {
      requestForm.classList.add('hidden');
      resetForm.classList.remove('hidden');
    }
  });

  // 4) last-ditch: if a session already exists, show form
  const { data } = await supabase.auth.getSession();
  if (data?.session) {
    requestForm.classList.add('hidden');
    resetForm.classList.remove('hidden');
  }
})();

// Step 3: update password
doResetBtn?.addEventListener('click', async () => {
  const p1 = newPwd.value.trim(), p2 = newPwd2.value.trim();
  if (!p1 || p1 !== p2) return resetMsg.textContent = 'Passwords do not match';
  resetMsg.textContent = 'Updating password...';
  const { error } = await supabase.auth.updateUser({ password: p1 });
if (error) {
  const ms = (error.message || '').toLowerCase();
  if (ms.includes('auth session') || ms.includes('session')) {
    resetMsg.textContent = 'Session missing ‚Äî open the reset link in the same browser/device you requested it from.';
  } else {
    resetMsg.textContent = error.message || 'Error updating password';
  }
  resetMsg.className = 'msg err';
} else {
  resetMsg.textContent = 'Password updated! Redirecting...';
  resetMsg.className = 'msg ok';
  setTimeout(()=>{ location.href='/login_signup'; }, 2000);
}

});

// toggle eye
toggleNewEye?.addEventListener('click', () => {
  const t = newPwd.type === 'password' ? 'text':'password';
  newPwd.type = t;
  toggleNewEye.textContent = t==='password'?'üëÅ':'üôà';
});

    

  </script>
</body>
</html>
