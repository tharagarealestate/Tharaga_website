<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Direct-to-Builder Deals</title>
  <link rel="stylesheet" href="/css/brand.css" />
  <style>
    body{ padding:24px; }
    header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
    h1.h1{ margin:0 0 8px }
    .wrap{ display:grid; grid-template-columns: 320px 1fr; gap:16px }
    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px }
    table{ width:100%; border-collapse:collapse }
    th,td{ text-align:left; padding:8px 10px; border-bottom:1px solid #eee }
  </style>
</head>
<body>
  <header>
    <div>
      <h1 class="h1">Direct-to-Builder Deals</h1>
      <p class="sub" style="color:#666;margin:0">Manage pricing, discounts, and instant buyer chat with audit trail.</p>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <button id="startFree" class="btn" style="background:#facc15;color:#111;border-color:#facc15;width:auto">Start free</button>
      <a href="/" style="color:#111;text-decoration:none">← Back</a>
    </div>
  </header>

  <div class="wrap">
    <aside class="card" aria-label="Deal controls">
      <div class="field"><label for="base">Base Price (₹/sqft)</label><input id="base" class="input" type="number" value="7200" /></div>
      <div class="field"><label for="disc">Discount (%)</label><input id="disc" class="input" type="number" value="5" /></div>
      <div class="field"><label for="exp">Offer Expires</label><input id="exp" class="input" type="date" /></div>
      <div class="field"><label for="pay">Payment Schedule</label>
        <select id="pay">
          <option>Construction Linked</option>
          <option>20-80 Plan</option>
          <option>10-90 Plan</option>
        </select>
      </div>
      <button id="apply" class="btn">Apply Offer</button>
    </aside>

    <main class="card" aria-label="Quotes and chat">
      <h2 style="margin:0 0 10px">Live Quotes</h2>
      <table aria-describedby="qdesc">
        <caption id="qdesc" class="visually-hidden">Buyer quotes table</caption>
        <thead><tr><th>Buyer</th><th>Area (sqft)</th><th>Quote (₹)</th><th>Status</th></tr></thead>
        <tbody id="quotes"></tbody>
      </table>

      <div style="margin-top:14px; display:grid; grid-template-columns: 1fr 260px; gap:12px;">
        <section class="card" style="padding:10px">
          <h3 style="margin:0 0 8px">Chat</h3>
          <div id="chat" style="height:160px;border:1px solid #eee;border-radius:10px;padding:8px;overflow:auto; background:#fafafa"></div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <input id="msg" class="input" placeholder="Type message" />
            <button id="send" class="btn" style="width:auto">Send</button>
          </div>
        </section>
        <section>
          <h3 style="margin:0 0 8px">Offer Summary</h3>
          <div id="sum" class="card" style="padding:10px"></div>
        </section>
      </div>
    </main>
  </div>

  <script>
    (function(){
      function openLogin(next){
        try { if (window.parent && window.parent.authGate && typeof window.parent.authGate.openLoginModal === 'function'){ window.parent.authGate.openLoginModal({ next: next || (location.pathname + location.search) }); return; } } catch(_){ }
        try { window.parent && window.parent.postMessage({ type:'open_login_modal', next: next || (location.pathname + location.search) }, '*'); } catch(_){ }
        try { if (typeof window.__thgOpenAuthModal === 'function') window.__thgOpenAuthModal({ next: next || (location.pathname + location.search) }); } catch(_){ }
      }
      try { document.getElementById('startFree').addEventListener('click', function(){ openLogin(); }); } catch(_){ }

      // auto-resize when embedded
      function notifyHeight(){
        try { const h = document.documentElement.scrollHeight; window.parent && window.parent.postMessage({ type:'thg-embed-height', id:'builder-deals', height:h }, '*'); } catch(_){ }
      }
      try { new ResizeObserver(notifyHeight).observe(document.body); } catch(_){ }
      setInterval(notifyHeight, 1000);
      notifyHeight();
      const rupee = (n)=> '₹' + n.toLocaleString('en-IN');
      const base = document.getElementById('base');
      const disc = document.getElementById('disc');
      const exp = document.getElementById('exp');
      const pay = document.getElementById('pay');
      const sum = document.getElementById('sum');
      const apply = document.getElementById('apply');

      const quotesEl = document.getElementById('quotes');
      const chat = document.getElementById('chat');
      const msg = document.getElementById('msg');
      const send = document.getElementById('send');

      const buyers = [
        { name: 'Arun', sqft: 980 },
        { name: 'Divya', sqft: 1240 },
        { name: 'Kumar', sqft: 765 },
      ];

      function compute(){
        const bp = Number(base.value || 0);
        const d = Math.min(50, Math.max(0, Number(disc.value || 0)));
        const multiplier = (100 - d)/100;
        sum.innerHTML = [
          '<div><strong>Base:</strong> ', rupee(bp), ' /sqft</div>',
          '<div><strong>Discount:</strong> ', d, '%</div>',
          '<div><strong>Net:</strong> ', rupee(Math.round(bp*multiplier)), ' /sqft</div>',
          '<div><strong>Plan:</strong> ', pay.value, '</div>',
          '<div><strong>Expires:</strong> ', (exp.value||'—'), '</div>'
        ].join('');

        quotesEl.innerHTML = buyers.map(b => {
          const quote = Math.round(bp*multiplier*b.sqft);
          return '<tr><td>' + b.name + '</td><td>' + b.sqft + '</td><td>' + rupee(quote) + '</td><td><span class="pill">New</span></td></tr>';
        }).join('');
      }

      function chatLine(who, text){
        const el = document.createElement('div');
        el.innerHTML = '<strong>' + who + ':</strong> ' + text;
        chat.appendChild(el);
        chat.scrollTop = chat.scrollHeight;
      }

      base.addEventListener('input', compute);
      disc.addEventListener('input', compute);
      exp.addEventListener('input', compute);
      pay.addEventListener('change', compute);
      apply.addEventListener('click', compute);
      compute();

      send.addEventListener('click', () => {
        const text = (msg.value||'').trim();
        if (!text) return;
        chatLine('Builder', text);
        msg.value = '';
        setTimeout(() => chatLine('Arun', 'Thanks, checking with family.'), 500);
      });
    })();
  </script>
</body>
</html>
