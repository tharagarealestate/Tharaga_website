<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tharaga â€” CTA Embed</title>
  <link rel="stylesheet" href="/css/brand.css" />
  <style>
    /* Uses brand.css variables; provide fallbacks if it fails to load */
    :root{--brand:#6e0d25;--brand-600:#8a1637;--surface:#0f0d0e;--surface-2:#151316;--text:#fff;--muted:#c6c3c6;--ring:rgba(212,175,55,.35);--ok:#39b54a}

    html, body { margin: 0; background: transparent; color: var(--text); font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    /* Center the CTA within the iframe and allow scenic background */
    body { min-height: 100dvh; display: grid; place-items: center; position: relative; }

    /* Background image layer (optional via ?bg=URL) */
    .bg-img { position: fixed; inset: 0; background-position: center; background-size: cover; background-repeat: no-repeat; filter: blur(14px) saturate(1.05); transform: scale(1.08); opacity: .85; z-index: -2; }
    /* Tint/gradient overlay to ensure readability over the blurred image */
    .bg-tint { position: fixed; inset: 0; pointer-events: none; z-index: -1;
      background: radial-gradient(1200px 420px at 8% -80%, rgba(110,13,37,0.45), transparent),
                  linear-gradient(180deg, rgba(15,13,14,0.88), rgba(15,13,14,0.88));
    }

    .cta {
      position: relative;
      background: radial-gradient(1200px 200px at 20% -50%, rgba(110,13,37,0.45), transparent),
                  linear-gradient(180deg, var(--surface-2), var(--surface));
      color: var(--text);
      padding: 18px 22px;
      border-radius: 16px;
      width: min(760px, 94vw);
      margin: 0 auto;
      box-shadow: 0 10px 28px rgba(0,0,0,0.22);
      text-align: left;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .cta::after {
      content: ""; position: absolute; inset: 0; border-radius: 16px; pointer-events: none;
      box-shadow: 0 0 0 1px var(--ring) inset;
      opacity: .35;
    }
    .cta h2 { margin: 0 0 6px; font-size: 1.25rem; letter-spacing: 0.2px; }
    .cta p { margin: 0 0 12px; color: #e7e2e5; font-size: .95rem; }
    .row { display: grid; grid-template-columns: minmax(180px,1fr) auto; gap: 12px; align-items: center; }
    .row > * { min-width: 0; }
    .field-inline { position: relative; min-width: 0; }
    .field-inline input {
      width: 100%; min-width: 0; padding: 12px 14px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      outline: none;
    }
    .field-inline input::placeholder { color: rgba(255,255,255,0.6); }
    .primary-btn {
      padding: 12px 18px; border-radius: 12px; border: 0; background: var(--brand); color: #fff; font-weight: 700; cursor: pointer; white-space: nowrap;
      box-shadow: 0 6px 18px rgba(110,13,37,0.35);
    }
    .primary-btn:hover { background: var(--brand-600); }
    .note { font-size: 0.82rem; color: #e7e2e5; margin-top: 10px; opacity: .85; }

    /* On narrow containers stack input and button to avoid overlap */
    @media (max-width: 520px) {
      .row { grid-template-columns: 1fr; }
      .primary-btn { width: 100%; }
    }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(9, 7, 8, 0.72); display: none; align-items: center; justify-content: center; padding: 22px; backdrop-filter: blur(8px); }
    .modal {
      width: min(560px, 96vw); background: radial-gradient(1200px 300px at 10% -60%, rgba(110,13,37,0.35), transparent), linear-gradient(180deg, var(--surface-2), var(--surface)); color: var(--text);
      border-radius: 16px; padding: 18px; box-shadow: 0 24px 50px rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.06);
      max-height: 92vh; overflow: auto;
    }
    .modal h3 { margin: 0 0 12px; font-size: 1.1rem; }
    .grid { display: grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr); gap: 14px; align-items: start; }
    @media (max-width: 560px) { .grid { grid-template-columns: 1fr; } }
    label { font-size: 0.86rem; color: #e4dfe3; display: inline-block; margin-bottom: 6px; }
    .modal input, .modal textarea {
      width: 100%; padding: 11px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.06); color: var(--text); outline: none;
    }
    .modal input:focus, .modal textarea:focus { box-shadow: 0 0 0 2px var(--ring); border-color: transparent; }
    .modal textarea { min-height: 96px; resize: vertical; }
    .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 14px; }
    .btn { padding: 10px 14px; border-radius: 12px; border: 0; cursor: pointer; font-weight: 600; }
    .btn-secondary { background: rgba(255,255,255,0.08); color: #fff; }
    .btn-secondary:hover { background: rgba(255,255,255,0.12); }
    .btn-primary { background: var(--brand); color: #fff; }
    .btn-primary:hover { background: var(--brand-600); }
    .hint { font-size: 0.8rem; color: #d7d0d5; }
    .error { color: #ff6b6b; }
    .ok { color: var(--ok); }
    .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

    /* Make inputs respect container width, prevent visual overlap on some browsers */
    .modal * { box-sizing: border-box; }

    /* Trust badges to increase completion */
    .badges { display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 10px; }
    .badge { font-size: .72rem; color:#e7e2e5; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); padding:6px 8px; border-radius:999px; }

    /* Recommendations preview inside modal */
    .recs { margin-top: 10px; }
    .recs h4 { margin: 0 0 8px; font-size: 0.98rem; color: #efe9ec; }
    .rec-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width: 560px) { .rec-row { grid-template-columns: 1fr 1fr; } }
    .rec-card { display:flex; flex-direction:column; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; overflow:hidden; }
    .rec-img { position: relative; padding-top: 60%; background: rgba(255,255,255,0.06); }
    .rec-img img { position:absolute; inset:0; width:100%; height:100%; object-fit: cover; }
    .rec-body { padding: 8px 10px; display:flex; flex-direction:column; gap: 4px; }
    .rec-title { font-size: 0.86rem; line-height: 1.2; color:#fff; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .rec-specs { font-size: 0.78rem; color:#d7d0d5; }
    .rec-actions { display:flex; gap:6px; margin-top: 4px; }
    .rec-actions a { flex:1; text-align:center; padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.12); color:#fff; text-decoration:none; font-size:.78rem; }
    .rec-actions a:hover { background: rgba(255,255,255,0.06); }
    .rec-skel { height: 120px; border-radius: 12px; border:1px solid rgba(255,255,255,0.08); background: linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.07), rgba(255,255,255,0.04)); background-size: 300% 100%; animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 0% { background-position: 0 0; } 100% { background-position: -300% 0; } }
    .rec-card.selected { border-color: var(--ring); box-shadow: 0 0 0 2px var(--ring) inset; }
  </style>
  <script src="/js/analytics.js"></script>
</head>
<body>
  <!-- Optional scenic background (hidden unless ?bg= is provided) -->
  <div class="bg-img" id="bg-img" aria-hidden="true" style="display:none"></div>
  <div class="bg-tint" aria-hidden="true"></div>
  <section class="cta" id="buyer-cta">
    <h2>Get 3 verified matches</h2>
    <p>Share your WhatsApp or phone. Our team sends handâ€‘picked options fast.</p>
    <div class="row">
      <div class="field-inline">
        <label for="cta-phone" class="visually-hidden">WhatsApp or phone</label>
        <input id="cta-phone" type="tel" placeholder="WhatsApp / phone" inputmode="tel" autocomplete="tel" />
      </div>
      <button id="open-microform" class="primary-btn" type="button" aria-haspopup="dialog" aria-controls="backdrop">Continue</button>
    </div>
    <div class="note">Low effort, high signal: no spam, only verified listings.</div>
  </section>

  <div class="modal-backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lead-title" aria-describedby="lead-note">
      <h3 id="lead-title">Tell us what you need <span class="hint">(~60 seconds)</span></h3>
      <div class="badges" aria-hidden="true">
        <div class="badge">âœ“ Verified listings</div>
        <div class="badge">âš¡ Humanâ€‘curated options fast</div>
        <div class="badge">ðŸ”’ No spam</div>
      </div>
      <div class="grid">
        <div>
          <label for="lead-name">Name</label>
          <input id="lead-name" type="text" placeholder="Your name" autofocus />
        </div>
        <div>
          <label for="lead-phone">WhatsApp / phone</label>
          <input id="lead-phone" type="tel" placeholder="Required" inputmode="tel" autocomplete="tel" />
        </div>
        <div>
          <label for="lead-email">Email (optional)</label>
          <input id="lead-email" type="email" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div>
          <label for="lead-ctx">City / Budget (optional)</label>
          <input id="lead-ctx" type="text" placeholder="e.g., Chennai Â· 70L" />
        </div>
        <div style="grid-column: 1 / -1;">
          <label for="lead-message">Anything specific?</label>
          <textarea id="lead-message" placeholder="Locality, BHK, timelineâ€¦"></textarea>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-secondary" id="lead-cancel" type="button">Cancel</button>
        <button class="btn btn-primary" id="lead-submit" type="button">Request matches</button>
      </div>
      <div class="note" id="lead-note" aria-live="polite"></div>
      <!-- Honeypot moved out of grid to avoid layout edge-cases -->
      <input id="lead-company" type="text" autocomplete="organization" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;opacity:0" aria-hidden="true" tabindex="-1" />
      <input id="lead-prop" type="text" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;opacity:0" aria-hidden="true" tabindex="-1" />

      <div class="recs" id="lead-recs" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // Elements
    const backdrop = document.getElementById('backdrop');
    const modal = backdrop.querySelector('.modal');
    const openBtn = document.getElementById('open-microform');
    const phoneInline = document.getElementById('cta-phone');
    const cancelBtn = document.getElementById('lead-cancel');

    // Focus trap helpers
    let lastFocused = null;
    function getFocusable(){
      return modal.querySelectorAll('a, button, input, textarea, select, [tabindex]:not([tabindex="-1"])');
    }
    function openModal(){
      const phoneVal = (phoneInline?.value || '').trim();
      const phoneInput = document.getElementById('lead-phone');
      if (phoneVal && phoneInput && !phoneInput.value) phoneInput.value = phoneVal;
      lastFocused = document.activeElement;
      backdrop.style.display = 'flex';
      backdrop.setAttribute('aria-hidden', 'false');
      const f = getFocusable(); if (f.length) f[0].focus();
    }
    function closeModal(){
      backdrop.style.display = 'none';
      backdrop.setAttribute('aria-hidden', 'true');
      document.getElementById('lead-note').textContent = '';
      if (lastFocused && lastFocused.focus) setTimeout(()=> lastFocused.focus(), 0);
    }

    openBtn?.addEventListener('click', openModal);
    cancelBtn?.addEventListener('click', closeModal);
    backdrop.addEventListener('click', (e)=> { if (e.target === backdrop) closeModal(); });
    modal.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') { e.preventDefault(); closeModal(); return; }
      if (e.key === 'Tab'){
        const focusable = Array.from(getFocusable());
        const first = focusable[0]; const last = focusable[focusable.length-1];
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
    });

    // Allowed parent origins for embed postMessage
    const ALLOWED_PARENTS = ['https://tharaga.co.in', 'https://www.tharaga.co.in', 'https://auth.tharaga.co.in', location.origin];
    function postToParent(payload){
      try {
        const parentOrigin = (function(){ try { return new URL(document.referrer).origin; } catch(_) { return '*'; } })();
        if (ALLOWED_PARENTS.includes(parentOrigin) || /tharaga\.co\.in/.test(parentOrigin)) {
          window.parent.postMessage(payload, parentOrigin);
        } else {
          window.parent.postMessage(payload, '*');
        }
      } catch(_){}
    }

    // Auto-size to container so parent (e.g., Durable) shows only CTA without scrollbars
    (function autoSize(){
      function send(){
        try {
          const cta = document.getElementById('buyer-cta');
          if (!cta) return;
          const rect = cta.getBoundingClientRect();
          const height = Math.ceil(rect.height + 40); // cushion for shadow
          postToParent({ type: 'tharaga_iframe_height', height });
        } catch(_){ }
      }
      const obsTarget = document.getElementById('buyer-cta') || document.body;
      const ro = new ResizeObserver(()=>send());
      ro.observe(obsTarget);
      window.addEventListener('load', send);
      window.addEventListener('resize', send);
      setTimeout(send, 80);
    })();

    function buildCtxFromQuery(){
      const p = new URLSearchParams(location.search);
      const parts = [];
      const city = p.get('city');
      const budget = p.get('budget');
      if (city) parts.push(city);
      if (budget) parts.push(budget);
      return parts.join(' Â· ');
    }

    // Phone UX helpers
    const waPreview = document.createElement('div');
    waPreview.className = 'hint';
    modal.querySelector('.actions').before(waPreview);
    function normalizePhone(p){ return (p||'').replace(/[^\d+]/g,''); }
    function whatsappLink(p){ const ph = normalizePhone(p); if (!ph) return ''; return `https://wa.me/${ph}`; }
    const phoneEl = document.getElementById('lead-phone');
    phoneEl.addEventListener('input', ()=>{ const link = whatsappLink(phoneEl.value); waPreview.textContent = link ? `WhatsApp link will open: ${link}` : ''; });

    async function submitLead() {
      const name = (document.getElementById('lead-name').value || '').trim();
      const phone = (document.getElementById('lead-phone').value || '').trim();
      const email = (document.getElementById('lead-email').value || '').trim();
      const ctx = (document.getElementById('lead-ctx').value || '').trim();
      const message = (document.getElementById('lead-message').value || '').trim();
      const note = document.getElementById('lead-note');
      note.textContent = '';
      if (!phone && !email) { note.textContent = 'Provide WhatsApp/phone or email.'; note.className = 'note error'; (document.getElementById('lead-phone').focus()); return; }
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { note.textContent = 'Enter a valid email.'; note.className = 'note error'; (document.getElementById('lead-email').focus()); return; }

      const btn = document.getElementById('lead-submit');
      btn.disabled = true; btn.textContent = 'Sendingâ€¦';
      const selectedPid = (document.getElementById('lead-prop')||{}).value||'';
      const payload = { property_id: selectedPid || null, name, phone: normalizePhone(phone), email, message: [ctx || buildCtxFromQuery(), message].filter(Boolean).join(' â€¢ '), _hp: (document.getElementById('lead-company')||{}).value||'' };
      try {
        const res = await fetch('/api/leads', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await res.json();
        if (data && data.ok) {
          note.textContent = 'Thanks! We will WhatsApp you verified matches soon.'; note.className = 'note ok';
          try { window.thgTrack && window.thgTrack('cta_lead_ok', { location: 'cta-embed', phone: !!phone, email: !!email }); } catch(_){ }
          postToParent({ type: 'tharaga_lead_ok', payload });
          // Keep the modal for a moment to let users view picks
          loadRecommendations();
          setTimeout(() => { closeModal(); }, 1400);
        } else {
          const friendly = (data && typeof data.error === 'string' && /schema cache|relation|table/i.test(data.error))
            ? 'We are updating our system. Your request was received and our team will reach you shortly.'
            : (data && data.error) || 'Could not submit right now. Please try again.';
          note.textContent = friendly; note.className = 'note error';
          try { window.thgTrack && window.thgTrack('cta_lead_error', { location: 'cta-embed', error: (data && data.error)||'unknown' }); } catch(_){ }
          postToParent({ type: 'tharaga_lead_error', error: (data && data.error) || 'unknown' });
        }
      } catch (e) {
        note.textContent = 'Network issue. Please try again.'; note.className = 'note error';
        try { window.thgTrack && window.thgTrack('cta_lead_error', { location: 'cta-embed', error: 'network' }); } catch(_){ }
        postToParent({ type: 'tharaga_lead_error', error: 'network' });
      } finally { btn.disabled = false; btn.textContent = 'Request matches'; }
    }
    document.getElementById('lead-submit')?.addEventListener('click', submitLead);
    modal.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' && (e.target.tagName === 'INPUT')) { e.preventDefault(); submitLead(); }});
  </script>
  <script>
    // Prefill from query; support durable embed minimal layout + background psychology themes
    try {
      const params = new URLSearchParams(location.search);
      const inlinePhone = params.get('phone') || params.get('whatsapp') || '';
      if (inlinePhone) { const el = document.getElementById('cta-phone'); if (el) el.value = inlinePhone; }

      // Curated default backgrounds (human-psychology informed)
      // Principles: warm ambient interiors and soft bokeh drive trust and comfort; city skylines
      // signal aspiration; subtle greenery reduces stress. We keep them blurred behind the CTA.
      const PSY_BG_CATALOG = {
        warm_home: 'https://images.unsplash.com/photo-1493666438817-866a91353ca9?q=80&w=1600&auto=format&fit=crop',
        modern_living: 'https://images.unsplash.com/photo-1505691723518-36a5ac3bcb48?q=80&w=1600&auto=format&fit=crop',
        skyline_twilight: 'https://images.unsplash.com/photo-1499343245400-cddc78a01317?q=80&w=1600&auto=format&fit=crop',
        greenery_soft: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=1600&auto=format&fit=crop',
        luxury_detail: 'https://images.unsplash.com/photo-1523217582562-09d0def993a6?q=80&w=1600&auto=format&fit=crop'
      };

      // Background image support for embeds (e.g., Durable sections)
      const theme = (params.get('theme') || '').toLowerCase();
      const bgUrl = params.get('bg') || params.get('image') || (
        theme && PSY_BG_CATALOG[theme] ? PSY_BG_CATALOG[theme] : PSY_BG_CATALOG.warm_home
      );
      const bgBlur = parseInt(params.get('blur') || params.get('bg_blur') || '14', 10);
      const bgEl = document.getElementById('bg-img');
      if (bgUrl && bgEl) {
        bgEl.style.backgroundImage = `url('${bgUrl}')`;
        const blurPx = (!isNaN(bgBlur) && bgBlur >= 0 && bgBlur <= 40) ? bgBlur : 14;
        bgEl.style.filter = `blur(${blurPx}px) saturate(1.05)`;
        bgEl.style.display = 'block';
      }

      const map = [ ['lead-name', 'name'], ['lead-phone', 'phone'], ['lead-email', 'email'], ['lead-ctx','ctx'], ['lead-message','message'] ];
      map.forEach(([id, key]) => { const v = params.get(key); if (v) { const el = document.getElementById(id); if (el) el.value = v; }});

      if (params.get('embed') === 'cta') {
        // In embed mode, hide only top-level chrome, not CTA copy
        document.querySelectorAll('body > h1, body > nav, body > footer').forEach(el => el.style.display = 'none');
        const cta = document.getElementById('buyer-cta'); if (cta) cta.style.marginTop = '0';
      }

      if (params.get('open') === '1') openModal();
      // Pre-load recommendations once when opened
      openBtn?.addEventListener('click', () => { setTimeout(loadRecommendations, 50); });
      // Re-load on ctx input changes (debounced)
      const ctxEl = document.getElementById('lead-ctx');
      let t = null; ctxEl?.addEventListener('input', () => { clearTimeout(t); t = setTimeout(loadRecommendations, 350); });
    } catch (e) {}
  </script>
  <script>
    // Lightweight recs loader using /api/recommendations
    function parseCityFromCtx(raw){
      const s = (raw||'').toLowerCase();
      // quick picks; extend as needed
      const cities = ['chennai','bengaluru','bangalore','mumbai','delhi','hyderabad','pune','kolkata','kochi','coimbatore','chandigarh','ahmedabad','jaipur','mysuru','mysore'];
      for (const c of cities) { if (s.includes(c)) return c.replace('bangalore','bengaluru'); }
      return '';
    }
    function parseBedroomsFromText(raw){
      const s = (raw||'').toLowerCase();
      const m = s.match(/(studio)|((\d+)\s*\+?\s*bhk)/);
      if (!m) return 0;
      if (m[1]) return 1; // studio ~ 1 BHK equivalent fallback
      const num = parseInt(m[3]||'0', 10);
      if (!num) return 0;
      // Treat forms like "3+ BHK" as minimum
      return num;
    }
    function parseSqftMin(raw){
      const s = (raw||'').toLowerCase();
      const m = s.match(/(\d+(?:\.\d+)?)\s*(k|k\+|sq\s*ft|sqft|ft2|ft)/);
      if (!m) return 0;
      let v = parseFloat(m[1]);
      if (!isFinite(v)) return 0;
      if (m[2] && m[2].startsWith('k')) v *= 1000;
      if (v < 200) return 0; // ignore tiny numbers
      return Math.round(v);
    }
    function parseBudgetToInr(raw){
      const s = (raw||'').toString().trim().toLowerCase();
      if (!s) return 0;
      const numMatch = s.match(/([0-9]+(?:\.[0-9]+)?)/);
      const x = numMatch ? parseFloat(numMatch[1]) : 0;
      if (!x) return 0;
      if (/cr|crore/.test(s)) return Math.round(x * 10000000);
      if (/l|lac|lakh|lacs/.test(s)) return Math.round(x * 100000);
      if (/k/.test(s)) return Math.round(x * 1000);
      return Math.round(x);
    }
    function deriveFilters(){
      const p = new URLSearchParams(location.search);
      let city = (p.get('city')||'').trim();
      let budgetInr = 0;
      const ctxEl = document.getElementById('lead-ctx');
      const msgEl = document.getElementById('lead-message');
      const ctx = (ctxEl?.value||'');
      const msg = (msgEl?.value||'');
      if (!city) {
        city = parseCityFromCtx(ctx);
        const bMatch = (ctx||'').match(/([0-9]+(?:\.[0-9]+)?\s*(?:l|lac|lakh|lacs|cr|crore|k)?)/i);
        if (bMatch) budgetInr = parseBudgetToInr(bMatch[0]);
      }
      const qBudget = p.get('budget'); if (qBudget && !budgetInr) budgetInr = parseBudgetToInr(qBudget);
      // Parse BHK and sqft from both ctx and message
      const bedroomsMin = parseBedroomsFromText(`${ctx} ${msg}`);
      const sqftMin = parseSqftMin(`${ctx} ${msg}`);
      return { city, budget_inr: budgetInr, bedrooms_min: bedroomsMin || undefined, sqft_min: sqftMin || undefined };
    }
    function recCardHtml(item){
      const specs = [];
      if (item?.specs?.bedrooms) specs.push(`${item.specs.bedrooms} BHK`);
      if (item?.specs?.area_sqft) specs.push(`${Math.round(item.specs.area_sqft)} sqft`);
      if (item?.specs?.location) specs.push(item.specs.location);
      const specsStr = specs.join(' â€¢ ');
      return `
        <div class="rec-card" data-select-pid="${item.property_id||''}">
          <div class="rec-img"><img alt="" src="${item.image_url}" loading="lazy" /></div>
          <div class="rec-body">
            <div class="rec-title">${item.title||'Property'}</div>
            <div class="rec-specs">${specsStr}</div>
            <div class="rec-actions">
              <a href="/property-listing/" target="_blank" rel="noopener">See similar</a>
            </div>
          </div>
        </div>`;
    }
    async function loadRecommendations(){
      try{
        const box = document.getElementById('lead-recs'); if (!box) return;
        const filters = deriveFilters();
        box.innerHTML = '<h4>Curated picks for you</h4><div class="rec-row"><div class="rec-skel"></div><div class="rec-skel"></div><div class="rec-skel"></div></div>';
        const res = await fetch('/api/recommendations', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ...filters, num_results: 3 }) });
        const data = await res.json();
        const items = Array.isArray(data?.items) ? data.items.slice(0,3) : [];
        if (items.length === 0) { box.innerHTML = ''; return; }
        box.innerHTML = '<h4>Curated picks for you</h4><div class="rec-row">' + items.map(recCardHtml).join('') + '</div>';
      } catch { /* ignore */ }
    }
    document.getElementById('lead-recs')?.addEventListener('click', (ev) => {
      const el = ev.target.closest('[data-select-pid]');
      if (!el) return;
      const pid = el.getAttribute('data-select-pid');
      if (!pid) return;
      const hid = document.getElementById('lead-prop'); if (hid) hid.value = pid;
      document.querySelectorAll('.rec-card').forEach(c => c.classList.remove('selected'));
      el.closest('.rec-card')?.classList.add('selected');
      const note = document.getElementById('lead-note'); if (note) { note.textContent = 'Selected a property preference.'; note.className = 'note'; }
    });
  </script>
</body>
</html>
