<body>
  <div class="msg">Please verify your email:</div>

  <button id="verifyBtn">Continue to Tharaga</button>
  <p>If the button doesn’t work, <a id="fallback" href="#">click here</a></p>

  <!-- only the <script type="module"> block to replace your current one -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://wedevtjjmdvngyshqdro.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE"; // keep your anon key
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    (function(){
      const params = new URLSearchParams(location.search);
      const rawConf = params.get('confirmation_url'); // email template sends this
      const btn = document.getElementById('verifyBtn');
      const fallback = document.getElementById('fallback');

      function parseHash(h) {
        if (!h) return {};
        const hash = h.replace(/^#/, '');
        const sp = new URLSearchParams(hash);
        return {
          access_token: sp.get('access_token'),
          refresh_token: sp.get('refresh_token'),
          expires_in: sp.get('expires_in'),
          token_type: sp.get('token_type'),
        };
      }

      async function finishWithSessionFromHash() {
        const { access_token, refresh_token } = parseHash(location.hash);
        if (!access_token && !refresh_token) return false;

        try {
          const { data, error } = await supabase.auth.setSession({
            access_token,
            refresh_token
          });
          if (error) throw error;

          btn.textContent = '✅ Verified — returning...';
          btn.disabled = true;

          try {
            window.opener?.postMessage({ type: 'tharaga_verify_clicked', user: data.user }, '*');
          } catch (e) { /* ignore */ }

          try {
            localStorage.setItem('__tharaga_magic_continue', JSON.stringify({ user: data.user, at: Date.now() }));
          } catch (_) {}

          try { history.replaceState({}, document.title, location.pathname); } catch(_) {}

          setTimeout(()=> { try { window.close(); } catch(_) {} }, 700);
          return true;
        } catch (err) {
          console.error('setSession failed:', err);
          return false;
        }
      }

      (async ()=> {
        if (location.hash && (location.hash.includes('access_token') || location.hash.includes('refresh_token'))) {
          const done = await finishWithSessionFromHash();
          if (done) return;
        }
      })();

      if (!rawConf) {
        document.querySelector('.msg').textContent = '❌ Invalid or expired link.';
        btn.disabled = true;
        return;
      }

      const decodedConf = decodeURIComponent(rawConf);
      console.log('auth-email-landing ready. confirmation_url (decoded):', decodedConf);

      btn.addEventListener('click', async () => {
        btn.disabled = true;
        btn.textContent = 'Opening magic link…';
        window.location.href = decodedConf;
      });

      fallback.href = 'https://tharaga.co.in';
    })();
  </script>
</body>
