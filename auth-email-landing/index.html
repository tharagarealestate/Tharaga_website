<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Email verification • Tharaga</title>
  <style>
    body { margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:flex;align-items:center;justify-content:center;height:100vh;
      background:#0a0a0a;color:#f5f5f5; }
    .card { background:linear-gradient(180deg,#1a1a1a,#0f0f0f);
      border:1px solid rgba(212,175,55,.25);border-radius:16px;padding:24px;
      width:420px;max-width:95vw;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.55); }
    h1 { color:#d4af37;font-size:22px;margin-bottom:12px; }
    p { color:#9ca3af;font-size:14px; }
    button { margin-top:20px; cursor:pointer; border:0; border-radius:10px;
      padding:12px 16px; font-weight:700; background:linear-gradient(180deg,#d4af37,#b8860b);
      color:#111; }
  </style>
</head>
<body>
  <div class="card">
    <h1 id="title">Confirming your email…</h1>
    <p id="subtitle">If this page doesn’t continue automatically, click below.</p>
    <button id="verifyBtn">Verify & Continue</button>
    <pre id="debug" style="text-align:left;color:#ddd;margin-top:12px;display:none;background:#071013;padding:8px;border-radius:8px;font-size:12px;"></pre>
  </div>

  <script>
  // Diagnostic logging (will show in console)
  console.log('[auth-email-landing] location.href=', location.href);
  console.log('[auth-email-landing] location.search=', location.search);
  console.log('[auth-email-landing] location.hash=', location.hash);


  // helpers to read params from either search or hash
  function readParams(sourceSearch = location.search, sourceHash = location.hash) {
    const s = new URLSearchParams(sourceSearch.replace(/^\?/, ''));
    const h = new URLSearchParams((sourceHash || '').replace(/^#/, ''));
    return { s, h };
  }

  const { s: searchParams, h: hashParams } = readParams();
  // Try to find confirmation_url either in query or (rarely) in hash
  const rawConfFromSearch = searchParams.get('confirmation_url');
  const rawConfFromHash = hashParams.get('confirmation_url');
  const rawConf = rawConfFromSearch || rawConfFromHash || null;
  // NOTE: do not blindly decode; try safe decode only if it looks encoded
  let confirmation_url = rawConf || null;
  if (rawConf) {
    try {
      // if it contains %3A pattern, decode once and confirm it looks like an http(s) URL
      if (/%3A|%2F/.test(rawConf)) {
        const d = decodeURIComponent(rawConf);
        if (/^https?:\/\//i.test(d)) confirmation_url = d;
      }
    } catch (e) {
      console.warn('[auth-email-landing] decodeURIComponent failed', e);
    }
  }

  // tokens may appear in hash or query; accept either
  const access_token = hashParams.get('access_token') || searchParams.get('access_token') || null;
  const refresh_token = hashParams.get('refresh_token') || searchParams.get('refresh_token') || null;
  // require both tokens (safe check)
  const hasTokens = !!(access_token && refresh_token);

  // detect error param (e.g. #error=... & error_description=...)
  const error = hashParams.get('error') || searchParams.get('error') || null;
  const error_description = hashParams.get('error_description') || searchParams.get('error_description') || null;

  const parentOrigin = searchParams.get('parent_origin') || null;
  const nextParam = searchParams.get('next') || null;

  // show debug data (optional: keep in dev only)
  const debugEl = document.getElementById('debug');
  if (debugEl) {
    debugEl.style.display = 'block';
    debugEl.textContent = [
      'href: ' + location.href,
      'search: ' + location.search,
      'hash: ' + location.hash,
      'confirmation_url: ' + (confirmation_url || '—'),
      'access_token: ' + (access_token ? 'present' : 'absent'),
      'refresh_token: ' + (refresh_token ? 'present' : 'absent'),
      'error: ' + (error || '—'),
      'error_description: ' + (error_description || '—')
    ].join('\n');
  }

  function postToParent(msg) {
    try {
      const target = parentOrigin || '*';
      if (window.opener) window.opener.postMessage(msg, target);
      else if (window.parent && window.self !== window.parent) window.parent.postMessage(msg, target);
    } catch (e) { console.warn('[auth-email-landing] postToParent failed', e); }
  }

  // UI references
  const titleEl = document.getElementById('title');
  const subtitleEl = document.getElementById('subtitle');
  const btn = document.getElementById('verifyBtn');

  // If Supabase returned an error in the hash/query, show it clearly
  if (error) {
    console.warn('[auth-email-landing] Auth error detected', error, error_description);
    titleEl.textContent = 'Verification failed';
    subtitleEl.textContent = (error_description ? decodeURIComponent(error_description) : 'Verification failed or link expired.');
    btn.textContent = 'Request a new magic link';
    btn.onclick = () => { window.location.href = 'https://tharaga.co.in/login_signup_glassdrop'; };
    // notify opener/parent that verification failed
    postToParent({ type: 'tharaga_verify_failed', error, error_description });
    // stop further processing
    console.log('[auth-email-landing] stopped due to error in URL');
  } else if (confirmation_url) {
    // If confirmation_url present — always redirect to it (auto + button fallback)
    console.log('[auth-email-landing] confirmation_url detected ->', confirmation_url);
    titleEl.textContent = 'Confirming your email…';
    subtitleEl.textContent = 'Redirecting to complete verification — if nothing happens, click the button.';
    btn.textContent = 'Verify & Continue';
    btn.onclick = () => { window.location.href = confirmation_url; };
    // allow short pause for user to see UI, then navigate
    setTimeout(() => { window.location.href = confirmation_url; }, 250);
  } else if (hasTokens) {
    // If tokens already present in this tab (Supabase redirected back with tokens)
    console.log('[auth-email-landing] tokens found in URL', { access_token: !!access_token, refresh_token: !!refresh_token });
    const isPopupOrIframe = !!window.opener || (window.parent && window.self !== window.parent);

    if (isPopupOrIframe) {
      postToParent({
        type: 'tharaga_token_transfer',
        access_token, refresh_token,
        next: nextParam || null
      });
      titleEl.textContent = '✅ Verified — returning...';
      subtitleEl.textContent = 'If this tab does not close automatically, you can close it.';
      btn.textContent = 'Close';
      btn.onclick = () => { try { window.close(); } catch(_) { /* ignore */ } };
      setTimeout(() => { try { window.close(); } catch(_) {} }, 700);
    } else {
      // standalone: build a hash if tokens were in query
      const finalHash = (location.hash.replace(/^#/, '') || new URLSearchParams({ access_token, refresh_token }).toString());
      const redirectTo = `/login_signup_glassdrop/?post_auth=1#${finalHash}`;
      console.log('[auth-email-landing] redirecting standalone to', redirectTo);
      titleEl.textContent = 'Redirecting you back to the app…';
      subtitleEl.textContent = 'If nothing happens, click the button.';
      btn.textContent = 'Continue';
      btn.onclick = () => { location.href = redirectTo; };
      setTimeout(() => { location.href = redirectTo; }, 250);
    }
  } else {
    // Nothing found — show clearer diagnostic instructions
    console.warn('[auth-email-landing] no confirmation_url and no tokens found');
    titleEl.textContent = 'No confirmation link found';
    subtitleEl.textContent = 'The link appears invalid or expired. Open the magic link in your browser (not Gmail preview) or request a new link.';
    btn.textContent = 'Open inbox / Request a new link';
    btn.onclick = () => { window.location.href = 'https://tharaga.co.in/login_signup_glassdrop'; };
    // Post failure to parent if any (so popup parent can show a message)
    postToParent({ type: 'tharaga_verify_missing', href: location.href });
  }
</script>

</body>
</html>
