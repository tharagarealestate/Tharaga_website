<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Signing you in…</title>
  <style>
    body{font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .box{max-width:560px;padding:24px;text-align:center}
  </style>
  <script>
    // Prevent embedding
    if (window.top !== window.self) {
      try { window.top.location = window.location.href; } catch(_) {}
    }
  </script>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
</head>
<body>
  <div class="box">
    <h2 id="status">Finalizing sign-in…</h2>
    <p id="detail" style="opacity:.8"></p>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // If your repo already initializes a global supabase client, replace these lines:
    const SUPABASE_URL = "https://wedevtjjmdvngyshqdro.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M";
    const supabase = (window.supabase) || createClient(SUPABASE_URL, SUPABASE_ANON, {auth: {persistSession: true}});

    const statusEl = document.getElementById('status');
    const detailEl = document.getElementById('detail');

    const qp = new URLSearchParams(location.search);
    const next = qp.get('next') || '/';

    function finish(message){
      statusEl.textContent = message;
      // always set a localStorage ping for other tabs to pick up
      try { localStorage.setItem('__tharaga_magic_confirmed', Date.now().toString()); } catch(e){}
      // notify opener (if this tab/window was opened by the app)
      try {
        if (window.opener && !window.opener.closed) {
          window.opener.postMessage({ type: 'THARAGA_AUTH_SUCCESS', next }, location.origin);
        }
      } catch(e){}
      // try to close (works if email opened the link in a window opened by the app); otherwise redirect
      setTimeout(() => {
        try { window.close(); } catch(e){ /* ignore */ }
        location.replace(next);
      }, 700);
    }

    function fail(message, redirectToLogin = true){
      statusEl.textContent = 'Sign in failed';
      detailEl.textContent = message || 'The magic link is invalid or expired.';
      // set an error marker so UI can react
      try { localStorage.setItem('__tharaga_magic_error', JSON.stringify({ts:Date.now(), msg: message||''})); } catch(e){}
      setTimeout(() => {
        if (redirectToLogin) location.replace('/');
      }, 2500);
    }

    (async () => {
      try {
        // 1) Preferred: use helper that consumes the URL (if present in this SDK)
        if (typeof supabase.auth.getSessionFromUrl === 'function') {
          await supabase.auth.getSessionFromUrl({ storeSession: true });
          finish('You are logged in — returning you now.');
          return;
        }

        // 2) If URL contains ?code= (PKCE / OAuth), exchange the code for a session
        const code = qp.get('code');
        if (code) {
          const { data, error } = await supabase.auth.exchangeCodeForSession(code);
          if (error) throw error;
          finish('You are logged in — returning you now.');
          return;
        }

        // 3) Fallback: parse hash fragment that contains access_token & refresh_token
        if (location.hash && location.hash.includes('access_token')) {
          const hashParams = new URLSearchParams(location.hash.replace(/^#/, '?'));
          const access_token = hashParams.get('access_token');
          const refresh_token = hashParams.get('refresh_token');
          if (access_token && refresh_token) {
            const { data, error } = await supabase.auth.setSession({
              access_token,
              refresh_token
            });
            if (error) throw error;
            finish('You are logged in — returning you now.');
            return;
          }
        }

        // If no tokens found
        fail('No auth token found in the URL. Please try again from the app login.');
      } catch (err) {
        console.error('Auth callback error', err);
        fail(err?.message || 'Unknown error while finalizing login.');
      }
    })();
  </script>
</body>
</html>
