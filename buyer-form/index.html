<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tharaga — Verified Buyer Match</title>
  <link rel="stylesheet" href="./style.css">
  <script type="module" src="/js/fragment-handle.js"></script>
  <script src="/js/supabase-init.js" defer></script>
</head>
<body>

<!-- ===== Verified Buyer Form (Drop-in) ===== -->
<section id="buyer-intake" style="max-width: 760px; margin: 0 auto; padding: 24px;">
  <h3 style="font-family: 'Poppins', sans-serif; font-weight: 600; text-align:center; margin-bottom: 12px;">
    Get Matched to Verified Properties
  </h3>
  <p style="text-align:center; margin:0 0 16px;">OTP-verified leads only. No spam. No brokerage.</p>

  <!-- Netlify Forms attrs -->
  <form name="buyer-intake"
        method="POST"
        data-netlify="true"
        netlify-honeypot="bot-field"
        data-netlify-recaptcha="true"
        id="buyerForm"
        style="background:#FAF5EF; border-radius:12px; padding:16px; font-family:'Poppins',sans-serif">

    <!-- Netlify Forms hidden helpers -->
    <input type="hidden" name="form-name" value="buyer-intake" />
    <p style="display:none;">
      <label>Don’t fill this out if you’re human: <input name="bot-field" /></label>
    </p>

    <!-- UTM + referrer capture -->
    <input type="hidden" name="utm_source" id="utm_source">
    <input type="hidden" name="utm_medium" id="utm_medium">
    <input type="hidden" name="utm_campaign" id="utm_campaign">
    <input type="hidden" name="referrer"     id="referrer">
    <input type="hidden" name="otp_verified" id="otp_verified" value="false">

    <div class="grid-2">
      <label style="display:block;">
        <span>Name</span>
        <input required type="text" name="name" placeholder="Your full name"
               style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
      </label>

      <label style="display:block;">
        <span>Email</span>
        <input required type="email" name="email" placeholder="you@example.com"
               style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
      </label>
    </div>

    <div class="grid-2 grid-right-btn">
      <label style="display:block;">
        <span>Phone (India)</span>
        <input required type="tel" name="phone" id="phone"
          inputmode="numeric"
          pattern="^[6-9][0-9]{9}$"
          title="Enter a 10-digit Indian mobile number starting with 6–9"
          placeholder="10-digit mobile number"

          style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
      </label>

      <style>
        .otp-input {
          width: 40px;
          height: 50px;
          font-size: 20px;
          text-align: center;
          border: 2px solid #ccc;
          border-radius: 8px;
        }
        .otp-input:focus {
          border-color: #0e0e0e;
          outline: none;
        }
      </style>


      <button type="button" id="sendOtpBtn"
        style="padding:10px; border:none; border-radius:8px; background:#0e0e0e; color:#fff; cursor:pointer;">
        Send OTP
      </button>

    </div>

    <div id="otpBlock" style="display:none; margin-top:12px; text-align:center;">
      <div class="otp-container" style="display:flex; gap:8px; justify-content:center; margin-bottom:12px;">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 1">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 2">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 3">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 4">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 5">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 6">
      </div>
      <button type="button" id="verifyOtpBtn"
              style="padding:10px 20px; border:none; border-radius:8px; background:#0e0e0e; color:#fff; cursor:pointer;">
        Verify OTP
      </button>
      <small id="otpStatus" style="display:block; margin-top:6px;"></small>
    </div>

    <!-- Buyer profiling -->
    <div class="grid-2">
      <label style="display:block;">
        <span>Preferred City / Area</span>
        <input required type="text" name="location" placeholder="e.g., Anna Nagar, OMR, Coimbatore"
               style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
      </label>

      <label style="display:block;">
        <span>Budget</span>
        <select required name="budget"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
          <option value="">Select</option>
          <option>₹50L – ₹1Cr</option>
          <option>₹1Cr – ₹2Cr</option>
          <option>₹2Cr – ₹3Cr</option>
          <option>₹3Cr+</option>
        </select>
      </label>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
      <label style="display:block;">
        <span>Property Type</span>
        <select required name="property_type"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
          <option value="">Select</option>
          <option>Apartment</option>
          <option>Villa</option>
          <option>Plot</option>
          <option>Commercial</option>
        </select>
      </label>

      <label style="display:block;">
        <span>Buying Timeline</span>
        <select required name="timeline"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
          <option value="">Select</option>
          <option>ASAP (0–30 days)</option>
          <option>1–3 months</option>
          <option>3–6 months</option>
          <option>Just researching</option>
        </select>
      </label>
    </div>

    <label style="display:block; margin-top:12px;">
      <span>Financing</span>
      <select required name="financing"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
        <option value="">Select</option>
        <option>Loan pre-approved</option>
        <option>Loan required</option>
        <option>Self-funded</option>
      </select>
    </label>

    <label style="display:block; margin-top:12px;">
      <span>Anything else?</span>
      <textarea name="notes" rows="3" placeholder="Bedrooms, amenities, exact localities..."
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"></textarea>
    </label>

    <!-- Your existing Google reCAPTCHA v2/v3 widget works with Netlify Forms 
    <div data-netlify-recaptcha="true" style="margin-top:12px;"></div>-->

    <button id="submitBtn" type="submit" disabled
            style="margin-top:14px; width:100%; padding:12px; border:none; border-radius:10px; background:#0e0e0e; color:#fff; font-weight:600; cursor:not-allowed;">
      Get My Property Matches
    </button>

    <small style="display:block; margin-top:8px; opacity:0.8;">
      By submitting, you agree to be contacted by Tharaga. OTP verification is required to prevent spam.
    </small>
  </form>

  <!-- Invisible reCAPTCHA mount -->
  <div id="otp-recaptcha" style="height:0;"></div>

  <!-- Matches will render here -->
  <div id="aiMatches" style="margin-top:20px;"></div>
</section>

<!-- Firebase SDK (for OTP) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  // ——— Firebase config (keep as-is) ———
  const firebaseConfig = {
    apiKey: "AIzaSyAUNl5bZif51a8b5FC5kKqZs40KlP5lP74",
    authDomain: "tharaga-n.firebaseapp.com",
    projectId: "tharaga-n",
    appId: "1:122537471507:web:346c29119a352cc87059e6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  auth.languageCode = 'en';

  // UTM + referrer capture
  const params = new URLSearchParams(window.location.search);
  document.getElementById('utm_source').value   = params.get('utm_source')   || '';
  document.getElementById('utm_medium').value   = params.get('utm_medium')   || '';
  document.getElementById('utm_campaign').value = params.get('utm_campaign') || '';
  document.getElementById('referrer').value     = document.referrer || '';

  // Elements
  const form              = document.getElementById('buyerForm');
  const phoneInput        = document.getElementById('phone');
  const sendOtpBtn        = document.getElementById('sendOtpBtn');
  const otpBlock          = document.getElementById('otpBlock');
  const verifyOtpBtn      = document.getElementById('verifyOtpBtn');
  const otpStatus         = document.getElementById('otpStatus');
  const submitBtn         = document.getElementById('submitBtn');
  const otpVerifiedField  = document.getElementById('otp_verified');
  const otpInputs         = document.querySelectorAll('.otp-input');

  // reCAPTCHA (lazy init — do NOT call at top-level)
let recaptchaVerifier = null;
async function getRecaptcha() {
  if (!recaptchaVerifier) {
    recaptchaVerifier = new RecaptchaVerifier('otp-recaptcha', { size: 'invisible' }, auth);
    await recaptchaVerifier.render();
  }
  return recaptchaVerifier;
}

  // OTP helpers
  const getEnteredOTP = () => Array.from(otpInputs).map(i => i.value).join('');
  otpInputs.forEach((input, i) => {
    input.addEventListener('input', () => {
      input.value = input.value.replace(/\D/g,'').slice(0,1);
      if (input.value && i < otpInputs.length - 1) otpInputs[i+1].focus();
    });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !input.value && i > 0) otpInputs[i-1].focus();
      if (e.key === 'ArrowLeft'  && i > 0) otpInputs[i-1].focus();
      if (e.key === 'ArrowRight' && i < otpInputs.length-1) otpInputs[i+1].focus();
    });
  });
  otpInputs[0].addEventListener('paste', (e) => {
    const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'').slice(0,6);
    text.split('').forEach((d, idx) => { if (otpInputs[idx]) otpInputs[idx].value = d; });
    e.preventDefault();
    if (text.length === 6) otpInputs[5].focus();
  });

  let confirmationResult = null;

  // Send OTP
  sendOtpBtn.addEventListener('click', async () => {
  const raw = phoneInput.value.trim();
  if (!/^[6-9]\d{9}$/.test(raw)) { alert('Enter a valid 10-digit Indian mobile number.'); return; }

  otpBlock.style.display = 'block';
  otpStatus.textContent = 'Sending OTP…';
  sendOtpBtn.disabled = true;

  try {
    const appVerifier = await getRecaptcha();
    const e164 = '+91' + raw;
    confirmationResult = await signInWithPhoneNumber(auth, e164, appVerifier);
    otpStatus.textContent = 'OTP sent. Please check your SMS.';
  } catch (err) {
  console.error('send OTP error:', err);
  if (err.code === 'auth/too-many-requests') {
    otpStatus.textContent = 'Too many attempts. Please wait a few minutes before retrying.';
  } else if (err.code === 'auth/operation-not-allowed') {
    otpStatus.textContent = 'Phone sign-in is not enabled in Firebase.';
  } else {
    otpStatus.textContent = 'Could not send OTP. Please try again.';
  }
  if (recaptchaVerifier) {
    try {
      const wid = await recaptchaVerifier.render();
      if (window.grecaptcha && wid) window.grecaptcha.reset(wid);
    } catch (_) {}
  }
} finally {
    sendOtpBtn.disabled = false;
  }
});


  // Verify OTP
  verifyOtpBtn.addEventListener('click', async () => {
    try {
      const code = getEnteredOTP();
      if (code.length !== 6) { otpStatus.textContent = 'Please enter all 6 digits.'; return; }
      if (!confirmationResult) { otpStatus.textContent = 'Please click “Send OTP” first.'; return; }
      await confirmationResult.confirm(code);
      otpStatus.textContent = 'Verified ✅';
      otpVerifiedField.value = 'true';
      submitBtn.disabled = false;
      submitBtn.style.cursor = 'pointer';
    } catch (err) {
      console.error('verify error:', err);
      otpStatus.textContent = 'Invalid code. Please try again.';
    }
  });
</script>

<!-- Supabase + Transformers (browser) + Match + Render -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  import { pipeline }     from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.1/dist/transformers.min.js";

  const embedder = await pipeline(
  "feature-extraction",
  "Xenova/e5-small-v2"
);

  // ——— Paste your Supabase anon config (browser-safe) ———
  const SUPABASE_URL = "https://wedevtjjmdvngyshqdro.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.supabase = supabase;

  // Reuse the same model as ingestion
  const MODEL_ID = 'Xenova/e5-small-v2';
  let extractorPromise = null;
  function getExtractor() {
    if (!extractorPromise) {
      extractorPromise = pipeline('feature-extraction', MODEL_ID, { quantized: true });
    }
    return extractorPromise;
  }
  const mkQuery = (q) => `query: ${q}`;
  const toVectorText = (arr) => `[${arr.map(x => Number(x).toFixed(6)).join(',')}]`;

  // Simple budget → min/max hints (optional)
  function parseBudgetRange(label) {
    if (label.includes('₹50L')) return { min: 5_000_000, max: 10_000_000 };
    if (label.includes('₹1Cr') && label.includes('₹2Cr')) return { min: 10_000_000, max: 20_000_000 };
    if (label.includes('₹2Cr') && label.includes('₹3Cr')) return { min: 20_000_000, max: 30_000_000 };
    if (label.includes('₹3Cr+')) return { min: 30_000_000, max: null };
    return { min: null, max: null };
  }

  const matchForm = document.getElementById('buyerForm');
  const matchSubmitBtn = document.getElementById('submitBtn');
  const matchOtpVerified = document.getElementById('otp_verified');

    // Restore pending form values (if user returned after sign-in)
  (function restorePendingForm(){
    try {
      const saved = sessionStorage.getItem('tharaga_pending_buyer_form');
      if (!saved) return;
      const obj = JSON.parse(saved);
      Object.keys(obj).forEach(k => {
        // prefer matchForm.elements[k] (works for inputs/selects/textareas)
        const el = matchForm.elements[k];
        if (el) {
          try { el.value = obj[k]; } catch (_) {}
        } else {
          // fallback: any element with matching name
          const els = matchForm.querySelectorAll(`[name="${k}"]`);
          if (els && els.length) els.forEach(e => { try { e.value = obj[k]; } catch(_){} });
        }
      });
      // gentle UX hint
      setTimeout(()=> {
        try {
          matchForm.scrollIntoView({behavior:'smooth', block:'center'});
          // small inline hint (non-destructive)
          const hint = document.createElement('div');
          hint.style.cssText = 'text-align:center;margin:10px 0;color:#666;font-size:13px';
          hint.textContent = 'You returned after signing in. Click "Get My Property Matches" to continue.';
          matchForm.insertBefore(hint, matchForm.firstChild);
        } catch(_){}
      }, 350);
    } catch (e) { console.warn('restore pending form failed', e); }
  })();

  // If another tab/modal signals successful auth, reload this page (so supabase session attaches)
  window.addEventListener('storage', (e) => {
    if (!e?.key) return;
    if (e.key === '__tharaga_magic_continue' || e.key === '__tharaga_magic_confirmed') {
      if (sessionStorage.getItem('tharaga_pending_buyer_form')) {
        console.debug('Detected auth completion in another tab. Reloading to pick up new session.');
        setTimeout(()=> location.reload(), 300);
      } 
      try {
      const payload = JSON.parse(localStorage.getItem('__tharaga_magic_continue') || 'null');
      if (payload?.user?.email) {
        const hint = document.createElement('div');
        hint.style.cssText = "margin:10px 0;color:#333;font-size:14px;font-weight:500;text-align:center";
        hint.textContent = `Signed in as ${payload.user.email}`;
        document.querySelector("#buyer-intake")?.prepend(hint);
      }
    } catch (err) {
      console.warn("storage handler parse error", err);
    }
  }
});


 // Submit: embed → RPC → render
  matchForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  // Check session
  const currentUser = await ensureSupabaseSession?.() || (await window.supabase?.auth.getSession()).data?.session?.user || null;
  if (!currentUser) {
    // persist current form to restore after auth
    try {
      const f = new FormData(matchForm);
      const obj = Object.fromEntries(f.entries());
      sessionStorage.setItem('tharaga_pending_buyer_form', JSON.stringify(obj));
      sessionStorage.setItem('tharaga_pending_form_ts', String(Date.now()));
    } catch (_) {}

    alert('Please sign in first.');

    if (window.authGate?.openLoginModal) {
      window.authGate.openLoginModal({ next: location.pathname + location.search });
    }
    return;
  }

  if (matchOtpVerified.value !== 'true') {
    alert('Please verify OTP first.');
    return;
  }

  matchSubmitBtn.disabled = true;
  matchSubmitBtn.textContent = 'Finding matches…';

  try {
    const f = new FormData(matchForm);
    const payload = Object.fromEntries(f.entries());

    // 1) Build the query text
    const qtext = [
      payload.location || '',
      payload.property_type || '',
      payload.budget || '',
      (payload.notes || '')
    ].filter(Boolean).join(' ').trim();

    // 2) Create embedding in browser
    const extractor = await getExtractor();
    const reps = await extractor([mkQuery(qtext)], { pooling: 'mean', normalize: true });
    const vec = reps.tolist()[0];
    if (!vec || vec.length !== 384) throw new Error(`Bad vector dim: ${vec?.length}`);
    const q_vec_text = toVectorText(vec);

    // 3) Optional: store buyer (skip if table doesn't exist or RLS prevents)
    try {
      await supabase.from('buyers').insert([{
        name: payload.name,
        email: payload.email,
        phone: payload.phone,
        location: payload.location,
        budget: payload.budget,
        property_type: payload.property_type,
        timeline: payload.timeline,
        financing: payload.financing,
        notes: payload.notes || '',
        utm_source: payload.utm_source || '',
        utm_medium: payload.utm_medium || '',
        utm_campaign: payload.utm_campaign || '',
        referrer: payload.referrer || '',
        otp_verified: true
      }]);
    } catch (err) {
      console.error(err);
      alert('Matching failed: ' + (err?.message || err));
    }

    // 4) Derive RPC filters
    const { min: _budget_min, max: _budget_max } = parseBudgetRange(payload.budget || '');
    const _city  = payload.location?.split(',')[0]?.trim() || null;
    const _ptype = payload.property_type || null;

    // 5) Call hybrid RPC (vector text signature)
    const { data, error } = await supabase.rpc('match_candidates_hybrid', {
      q_vec_text,
      _city,
      _ptype,
      _budget_min,
      _budget_max,
      _bedrooms_min: null,
      _bathrooms_min: null,
      _verified_only: false,
      _want_metro: true,
      _k: 20
    });

    if (error) throw error;

    // 6) Store compact matches in sessionStorage (reduce size; keep only fields we need)
    const minimal = (data || []).map(r => ({
      id: r.id,
      title: r.title || r.name || 'Property',
      image: (r.images && r.images[0]) || r.image || null,
      city: r.city || null,
      locality: r.locality || null,
      price_inr: r.price_inr == null ? null : Number(r.price_inr),
      bedrooms: r.bedrooms ?? null,
      bathrooms: r.bathrooms ?? null,
      sem_sim: r.sem_sim ?? r.similarity ?? r.score ?? 0,
      nearest_metro: r.nearest_metro ?? null,
      km_to_metro: r.km_to_metro ?? null
    }));

    // Store search meta too
    const meta = {
      search: {
        location: payload.location || '',
        property_type: payload.property_type || '',
        budget: payload.budget || ''
      },
      created_at: Date.now()
    };

    // Try to save into sessionStorage (works only if both pages share origin)
    try {
      sessionStorage.setItem('tharaga_matches_v1', JSON.stringify({ meta, results: minimal }));
    } catch (e) {
      console.warn('Could not save matches to sessionStorage (size?):', e);
      // fallback: render minimal matches on this page
      return renderMatches(data || []);
    }

    // Build query params (lightweight filters) and redirect to listing page
    const params = new URLSearchParams({
      location: payload.location || '',
      property_type: payload.property_type || '',
      budget: payload.budget || ''
    });

    try {
      sessionStorage.removeItem('tharaga_pending_buyer_form');
      sessionStorage.removeItem('tharaga_pending_form_ts');
    } catch(_) {}

    window.location.href = 'https://tharaga.co.in/verified-property-listings?' + params.toString();

  } catch (err) {
    console.error(err);
    alert('Matching failed: ' + (err?.message || err));
  } finally {
    // Re-enable button (this runs even though we redirected — harmless)
    matchSubmitBtn.disabled = false;
    matchSubmitBtn.textContent = 'Get My Property Matches';
  }
}); // ✅ now properly closed

// ---------- end replacement ----------


  function renderMatches(rows) {
    const container = document.getElementById('aiMatches');
    container.innerHTML = `<h4 style="text-align:center; margin-bottom:12px;">Your AI Matched Properties</h4>`;
    if (!rows.length) {
      container.innerHTML += `<p style="text-align:center;">No matches yet. Try broadening filters.</p>`;
      return;
    }
    rows.forEach(r => {
      const card = document.createElement('div');
      card.className = 'match-card';
      const loc = [r.city, r.locality].filter(Boolean).join(', ');
      const price = r.price_inr != null ? `₹${r.price_inr}` : '₹N/A';
      const bb = [r.bedrooms && `${r.bedrooms} BR`, r.bathrooms && `${r.bathrooms} BA`].filter(Boolean).join(' · ');
      const metro = r.nearest_metro ? ` • 🚇 ${r.nearest_metro} (${(r.km_to_metro ?? 0).toFixed(1)} km)` : '';
      card.innerHTML = `
        <h5>${r.title || 'Property'}</h5>
        <p>${loc || ''}</p>
        <p>${price} ${bb ? ' • ' + bb : ''}${metro}</p>
        <small>Similarity: ${Number(r.sem_sim).toFixed(3)}</small>
      `;
      container.appendChild(card);
    });
  }
</script>
<script src="/login_signup_glassdrop/auth-gate.js" defer></script>
 


<!-- Attach gate to submitBtn -->
<script type="module">
let currentUser = null;
const supabaseClient = window.supabase;

async function ensureSupabaseSession() {
  try {
    const client = window.supabase;
    if (!client) return null;

    const sessRes = await client.auth.getSession();
    const sess = sessRes?.data?.session;
    if (sess?.user) return sess.user;

    // no session yet — check for confirmation_url / code in the URL
    const urlParams = new URLSearchParams(window.location.search);
    const confUrl = urlParams.get("confirmation_url") || urlParams.get("access_token") || urlParams.get("code");
    if (confUrl) {
      console.log('ensureSupabaseSession: found conf param:', confUrl);
      try {
        let res = await client.auth.exchangeCodeForSession(confUrl).catch(e => ({ error: e }));
        console.log('exchange (as-is) result:', res);
        if ((res.error || !res.data?.session) && confUrl) {
          let parsed;
          try {
            const u = new URL(confUrl);
            parsed = u.searchParams.get('code') || u.searchParams.get('access_token') || confUrl;
          } catch (_) {
            const m = confUrl.match(/code=([^&]+)/);
            parsed = m ? decodeURIComponent(m[1]) : confUrl;
          }
          if (parsed && parsed !== confUrl) {
            res = await client.auth.exchangeCodeForSession(parsed).catch(e => ({ error: e }));
            console.log('exchange (parsed) result:', res);
          }
        }

        if (!res.error && res.data?.session?.user) {
          const user = res.data.session.user;
          window.history.replaceState({}, document.title, window.location.pathname + window.location.search.replace(/(&|\?)confirmation_url=[^&]+/, ''));
          console.log('ensureSupabaseSession: exchange success for', user.email);
          return user;
        } else {
          console.warn('ensureSupabaseSession: exchange did not create session', res?.error || res);
        }
      } catch (err) {
        console.error('ensureSupabaseSession: exchangeCodeForSession failed', err);
      }
    }

  } catch (e) {
    console.error('ensureSupabaseSession top-level error', e);
  }
  return null;
}
// pick up the popup's postMessage if it sends one
window.addEventListener('message', (ev) => {
  try {
    if (!ev?.data) return;
    if (ev.data.type === 'tharaga_verify_clicked') {
      console.log('Received auth postMessage:', ev.data);
      // write to localStorage so the storage handler also triggers (and for parity)
      try {
        localStorage.setItem('__tharaga_magic_continue', JSON.stringify(ev.data));
      } catch (e) { console.warn('Could not write __tharaga_magic_continue', e); }
      // optionally reload to pick up new session
      setTimeout(()=> location.reload(), 250);
    }
  } catch (e) { console.warn('message handler error', e); }
});


document.addEventListener("DOMContentLoaded", async () => {
  const gateForm = document.getElementById('buyerForm');
  const gateSubmitBtn = document.getElementById('submitBtn');
  const gateOtpVerified = document.getElementById('otp_verified');

  gateSubmitBtn.addEventListener('click', () => {
    const f = new FormData(gateForm);
    const obj = Object.fromEntries(f.entries());
    sessionStorage.setItem('tharaga_pending_buyer_form', JSON.stringify(obj));
    sessionStorage.setItem('tharaga_pending_form_ts', String(Date.now()));
  }, true);

  if (window.authGate) {
    window.authGate.attachAuthGate("#submitBtn", async () => {
      // Restore pending form
      const saved = sessionStorage.getItem('tharaga_pending_buyer_form');
      if (saved) {
        const obj = JSON.parse(saved);
        Object.keys(obj).forEach(k => {
          const el = gateForm.elements[k];
          if (el && k !== 'otp_verified') el.value = obj[k];
        });
      }

      // Step 3: enable submit if OTP verified and user logged in
      const user = await ensureSupabaseSession();
      gateSubmitBtn.disabled = !(gateOtpVerified.value === 'true' && user);
      gateSubmitBtn.style.cursor = gateSubmitBtn.disabled ? 'not-allowed' : 'pointer';

      // Step 4: show signed-in email
      if (user?.email) {
        const hint = document.createElement('div');
        hint.style.cssText = "margin:10px 0;color:#333;font-size:14px;font-weight:500;text-align:center";
        hint.textContent = `Signed in as ${user.email}`;
        document.querySelector("#buyer-intake")?.prepend(hint);
      }
    });
  } else {
    console.error("authGate not loaded");
  }
});
</script>


</body>
</html>