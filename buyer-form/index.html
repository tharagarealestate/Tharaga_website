<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tharaga — Verified Buyer Match</title>
  <link rel="stylesheet" href="./style.css">
  <script type="module" src="/js/fragment-handle.js"></script>
  <!-- Auth header/modal: use the durable snippet so CTA can open the global login container -->
  <!-- Ensure auth-gate is available so fallbacks can open the login modal if header is missing -->
  <script src="https://auth.tharaga.co.in/login_signup_glassdrop/auth-gate.js" defer></script>
  
  <!-- Inline auth removed; using durable-auth-head.html -->
  <!-- <script>
// Durable top-right authentication header and modal (Supabase-based)
// Works standalone when pasted into Durable Head Code
(function(){
  if (window.__thgAuthInstalledV1) return; window.__thgAuthInstalledV1 = true;

  const AUTH_NAV = Object.assign({ profile: '/profile', dashboard: '/dashboard', settings: null }, window.AUTH_NAV || {});
  const Z_BASE = 2147483000;

  window.authGate = window.authGate || {};
  window.authGate.openLoginModal = function(opts){ (window.__thgOpenAuthModal || function(){ alert('Auth not ready'); })(opts||{}); };

  function ready(fn){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn,{once:true});} else { fn(); } }
  function headerRoot(){ return document.querySelector('header, [role="banner"], [data-section="header"], .site-header, .Header, nav') || null; }
  function hideLegacyAuthLinks(root){ (root||document).querySelectorAll('a[href="#login"], a[href="#signup"], [data-auth-open]').forEach(function(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }); }
  function clamp(str, max){ if (!str) return ''; return str.length>max ? str.slice(0,max-1)+'…' : str; }
  function getInitials(user){
    const meta = user?.user_metadata || {};
    const full = (meta.full_name || meta.name || '').trim();
    if (full) {
      const parts = full.split(/\s+/).filter(Boolean);
      const first = parts[0]?.[0] || '';
      const last = parts.length>1 ? parts[parts.length-1][0] : '';
      return (first+last || first || '').toUpperCase() || 'U';
    }
    const email = (user?.email || '').trim();
    return email ? email[0].toUpperCase() : 'U';
  }
  function getDisplayName(user){
    const meta = user?.user_metadata || {};
    const name = (meta.full_name || meta.name || meta.username || '').trim();
    return name || (user?.email || 'My Account');
  }
  function createEl(tag, cls, attrs){ const el = document.createElement(tag); if (cls) el.className = cls; if (attrs) for (var k in attrs) el.setAttribute(k, attrs[k]); return el; }
  function validateEmail(val){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val); }
  function ensureContainer(){
    let hdr = headerRoot();
    let wrap = document.querySelector('.thg-auth-wrap');
    if (!wrap){
      wrap = document.createElement('div');
      wrap.className = 'thg-auth-wrap';
      let parent = hdr || document.body;
      if (hdr) { const cs = getComputedStyle(hdr); if (cs.position === 'static') { hdr.style.position = 'relative'; } parent.appendChild(wrap); }
      else { wrap.classList.add('is-fixed'); parent.appendChild(wrap); }
    }
    return wrap;
  }

  function injectStyles(){
    if (document.getElementById('thg-auth-styles')) return;
    const css = `
.thg-auth-wrap{ position:absolute; top:14px; right:16px; display:flex; align-items:center; z-index:${Z_BASE}; }
@media (min-width:1024px){ .thg-auth-wrap{ top:16px; right:24px; } }
.thg-auth-wrap.is-fixed{ position:fixed; top:14px; right:16px; }
.thg-auth-btn{ appearance:none;background:transparent;color:#fff;border:1px solid rgba(255,255,255,.9); border-radius:9999px;padding:8px 14px;font-weight:600;cursor:pointer;line-height:1;white-space:nowrap;display:inline-flex;align-items:center;gap:8px; transition:background .15s ease, border-color .15s ease, box-shadow .15s ease; }
.thg-auth-btn:hover{background:rgba(255,255,255,.08)}
.thg-auth-btn:focus-visible{ outline:2px solid #7dd3fc; outline-offset:2px; }
.thg-auth-btn .thg-initial{ width:22px;height:22px;border-radius:9999px;background:#fff;color:#111;display:none;align-items:center;justify-content:center;font-weight:700;font-size:11px; }
.thg-auth-btn.is-auth .thg-initial{ display:inline-flex; }
.thg-auth-btn.is-auth::after{ content:""; display:inline-block; width:0; height:0; border-left:5px solid transparent; border-right:5px solid transparent; border-top:6px solid rgba(255,255,255,.9); transition:transform .15s ease; transform-origin:center; }
.thg-auth-btn[aria-expanded="true"].is-auth::after{ transform:rotate(180deg); }
.thg-spinner{ width:14px;height:14px;border-radius:9999px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff; animation:thgspin .8s linear infinite; }
@keyframes thgspin{ to{ transform:rotate(360deg); } }
.thg-auth-menu{ position:absolute;top:calc(100% + 10px);right:0;min-width:280px;background:#0b0b0b;color:#fff; border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;box-shadow:0 12px 30px rgba(0,0,0,.45); visibility:hidden; opacity:0; transform:translateY(-6px) scale(.98); transform-origin:top right; pointer-events:none; transition:opacity .16s ease, transform .16s ease, visibility 0s linear .16s; z-index:${Z_BASE+1}; }
.thg-auth-menu[aria-hidden="false"]{ visibility:visible; opacity:1; transform:translateY(0) scale(1); pointer-events:auto; transition:opacity .16s ease, transform .16s ease, visibility 0s linear 0s; }
.thg-auth-item{ display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;text-decoration:none;color:#fff;cursor:pointer; }
.thg-auth-item:hover{background:rgba(255,255,255,.08)}
.thg-auth-item[tabindex]{outline:none}
.thg-auth-item.is-header{ cursor:default;font-weight:700;opacity:.95; }
.thg-auth-item.is-header:hover{background:transparent}
.thg-auth-sep{ height:1px;background:rgba(255,255,255,.12);margin:6px 8px;border-radius:1px; }
.thg-initial-lg{ width:28px;height:28px;border-radius:9999px;background:#fff;color:#111;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:12px; }
.thg-name-wrap{ display:flex; flex-direction:column; min-width:0; }
.thg-name{ overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:190px; }
.thg-email{ opacity:.7; font-size:12px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap; max-width:200px; }
.thg-auth-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter:saturate(140%) blur(6px); display:flex; align-items:center; justify-content:center; z-index:${Z_BASE+2}; visibility:hidden; opacity:0; transition:opacity .18s ease, visibility 0s linear .18s; }
.thg-auth-overlay[aria-hidden="false"]{ visibility:visible; opacity:1; transition:opacity .18s ease, visibility 0s linear 0s; }
.thg-auth-modal{ width:100%; max-width:420px; background:linear-gradient(180deg, rgba(20,20,20,.98), rgba(12,12,12,.98)); color:#fff; border:1px solid rgba(255,255,255,.1); border-radius:16px; box-shadow:0 30px 60px rgba(0,0,0,.5); transform:translateY(10px) scale(.98); opacity:0; transition:transform .18s ease, opacity .18s ease; }
.thg-auth-overlay[aria-hidden="false"] .thg-auth-modal{ transform:translateY(0) scale(1); opacity:1; }
.thg-auth-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.08); }
.thg-auth-title{ font-weight:700; font-size:16px; }
.thg-auth-close{ appearance:none; background:linear-gradient(180deg,#d4af37,#b8860b,#8b6508); border:0; color:#111; cursor:pointer; font-weight:700; width:32px; height:32px; line-height:32px; border-radius:9999px; box-shadow:0 2px 6px rgba(0,0,0,.25); }
.thg-auth-close:hover{ color:#fff; background:linear-gradient(180deg,#b8860b,#8b6508,#5a3a02); transform:scale(1.06); }
.thg-auth-body{ padding:16px 18px 18px; }
.thg-tabs{ display:flex; gap:6px; background:rgba(255,255,255,.06); padding:4px; border-radius:9999px; margin-bottom:16px; }
.thg-tab{ flex:1; text-align:center; padding:8px 10px; border-radius:9999px; cursor:pointer; font-weight:600; color:#ddd; }
.thg-tab[aria-selected="true"]{ background:#fff; color:#111; }
.thg-field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
.thg-field label{ font-size:12px; opacity:.85; }
.thg-input{ appearance:none; background:#121212; color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px; }
.thg-input:focus{ outline:2px solid #7dd3fc; outline-offset:2px; }
.thg-actions{ display:flex; justify-content:space-between; align-items:center; margin:6px 0 12px; }
.thg-link{ background:none; border:0; color:#7dd3fc; cursor:pointer; font-size:13px; padding:0; }
.thg-btn-primary{ width:100%; appearance:none; background:#fff; color:#111; border:0; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer; transition:transform .06s ease, box-shadow .06s ease; box-shadow:0 2px 0 rgba(255,255,255,.25); }
.thg-btn-primary:active{ transform:translateY(1px); box-shadow:none; }
.thg-oauth{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
.thg-oauth-btn{ appearance:none; background:#0f0f0f; color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:12px 14px; cursor:pointer; font-weight:700; }
.thg-oauth-btn.google{ border-color:#333; background:#151515; }
.thg-error{ background:rgba(239,68,68,.12); color:#fecaca; border:1px solid rgba(239,68,68,.35); border-radius:10px; padding:10px 12px; font-size:13px; display:none; }
.thg-hint{ font-size:12px; opacity:.8; }
.thg-loading-bar{ height:2px; width:0; background:#7dd3fc; border-radius:2px; transition:width .2s ease; }
.thg-confirm{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:${Z_BASE+3}; background:rgba(0,0,0,.55); backdrop-filter:blur(3px); visibility:hidden; opacity:0; transition:opacity .16s ease, visibility 0s linear .16s; }
.thg-confirm[aria-hidden="false"]{ visibility:visible; opacity:1; transition:opacity .16s ease, visibility 0s linear 0s; }
.thg-confirm-card{ width:100%; max-width:360px; background:#141414; color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:16px; box-shadow:0 24px 50px rgba(0,0,0,.5); }
.thg-confirm-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
.thg-btn{ appearance:none; border-radius:10px; padding:8px 12px; cursor:pointer; border:1px solid rgba(255,255,255,.15); background:#0f0f0f; color:#fff; }
.thg-btn-danger{ background:#ef4444; border-color:#ef4444; color:#fff; }
@media (max-width:480px){ .thg-auth-wrap{ top:10px; right:10px; } .thg-auth-modal{ width:calc(100% - 16px); margin:0 8px; } .thg-auth-menu{ right:8px; } }
/* tagline styling */
.thg-tagline{ color:#9ca3af; font-size:13px; margin:-4px 0 12px; }
`;
    const style = document.createElement('style');
    style.id = 'thg-auth-styles';
    style.textContent = css;
    document.head.appendChild(style);
  }

  function createUI(){
    const wrap = ensureContainer();
    let btn = wrap.querySelector('.thg-auth-btn');
    if (!btn){
      btn = createEl('button', 'thg-auth-btn', { type:'button', 'aria-haspopup':'menu', 'aria-expanded':'false', 'aria-label':'Open account menu' });
      const avatar = createEl('span', 'thg-initial');
      avatar.textContent = 'U';
      const label = document.createElement('span');
      label.className = 'thg-label';
      const spinner = createEl('span','thg-spinner',{'aria-hidden':'true'});
      btn.appendChild(avatar); btn.appendChild(label); btn.appendChild(spinner);
      wrap.appendChild(btn);
    }

    let menu = wrap.querySelector('.thg-auth-menu');
    if (!menu){
      menu = createEl('div', 'thg-auth-menu', { id:'thg-auth-menu', role:'menu', 'aria-hidden':'true' });
      menu.innerHTML = '<div class="thg-auth-item is-header" aria-disabled="true">' +
        '<span class="thg-initial-lg">U</span>' +
        '<span class="thg-name-wrap">' +
        '<span class="thg-name">User</span>' +
        '<span class="thg-email">email@example.com</span>' +
        '</span>' +
        '</div>' +
        '<div class="thg-auth-sep"></div>' +
        '<div class="thg-auth-item" role="menuitem" tabindex="0" data-action="profile"><span>Profile</span></div>' +
        '<div class="thg-auth-item" role="menuitem" tabindex="0" data-action="dashboard"><span>Dashboard</span></div>' +
        (AUTH_NAV.settings ? '<div class="thg-auth-item" role="menuitem" tabindex="0" data-action="settings"><span>Settings</span></div>' : '') +
        '<div class="thg-auth-item" role="menuitem" tabindex="0" data-action="logout"><span>Logout</span></div>';
      wrap.appendChild(menu);
    }
    btn.setAttribute('aria-controls','thg-auth-menu');

    let overlay = document.querySelector('.thg-auth-overlay');
    if (!overlay){
      overlay = createEl('div','thg-auth-overlay',{'aria-hidden':'true','aria-modal':'true','role':'dialog'});
      overlay.innerHTML = `
        <div class="thg-auth-modal" role="document" aria-labelledby="thg-auth-title">
          <div class="thg-auth-header">
            <div class="thg-auth-title" id="thg-auth-title">Sign in to continue</div>
            <button class="thg-auth-close" type="button" aria-label="Close">✕</button>
          </div>
          <div class="thg-loading-bar" aria-hidden="true"></div>
          <div class="thg-auth-body">
            <div class="thg-tagline">"Browse only approved builder projects — safe, transparent, and verified"</div>
            <div class="thg-tabs" role="tablist" aria-label="Authentication method">
              <button class="thg-tab" role="tab" id="thg-tab-signin" aria-controls="thg-panel-signin" aria-selected="true">Sign in</button>
              <button class="thg-tab" role="tab" id="thg-tab-signup" aria-controls="thg-panel-signup" aria-selected="false">Create account</button>
            </div>
            <div class="thg-error" role="alert"></div>
            <div id="thg-panel-signin" role="tabpanel" aria-labelledby="thg-tab-signin">
              <div class="thg-field"><label for="thg-si-email">Email</label><input id="thg-si-email" class="thg-input" type="email" autocomplete="email" placeholder="you@example.com" /></div>
              <div class="thg-field"><label for="thg-si-password">Password</label><input id="thg-si-password" class="thg-input" type="password" autocomplete="current-password" placeholder="Your password" /></div>
              <div class="thg-actions"><button class="thg-link" type="button" id="thg-forgot">Forgot password?</button><span class="thg-hint"></span></div>
              <button class="thg-btn-primary" type="button" id="thg-signin-btn">Sign in</button>
              <div class="thg-oauth"><button class="thg-oauth-btn google" type="button" data-provider="google">Continue with Google</button></div>
            </div>
            <div id="thg-panel-signup" role="tabpanel" aria-labelledby="thg-tab-signup" hidden>
              <div class="thg-field"><label for="thg-su-name">Full name (optional)</label><input id="thg-su-name" class="thg-input" type="text" autocomplete="name" placeholder="Ada Lovelace" /></div>
              <div class="thg-field"><label for="thg-su-email">Email</label><input id="thg-su-email" class="thg-input" type="email" autocomplete="email" placeholder="you@example.com" /></div>
              <div class="thg-field"><label for="thg-su-password">Password</label><input id="thg-su-password" class="thg-input" type="password" autocomplete="new-password" placeholder="At least 8 characters" /></div>
              <div class="thg-actions"><span class="thg-hint">Use a strong password. You can add name later.</span></div>
              <button class="thg-btn-primary" type="button" id="thg-signup-btn">Create account</button>
              <div class="thg-oauth"><button class="thg-oauth-btn google" type="button" data-provider="google">Sign up with Google</button></div>
            </div>
            <div id="thg-panel-reset" role="tabpanel" aria-labelledby="thg-tab-reset" hidden>
              <div class="thg-field"><label for="thg-rp-email">Email</label><input id="thg-rp-email" class="thg-input" type="email" autocomplete="email" placeholder="you@example.com" /></div>
              <div class="thg-actions"><span class="thg-hint">We'll email a password reset link.</span></div>
              <button class="thg-btn-primary" type="button" id="thg-reset-btn">Send reset link</button>
            </div>
            <div id="thg-panel-update" role="tabpanel" aria-labelledby="thg-tab-update" hidden>
              <div class="thg-field"><label for="thg-up-password">New password</label><input id="thg-up-password" class="thg-input" type="password" autocomplete="new-password" placeholder="Enter a new password" /></div>
              <div class="thg-actions"><span class="thg-hint">You're recovering your account.</span></div>
              <button class="thg-btn-primary" type="button" id="thg-update-btn">Update password</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(overlay);
    }

    let confirmEl = document.querySelector('.thg-confirm');
    if (!confirmEl){
      confirmEl = createEl('div','thg-confirm',{'aria-hidden':'true','role':'dialog','aria-modal':'true'});
      confirmEl.innerHTML = '<div class="thg-confirm-card" role="document">' +
        '<div class="thg-confirm-msg">Are you sure you want to log out?</div>' +
        '<div class="thg-confirm-actions">' +
        '<button type="button" class="thg-btn thg-confirm-cancel">Cancel</button>' +
        '<button type="button" class="thg-btn thg-btn-danger thg-confirm-ok">Log out</button>' +
        '</div></div>';
      document.body.appendChild(confirmEl);
    }
    return { wrap, btn, menu, overlay, confirmEl };
  }

  const state = { user: null, loading: true, nextUrl: null, supabaseReady: false, sub: null };

  function setButtonLoading(ui, isLoading){ const spinner = ui.btn.querySelector('.thg-spinner'); const label = ui.btn.querySelector('.thg-label'); if (isLoading){ ui.btn.classList.remove('is-auth'); if (label) label.textContent = 'Loading…'; if (spinner) spinner.style.display = 'inline-block'; ui.btn.setAttribute('aria-expanded','false'); } else { if (spinner) spinner.style.display = 'none'; } }

  function render(ui){
    const label = ui.btn.querySelector('.thg-label');
    const avatar = ui.btn.querySelector('.thg-initial');
    if (state.loading){ setButtonLoading(ui, true); return; }
    setButtonLoading(ui, false);
    if (state.user && state.user.email){
      const name = getDisplayName(state.user);
      ui.btn.classList.add('is-auth');
      avatar.textContent = getInitials(state.user);
      label.textContent = clamp(name, 24);
      ui.btn.prepend(avatar);
      const initEl = ui.menu.querySelector('.thg-initial-lg');
      const nameEl = ui.menu.querySelector('.thg-name');
      const emailEl = ui.menu.querySelector('.thg-email');
      if (initEl) initEl.textContent = getInitials(state.user);
      if (nameEl) nameEl.textContent = clamp(name, 28);
      if (emailEl) emailEl.textContent = clamp(state.user.email || '', 30);
    } else {
      ui.btn.classList.remove('is-auth');
      ui.btn.setAttribute('aria-expanded','false');
      label.textContent = 'Login / Signup';
      avatar.textContent = 'U';
      ui.btn.prepend(avatar);
      closeMenu(ui);
    }
  }

  function openMenu(ui){ if (!state.user) return; ui.menu.setAttribute('aria-hidden','false'); ui.btn.setAttribute('aria-expanded','true'); const items = ui.menu.querySelectorAll('.thg-auth-item[role="menuitem"]'); if (items[0]) setTimeout(function(){ items[0].focus(); }, 0); }
  function closeMenu(ui){ ui.menu.setAttribute('aria-hidden','true'); ui.btn.setAttribute('aria-expanded','false'); }
  function toggleMenu(ui){ const isHidden = ui.menu.getAttribute('aria-hidden') === 'true'; if (isHidden) openMenu(ui); else closeMenu(ui); }

  function showError(uiOverlay, msg){ const el = uiOverlay.querySelector('.thg-error'); if (!el) return; el.textContent = msg; el.style.display = 'block'; }
  function clearError(uiOverlay){ const el = uiOverlay.querySelector('.thg-error'); if (!el) return; el.textContent = ''; el.style.display = 'none'; }
  function setModalLoading(uiOverlay, loading){ const bar = uiOverlay.querySelector('.thg-loading-bar'); if (!bar) return; if (loading){ bar.style.width = '75%'; } else { bar.style.width = '0'; } }
  function showPanel(uiOverlay, id, title){ ['signin','signup','reset','update'].forEach(function(key){ const panel = uiOverlay.querySelector('#thg-panel-'+key); if (panel) panel.hidden = (key !== id); }); const tEl = uiOverlay.querySelector('#thg-auth-title'); if (tEl) tEl.textContent = title; clearError(uiOverlay); }
  function openAuthModal(ui, opts){ state.nextUrl = opts?.next || null; ui.overlay.setAttribute('aria-hidden','false'); showPanel(ui.overlay, 'signin', 'Sign in'); setTimeout(function(){ const el = ui.overlay.querySelector('#thg-si-email'); if (el) el.focus(); }, 0); }
  function closeAuthModal(ui){ ui.overlay.setAttribute('aria-hidden','true'); }
  function openConfirm(ui){ ui.confirmEl.setAttribute('aria-hidden','false'); }
  function closeConfirm(ui){ ui.confirmEl.setAttribute('aria-hidden','true'); }

  function bindUI(ui){
    ui.btn.addEventListener('click', function(e){ e.preventDefault(); if (state.user && state.user.email){ toggleMenu(ui); } else { openAuthModal(ui, { next: location.pathname + location.search }); } });
    ui.btn.addEventListener('keydown', function(e){ if ((e.key === 'ArrowDown' || e.key === 'Enter') && state.user && state.user.email){ e.preventDefault(); openMenu(ui); } });
    ui.menu.addEventListener('click', function(e){ const item = e.target.closest('.thg-auth-item[role="menuitem"]'); if (!item) return; const act = item.getAttribute('data-action'); if (act === 'profile'){ closeMenu(ui); location.href = AUTH_NAV.profile; return; } if (act === 'dashboard'){ closeMenu(ui); location.href = AUTH_NAV.dashboard; return; } if (act === 'settings' && AUTH_NAV.settings){ closeMenu(ui); location.href = AUTH_NAV.settings; return; } if (act === 'logout'){ closeMenu(ui); openConfirm(ui); } });
    ui.menu.addEventListener('keydown', function(e){ if (e.key === 'Escape'){ e.preventDefault(); closeMenu(ui); ui.btn.focus(); return; } if (['ArrowDown','ArrowUp','Home','End'].indexOf(e.key) === -1) return; e.preventDefault(); const items = Array.prototype.slice.call(ui.menu.querySelectorAll('.thg-auth-item[role="menuitem"]')); const idx = items.indexOf(document.activeElement); if (!items.length) return; if (e.key === 'Home'){ items[0].focus(); return; } if (e.key === 'End'){ items[items.length - 1].focus(); return; } const next = e.key === 'ArrowDown' ? (idx + 1 + items.length) % items.length : (idx - 1 + items.length) % items.length; items[next].focus(); });
    document.addEventListener('click', function(e){ if (ui.menu.getAttribute('aria-hidden') === 'true') return; if (!ui.menu.contains(e.target) && e.target !== ui.btn && !ui.btn.contains(e.target)){ closeMenu(ui); } });
    const tabSignIn = ui.overlay.querySelector('#thg-tab-signin');
    const tabSignUp = ui.overlay.querySelector('#thg-tab-signup');
    function selectTab(which){ const a = which==='signin'; tabSignIn.setAttribute('aria-selected', a ? 'true' : 'false'); tabSignUp.setAttribute('aria-selected', a ? 'false' : 'true'); showPanel(ui.overlay, a ? 'signin' : 'signup', a ? 'Sign in' : 'Create account'); const first = ui.overlay.querySelector(a ? '#thg-si-email' : '#thg-su-name'); if (first) first.focus(); }
    tabSignIn.addEventListener('click', function(){ selectTab('signin'); });
    tabSignUp.addEventListener('click', function(){ selectTab('signup'); });
    ui.overlay.addEventListener('click', function(e){ if (e.target === ui.overlay) closeAuthModal(ui); });
    ui.overlay.querySelector('.thg-auth-close').addEventListener('click', function(){ closeAuthModal(ui); });
    document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && ui.overlay.getAttribute('aria-hidden') === 'false') closeAuthModal(ui); });
    const forgotBtn = ui.overlay.querySelector('#thg-forgot');
    forgotBtn.addEventListener('click', function(){ showPanel(ui.overlay, 'reset', 'Reset password'); const el = ui.overlay.querySelector('#thg-rp-email'); const source = ui.overlay.querySelector('#thg-si-email'); if (source && el && source.value) el.value = source.value; if (el) el.focus(); });
    ui.overlay.querySelector('#thg-signin-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const email = ui.overlay.querySelector('#thg-si-email').value.trim(); const password = ui.overlay.querySelector('#thg-si-password').value; if (!validateEmail(email)) { showError(ui.overlay, 'Enter a valid email.'); return; } if (!password || password.length < 6) { showError(ui.overlay, 'Enter your password.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const { error } = await window.supabase.auth.signInWithPassword({ email, password }); if (error) { showError(ui.overlay, error.message || 'Failed to sign in.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
    ui.overlay.querySelector('#thg-signup-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const name = ui.overlay.querySelector('#thg-su-name').value.trim(); const email = ui.overlay.querySelector('#thg-su-email').value.trim(); const password = ui.overlay.querySelector('#thg-su-password').value; if (!validateEmail(email)) { showError(ui.overlay, 'Enter a valid email.'); return; } if (!password || password.length < 8) { showError(ui.overlay, 'Password must be at least 8 characters.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const { error } = await window.supabase.auth.signUp({ email, password, options: { data: name ? { full_name: name } : {} } }); if (error) { showError(ui.overlay, error.message || 'Failed to create account.'); } else { showError(ui.overlay, 'Check your email to verify your account.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
    ui.overlay.querySelectorAll('.thg-oauth-btn').forEach(function(btn){ btn.addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const provider = btn.getAttribute('data-provider'); clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const redirectTo = location.origin + location.pathname + location.search; const { data, error } = await window.supabase.auth.signInWithOAuth({ provider, options: { redirectTo, skipBrowserRedirect: true, queryParams: { prompt: 'select_account' } } }); if (error) { const msg = /provider is not enabled/i.test(error.message||'') ? 'Google sign-in is not available yet.' : (error.message || 'Could not start sign in.'); showError(ui.overlay, msg); setModalLoading(ui.overlay, false); return; } if (data && data.url){ location.href = data.url; } else { setModalLoading(ui.overlay, false); showError(ui.overlay, 'Could not start ' + provider + ' sign in.'); } } catch(ex){ showError(ui.overlay, 'Failed to start ' + provider + ' sign in.'); setModalLoading(ui.overlay, false); } }); });
    ui.overlay.querySelector('#thg-reset-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const email = ui.overlay.querySelector('#thg-rp-email').value.trim(); if (!validateEmail(email)) { showError(ui.overlay, 'Enter a valid email.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const redirectTo = location.origin + location.pathname + location.search; const { error } = await window.supabase.auth.resetPasswordForEmail(email, { redirectTo }); if (error) { showError(ui.overlay, error.message || 'Failed to send reset link.'); } else { showError(ui.overlay, 'Reset link sent. Check your email.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
    ui.overlay.querySelector('#thg-update-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const password = ui.overlay.querySelector('#thg-up-password').value; if (!password || password.length < 8) { showError(ui.overlay, 'Password must be at least 8 characters.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const { error } = await window.supabase.auth.updateUser({ password }); if (error) { showError(ui.overlay, error.message || 'Failed to update password.'); } else { showPanel(ui.overlay, 'signin', 'Sign in'); showError(ui.overlay, 'Password updated. Please sign in.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
    ui.confirmEl.querySelector('.thg-confirm-cancel').addEventListener('click', function(){ closeConfirm(ui); });
    ui.confirmEl.addEventListener('click', function(e){ if (e.target === ui.confirmEl) closeConfirm(ui); });
    ui.confirmEl.querySelector('.thg-confirm-ok').addEventListener('click', async function(){ try { await window.supabase?.auth?.signOut?.(); } catch(_){} closeConfirm(ui); });
    window.__thgOpenAuthModal = function(opts){ openAuthModal(ui, opts); };
  }

  async function initSupabase(ui){
    state.loading = true; render(ui);
    if (!window.supabase || !window.supabase.auth){
      try {
        const mod = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
        const client = mod.createClient('https://wedevtjjmdvngyshqdro.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M');
        window.supabase = client;
      } catch(_) {}
    }
    if (!window.supabase || !window.supabase.auth){ state.supabaseReady = false; state.loading = false; render(ui); console.warn('[thg-auth] window.supabase not found.'); return; }
    state.supabaseReady = true;
    try{ const { data } = await window.supabase.auth.getSession(); state.user = data?.session?.user || null; } catch(_){ state.user = null; } finally { state.loading = false; render(ui); }
    try{
      const { data: sub } = window.supabase.auth.onAuthStateChange(function(event, session){ state.user = session?.user || null; render(ui); if (event === 'PASSWORD_RECOVERY'){ const overlay = ui.overlay; overlay.setAttribute('aria-hidden','false'); showPanel(overlay, 'update', 'Set new password'); setTimeout(function(){ const el = overlay.querySelector('#thg-up-password'); if (el) el.focus(); }, 0); } if (state.user && state.user.email){ if (state.nextUrl){ const to = state.nextUrl; state.nextUrl = null; try { closeAuthModal(ui); } catch(_){} location.href = to; } else { try { closeAuthModal(ui); } catch(_){} } } else { closeMenu(ui); } });
      state.sub = sub?.subscription || sub || null;
    } catch(_){ }
  }

  function observeRerenders(){ const mo = new MutationObserver(function(muts){ for (var i=0;i<muts.length;i++){ for (var j=0;j<muts[i].addedNodes.length;j++){ const n = muts[i].addedNodes[j]; if (n.nodeType !== 1) continue; hideLegacyAuthLinks(n); ensureContainer(); } } }); mo.observe(document.documentElement, { childList:true, subtree:true }); }

  ready(function(){ hideLegacyAuthLinks(document); injectStyles(); const ui = createUI(); bindUI(ui); observeRerenders(); initSupabase(ui); window.addEventListener('storage', function(ev){ if (ev.key === 'supabase.auth.token'){ } }); window.addEventListener('beforeunload', function(){ try { state.sub && state.sub.unsubscribe && state.sub.unsubscribe(); } catch(_){} }); });
})();
  </script> -->
  <!-- Unified auth overlay include (overrides any legacy handlers) -->
  <script>
    window.DURABLE_AUTH_URL = 'https://auth.tharaga.co.in/login_signup_glassdrop/';
    window.AUTH_NAV = { profile: '/profile', dashboard: '/dashboard' };
  </script>
  
  <!-- Include durable-auth-head snippet (same code as used site-wide in header) -->
  <!-- durable-auth-head include removed to avoid duplicate login/signup in iframe -->
  
  <!-- Durable top-right authentication header and modal (inline UI) [disabled; use durable-auth-head.html] -->
  <script type="text/plain" data-disabled="true">
  // Durable top-right authentication header and modal (Supabase-based)
  // Works standalone when pasted into Durable Head Code
  (function(){
    if (window.__thgAuthInstalledV1) return; window.__thgAuthInstalledV1 = true;
  
    const AUTH_NAV = Object.assign({ profile: '/profile', dashboard: '/dashboard', settings: null }, window.AUTH_NAV || {});
    const Z_BASE = 2147483000;
  
    window.authGate = window.authGate || {};
    window.authGate.openLoginModal = function(opts){ (window.__thgOpenAuthModal || function(){ alert('Auth not ready'); })(opts||{}); };
  
    function ready(fn){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn,{once:true});} else { fn(); } }
    function headerRoot(){ return document.querySelector('header, [role="banner"], [data-section="header"], .site-header, .Header, nav') || null; }
    // Instead of hiding legacy/login links, wire them to trigger the header auth button
    function hideLegacyAuthLinks(root){
      var scope = (root || document);
      var selector = 'a[href="#login"], a[href="#signup"], [data-auth-open]';
      scope.querySelectorAll(selector).forEach(function(el){
        if (el.__thgAuthWired) return;
        el.__thgAuthWired = true;
        el.addEventListener('click', function(ev){
          try {
            ev.preventDefault();
            // Prefer triggering the existing header Login/Signup button
            var btn = document.querySelector('.thg-auth-btn');
            if (btn) { btn.click(); return; }
            // Fallback to opening the modal directly
            if (window.authGate && typeof window.authGate.openLoginModal === 'function') {
              window.authGate.openLoginModal({ next: location.pathname + location.search });
            } else if (typeof window.__thgOpenAuthModal === 'function') {
              window.__thgOpenAuthModal({ next: location.pathname + location.search });
            }
          } catch(_){ }
        }, { passive:false });
      });
    }
    function clamp(str, max){ if (!str) return ''; return str.length>max ? str.slice(0,max-1)+'…' : str; }
    function getInitials(user){
      const meta = user?.user_metadata || {};
      const full = (meta.full_name || meta.name || '').trim();
      if (full) {
        const parts = full.split(/\s+/).filter(Boolean);
        const first = parts[0]?.[0] || '';
        const last = parts.length>1 ? parts[parts.length-1][0] : '';
        return (first+last || first || '').toUpperCase() || 'U';
      }
      const email = (user?.email || '').trim();
      return email ? email[0].toUpperCase() : 'U';
    }
    function getDisplayName(user){
      const meta = user?.user_metadata || {};
      const name = (meta.full_name || meta.name || meta.username || '').trim();
      return name || (user?.email || 'My Account');
    }
    function createEl(tag, cls, attrs){ const el = document.createElement(tag); if (cls) el.className = cls; if (attrs) for (var k in attrs) el.setAttribute(k, attrs[k]); return el; }
    function validateEmail(val){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val); }
    function ensureContainer(){
      let hdr = headerRoot();
      let wrap = document.querySelector('.thg-auth-wrap');
      if (!wrap){
        wrap = document.createElement('div');
        wrap.className = 'thg-auth-wrap';
        let parent = hdr || document.body;
        if (hdr) { const cs = getComputedStyle(hdr); if (cs.position === 'static') { hdr.style.position = 'relative'; } parent.appendChild(wrap); }
        else { wrap.classList.add('is-fixed'); parent.appendChild(wrap); }
      }
      return wrap;
    }
  
    function injectStyles(){
      if (document.getElementById('thg-auth-styles')) return;
      const css = `
.thg-auth-wrap{ position:absolute; top:14px; right:16px; display:flex; align-items:center; z-index:${Z_BASE}; }
@media (min-width:1024px){ .thg-auth-wrap{ top:16px; right:24px; } }
.thg-auth-wrap.is-fixed{ position:fixed; top:14px; right:16px; }

/* Header button */
.thg-auth-btn{ appearance:none;background:transparent;color:#fff;border:1px solid rgba(255,255,255,.9); border-radius:9999px;padding:8px 14px;font-weight:600;cursor:pointer;line-height:1;white-space:nowrap;display:inline-flex;align-items:center;gap:8px; transition:background .15s ease, border-color .15s ease, box-shadow .15s ease; }
.thg-auth-btn:hover{background:rgba(255,255,255,.08)}
.thg-auth-btn:focus-visible{ outline:2px solid #7dd3fc; outline-offset:2px; }
.thg-auth-btn .thg-initial{ width:22px;height:22px;border-radius:9999px;background:#fff;color:#111;display:none;align-items:center;justify-content:center;font-weight:700;font-size:11px; }
.thg-auth-btn.is-auth .thg-initial{ display:inline-flex; }
.thg-auth-btn.is-auth::after{ content:""; display:inline-block; width:0; height:0; border-left:5px solid transparent; border-right:5px solid transparent; border-top:6px solid rgba(255,255,255,.9); transition:transform .15s ease; transform-origin:center; }
.thg-auth-btn[aria-expanded="true"].is-auth::after{ transform:rotate(180deg); }
.thg-spinner{ width:14px;height:14px;border-radius:9999px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff; animation:thgspin .8s linear infinite; }
@keyframes thgspin{ to{ transform:rotate(360deg); } }

/* Account menu */
.thg-auth-menu{ position:absolute;top:calc(100% + 10px);right:0;min-width:280px;background:#0b0b0b;color:#fff; border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;box-shadow:0 12px 30px rgba(0,0,0,.45); visibility:hidden; opacity:0; transform:translateY(-6px) scale(.98); transform-origin:top right; pointer-events:none; transition:opacity .16s ease, transform .16s ease, visibility 0s linear .16s; z-index:${Z_BASE+1}; }
.thg-auth-menu[aria-hidden="false"]{ visibility:visible; opacity:1; transform:translateY(0) scale(1); pointer-events:auto; transition:opacity .16s ease, transform .16s ease, visibility 0s linear 0s; }
.thg-auth-item{ display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;text-decoration:none;color:#fff;cursor:pointer; }
.thg-auth-item:hover{background:rgba(255,255,255,.08)}
.thg-auth-item[tabindex]{outline:none}
.thg-auth-item.is-header{ cursor:default;font-weight:700;opacity:.95; }
.thg-auth-item.is-header:hover{background:transparent}
.thg-auth-sep{ height:1px;background:rgba(255,255,255,.12);margin:6px 8px;border-radius:1px; }
.thg-initial-lg{ width:28px;height:28px;border-radius:9999px;background:#fff;color:#111;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:12px; }
.thg-name-wrap{ display:flex; flex-direction:column; min-width:0; }
.thg-name{ overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:190px; }
.thg-email{ opacity:.7; font-size:12px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap; max-width:200px; }

/* Modal */
.thg-auth-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter:saturate(140%) blur(6px); display:flex; align-items:center; justify-content:center; z-index:${Z_BASE+2}; visibility:hidden; opacity:0; transition:opacity .18s ease, visibility 0s linear .18s; }
.thg-auth-overlay[aria-hidden="false"]{ visibility:visible; opacity:1; transition:opacity .18s ease, visibility 0s linear 0s; }
.thg-auth-modal{ width:100%; max-width:420px; background:linear-gradient(180deg, rgba(20,20,20,.98), rgba(12,12,12,.98)); color:#fff; border:1px solid rgba(255,255,255,.1); border-radius:16px; box-shadow:0 30px 60px rgba(0,0,0,.5); transform:translateY(10px) scale(.98); opacity:0; transition:transform .18s ease, opacity .18s ease; }
.thg-auth-overlay[aria-hidden="false"] .thg-auth-modal{ transform:translateY(0) scale(1); opacity:1; }
.thg-auth-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.08); }
.thg-auth-title{ font-weight:800; font-size:20px; }
.thg-auth-close{ appearance:none; background:linear-gradient(180deg,#f3cd4a,#eab308,#c58a04); border:0; color:#111; cursor:pointer; font-weight:800; width:32px; height:32px; line-height:32px; border-radius:9999px; box-shadow:0 2px 6px rgba(0,0,0,.25); }
.thg-auth-close:hover{ color:#fff; background:linear-gradient(180deg,#eab308,#c58a04,#7a5200); transform:scale(1.06); }
.thg-auth-body{ padding:16px 18px 18px; }

/* Tabs */
.thg-tabs{ display:flex; gap:6px; background:rgba(255,255,255,.06); padding:4px; border-radius:9999px; margin-bottom:16px; }
.thg-tab{ flex:1; text-align:center; padding:8px 10px; border-radius:9999px; cursor:pointer; font-weight:700; color:#ddd; }
.thg-tab[aria-selected="true"]{ background:#fff; color:#111; }

/* Fields */
.thg-field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
.thg-field label{ font-size:12px; opacity:.9; }
.thg-field label[for="thg-si-password"]::after{ content:" (optional — use Magic Link for fastest login)"; color:#9ca3af; font-weight:500; }
.thg-input{ appearance:none; background:#121212; color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px; }
.thg-input::placeholder{ color:#6b7280; }
.thg-input:focus{ outline:2px solid #facc15; outline-offset:2px; }

/* Actions and links */
.thg-actions{ display:flex; justify-content:space-between; align-items:center; margin:6px 0 12px; }
.thg-link{ background:none; border:0; color:#22c55e; cursor:pointer; font-size:13px; padding:0; }

/* Primary CTA (yellow) */
.thg-btn-primary{ width:100%; appearance:none; background:linear-gradient(180deg,#f8d34a,#f0b90b,#c89200); color:#111; border:1px solid rgba(250, 204, 21, .9); border-radius:12px; padding:12px 14px; font-weight:800; cursor:pointer; transition:transform .06s ease, box-shadow .06s ease, filter .12s ease; box-shadow:0 4px 0 rgba(250, 204, 21, .35); }
.thg-btn-primary:hover{ filter:brightness(1.03); }
.thg-btn-primary:active{ transform:translateY(1px); box-shadow:none; }

/* OAuth / secondary buttons */
.thg-oauth{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
.thg-oauth-btn{ appearance:none; background:#0f0f0f; color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:12px 14px; cursor:pointer; font-weight:800; }
.thg-oauth-btn.google{ border-color:#333; background:#151515; }

/* Errors, hints, loading */
.thg-error{ background:rgba(239,68,68,.12); color:#fecaca; border:1px solid rgba(239,68,68,.35); border-radius:10px; padding:10px 12px; font-size:13px; display:none; }
.thg-hint{ font-size:12px; opacity:.8; }
.thg-loading-bar{ height:2px; width:0; background:#7dd3fc; border-radius:2px; transition:width .2s ease; }

/* Confirm dialog */
.thg-confirm{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:${Z_BASE+3}; background:rgba(0,0,0,.55); backdrop-filter:blur(3px); visibility:hidden; opacity:0; transition:opacity .16s ease, visibility 0s linear .16s; }
.thg-confirm[aria-hidden="false"]{ visibility:visible; opacity:1; transition:opacity .16s ease, visibility 0s linear 0s; }
.thg-confirm-card{ width:100%; max-width:360px; background:#141414; color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:16px; box-shadow:0 24px 50px rgba(0,0,0,.5); }
.thg-confirm-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
.thg-btn{ appearance:none; border-radius:10px; padding:8px 12px; cursor:pointer; border:1px solid rgba(255,255,255,.15); background:#0f0f0f; color:#fff; }

/* Responsive */
@media (max-width:480px){
  .thg-auth-wrap{ top:10px; right:10px; }
  .thg-auth-modal{ width:calc(100% - 16px); margin:0 8px; }
  .thg-auth-menu{ right:8px; }
}

/* tagline styling */
.thg-tagline{ color:#9ca3af; font-size:13px; margin:-4px 0 12px; }
`;
      const style = document.createElement('style');
      style.id = 'thg-auth-styles';
      style.textContent = css;
      document.head.appendChild(style);
    }
  
    function createUI(){
      const wrap = ensureContainer();
      let btn = wrap.querySelector('.thg-auth-btn');
      if (!btn){
        btn = createEl('button', 'thg-auth-btn', { type:'button', 'aria-haspopup':'menu', 'aria-expanded':'false', 'aria-label':'Open account menu' });
        const avatar = createEl('span', 'thg-initial');
        avatar.textContent = 'U';
        const label = document.createElement('span');
        label.className = 'thg-label';
        const spinner = createEl('span','thg-spinner',{'aria-hidden':'true'});
        btn.appendChild(avatar); btn.appendChild(label); btn.appendChild(spinner);
        wrap.appendChild(btn);
      }
  
      let menu = wrap.querySelector('.thg-auth-menu');
      if (!menu){
        menu = createEl('div', 'thg-auth-menu', { id:'thg-auth-menu', role:'menu', 'aria-hidden':'true' });
        menu.innerHTML = '<div class="thg-auth-item is-header" aria-disabled="true">' +
          '<span class="thg-initial-lg">U</span>' +
          '<span class="thg-name-wrap">' +
          '<span class="thg-name">User</span>' +
          '<span class="thg-email">email@example.com</span>' +
          '</span>' +
          '</div>' +
          '<div class="thg-auth-sep"></div>' +
          '<div class="thg-auth-item" role="menuitem" tabindex="0" data-action="profile"><span>Profile</span></div>' +
          '<div class="thg-auth-item" role="menuitem" tabindex="0" data-action="dashboard"><span>Dashboard</span></div>' +
          '<div class="thg-auth-item" role="menuitem" tabindex="0" data-action="logout"><span>Logout</span></div>';
        wrap.appendChild(menu);
      }
      btn.setAttribute('aria-controls','thg-auth-menu');
  
      let overlay = document.querySelector('.thg-auth-overlay');
      if (!overlay){
        overlay = createEl('div','thg-auth-overlay',{'aria-hidden':'true','aria-modal':'true','role':'dialog'});
        overlay.innerHTML = `
          <div class="thg-auth-modal" role="document" aria-labelledby="thg-auth-title">
            <div class="thg-auth-header">
              <div class="thg-auth-title" id="thg-auth-title">Sign in to continue</div>
              <button class="thg-auth-close" type="button" aria-label="Close">✕</button>
            </div>
            <div class="thg-loading-bar" aria-hidden="true"></div>
            <div class="thg-auth-body">
              <div class="thg-tagline">"Browse only approved builder projects — safe, transparent, and verified"</div>
              <div class="thg-tabs" role="tablist" aria-label="Authentication method">
                <button class="thg-tab" role="tab" id="thg-tab-signin" aria-controls="thg-panel-signin" aria-selected="true">Sign in</button>
                <button class="thg-tab" role="tab" id="thg-tab-signup" aria-controls="thg-panel-signup" aria-selected="false">Create account</button>
              </div>
              <div class="thg-error" role="alert"></div>
              <div id="thg-panel-signin" role="tabpanel" aria-labelledby="thg-tab-signin">
                <div class="thg-field"><label for="thg-si-email">Email</label><input id="thg-si-email" class="thg-input" type="email" autocomplete="email" placeholder="you@example.com" /></div>
                <div class="thg-field"><label for="thg-si-password">Password</label><input id="thg-si-password" class="thg-input" type="password" autocomplete="current-password" placeholder="Your password" /></div>
                <div class="thg-actions"><button class="thg-link" type="button" id="thg-forgot">Forgot password?</button><span class="thg-hint"></span></div>
                <button class="thg-btn-primary" type="button" id="thg-signin-btn">Sign in</button>
                <div class="thg-oauth"><button class="thg-oauth-btn google" type="button" data-provider="google">Continue with Google</button></div>
              </div>
              <div id="thg-panel-signup" role="tabpanel" aria-labelledby="thg-tab-signup" hidden>
                <div class="thg-field"><label for="thg-su-name">Full name (optional)</label><input id="thg-su-name" class="thg-input" type="text" autocomplete="name" placeholder="Ada Lovelace" /></div>
                <div class="thg-field"><label for="thg-su-email">Email</label><input id="thg-su-email" class="thg-input" type="email" autocomplete="email" placeholder="you@example.com" /></div>
                <div class="thg-field"><label for="thg-su-password">Password</label><input id="thg-su-password" class="thg-input" type="password" autocomplete="new-password" placeholder="At least 8 characters" /></div>
                <div class="thg-actions"><span class="thg-hint">Use a strong password. You can add name later.</span></div>
                <button class="thg-btn-primary" type="button" id="thg-signup-btn">Create account</button>
                <div class="thg-oauth"><button class="thg-oauth-btn google" type="button" data-provider="google">Sign up with Google</button></div>
              </div>
              <div id="thg-panel-reset" role="tabpanel" aria-labelledby="thg-tab-reset" hidden>
                <div class="thg-field"><label for="thg-rp-email">Email</label><input id="thg-rp-email" class="thg-input" type="email" autocomplete="email" placeholder="you@example.com" /></div>
                <div class="thg-actions"><span class="thg-hint">We'll email a password reset link.</span></div>
                <button class="thg-btn-primary" type="button" id="thg-reset-btn">Send reset link</button>
              </div>
              <div id="thg-panel-update" role="tabpanel" aria-labelledby="thg-tab-update" hidden>
                <div class="thg-field"><label for="thg-up-password">New password</label><input id="thg-up-password" class="thg-input" type="password" autocomplete="new-password" placeholder="Enter a new password" /></div>
                <div class="thg-actions"><span class="thg-hint">You're recovering your account.</span></div>
                <button class="thg-btn-primary" type="button" id="thg-update-btn">Update password</button>
              </div>
            </div>
          </div>`;
        document.body.appendChild(overlay);
      }
  
      let confirmEl = document.querySelector('.thg-confirm');
      if (!confirmEl){
        confirmEl = createEl('div','thg-confirm',{'aria-hidden':'true','role':'dialog','aria-modal':'true'});
        confirmEl.innerHTML = '<div class="thg-confirm-card" role="document">' +
          '<div class="thg-confirm-msg">Are you sure you want to log out?</div>' +
          '<div class="thg-confirm-actions">' +
          '<button type="button" class="thg-btn thg-confirm-cancel">Cancel</button>' +
          '<button type="button" class="thg-btn thg-btn-danger thg-confirm-ok">Log out</button>' +
          '</div></div>';
        document.body.appendChild(confirmEl);
      }
      return { wrap, btn, menu, overlay, confirmEl };
    }
  
    const state = { user: null, loading: true, nextUrl: null, supabaseReady: false, sub: null };
  
    function setButtonLoading(ui, isLoading){ const spinner = ui.btn.querySelector('.thg-spinner'); const label = ui.btn.querySelector('.thg-label'); if (isLoading){ ui.btn.classList.remove('is-auth'); if (label) label.textContent = 'Loading…'; if (spinner) spinner.style.display = 'inline-block'; ui.btn.setAttribute('aria-expanded','false'); } else { if (spinner) spinner.style.display = 'none'; } }
  
    function render(ui){
      const label = ui.btn.querySelector('.thg-label');
      const avatar = ui.btn.querySelector('.thg-initial');
      if (state.loading){ setButtonLoading(ui, true); return; }
      setButtonLoading(ui, false);
      if (state.user && state.user.email){
        const name = getDisplayName(state.user);
        ui.btn.classList.add('is-auth');
        avatar.textContent = getInitials(state.user);
        label.textContent = clamp(name, 24);
        ui.btn.prepend(avatar);
        const initEl = ui.menu.querySelector('.thg-initial-lg');
        const nameEl = ui.menu.querySelector('.thg-name');
        const emailEl = ui.menu.querySelector('.thg-email');
        if (initEl) initEl.textContent = getInitials(state.user);
        if (nameEl) nameEl.textContent = clamp(name, 28);
        if (emailEl) emailEl.textContent = clamp(state.user.email || '', 30);
      } else {
        ui.btn.classList.remove('is-auth');
        ui.btn.setAttribute('aria-expanded','false');
        label.textContent = 'Login / Signup';
        avatar.textContent = 'U';
        ui.btn.prepend(avatar);
        closeMenu(ui);
      }
    }
  
    function openMenu(ui){ if (!state.user) return; ui.menu.setAttribute('aria-hidden','false'); ui.btn.setAttribute('aria-expanded','true'); const items = ui.menu.querySelectorAll('.thg-auth-item[role="menuitem"]'); if (items[0]) setTimeout(function(){ items[0].focus(); }, 0); }
    function closeMenu(ui){ ui.menu.setAttribute('aria-hidden','true'); ui.btn.setAttribute('aria-expanded','false'); }
    function toggleMenu(ui){ const isHidden = ui.menu.getAttribute('aria-hidden') === 'true'; if (isHidden) openMenu(ui); else closeMenu(ui); }
  
    function showError(uiOverlay, msg){ const el = uiOverlay.querySelector('.thg-error'); if (!el) return; el.textContent = msg; el.style.display = 'block'; }
    function clearError(uiOverlay){ const el = uiOverlay.querySelector('.thg-error'); if (!el) return; el.textContent = ''; el.style.display = 'none'; }
    function setModalLoading(uiOverlay, loading){ const bar = uiOverlay.querySelector('.thg-loading-bar'); if (!bar) return; if (loading){ bar.style.width = '75%'; } else { bar.style.width = '0'; } }
    function showPanel(uiOverlay, id, title){ ['signin','signup','reset','update'].forEach(function(key){ const panel = uiOverlay.querySelector('#thg-panel-'+key); if (panel) panel.hidden = (key !== id); }); const tEl = uiOverlay.querySelector('#thg-auth-title'); if (tEl) tEl.textContent = title; clearError(uiOverlay); }
    function openAuthModal(ui, opts){ state.nextUrl = opts?.next || null; ui.overlay.setAttribute('aria-hidden','false'); showPanel(ui.overlay, 'signin', 'Sign in'); setTimeout(function(){ const el = ui.overlay.querySelector('#thg-si-email'); if (el) el.focus(); }, 0); }
    function closeAuthModal(ui){ ui.overlay.setAttribute('aria-hidden','true'); }
    function openConfirm(ui){ ui.confirmEl.setAttribute('aria-hidden','false'); }
    function closeConfirm(ui){ ui.confirmEl.setAttribute('aria-hidden','true'); }
  
    function bindUI(ui){
      ui.btn.addEventListener('click', function(e){ e.preventDefault(); if (state.user && state.user.email){ toggleMenu(ui); } else { openAuthModal(ui, { next: location.pathname + location.search }); } });
      ui.btn.addEventListener('keydown', function(e){ if ((e.key === 'ArrowDown' || e.key === 'Enter') && state.user && state.user.email){ e.preventDefault(); openMenu(ui); } });
      ui.menu.addEventListener('click', function(e){ const item = e.target.closest('.thg-auth-item[role="menuitem"]'); if (!item) return; const act = item.getAttribute('data-action'); if (act === 'profile'){ closeMenu(ui); location.href = AUTH_NAV.profile; return; } if (act === 'dashboard'){ closeMenu(ui); location.href = AUTH_NAV.dashboard; return; } if (act === 'settings' && AUTH_NAV.settings){ closeMenu(ui); location.href = AUTH_NAV.settings; return; } if (act === 'logout'){ closeMenu(ui); openConfirm(ui); } });
      ui.menu.addEventListener('keydown', function(e){ if (e.key === 'Escape'){ e.preventDefault(); closeMenu(ui); ui.btn.focus(); return; } if (['ArrowDown','ArrowUp','Home','End'].indexOf(e.key) === -1) return; e.preventDefault(); const items = Array.prototype.slice.call(ui.menu.querySelectorAll('.thg-auth-item[role="menuitem"]')); const idx = items.indexOf(document.activeElement); if (!items.length) return; if (e.key === 'Home'){ items[0].focus(); return; } if (e.key === 'End'){ items[items.length - 1].focus(); return; } const next = e.key === 'ArrowDown' ? (idx + 1 + items.length) % items.length : (idx - 1 + items.length) % items.length; items[next].focus(); });
      document.addEventListener('click', function(e){ if (ui.menu.getAttribute('aria-hidden') === 'true') return; if (!ui.menu.contains(e.target) && e.target !== ui.btn && !ui.btn.contains(e.target)){ closeMenu(ui); } });
      const tabSignIn = ui.overlay.querySelector('#thg-tab-signin');
      const tabSignUp = ui.overlay.querySelector('#thg-tab-signup');
      function selectTab(which){ const a = which==='signin'; tabSignIn.setAttribute('aria-selected', a ? 'true' : 'false'); tabSignUp.setAttribute('aria-selected', a ? 'false' : 'true'); showPanel(ui.overlay, a ? 'signin' : 'signup', a ? 'Sign in' : 'Create account'); const first = ui.overlay.querySelector(a ? '#thg-si-email' : '#thg-su-name'); if (first) first.focus(); }
      tabSignIn.addEventListener('click', function(){ selectTab('signin'); });
      tabSignUp.addEventListener('click', function(){ selectTab('signup'); });
      ui.overlay.addEventListener('click', function(e){ if (e.target === ui.overlay) closeAuthModal(ui); });
      ui.overlay.querySelector('.thg-auth-close').addEventListener('click', function(){ closeAuthModal(ui); });
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && ui.overlay.getAttribute('aria-hidden') === 'false') closeAuthModal(ui); });
      const forgotBtn = ui.overlay.querySelector('#thg-forgot');
      forgotBtn.addEventListener('click', function(){ showPanel(ui.overlay, 'reset', 'Reset password'); const el = ui.overlay.querySelector('#thg-rp-email'); const source = ui.overlay.querySelector('#thg-si-email'); if (source && el && source.value) el.value = source.value; if (el) el.focus(); });
      ui.overlay.querySelector('#thg-signin-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const email = ui.overlay.querySelector('#thg-si-email').value.trim(); const password = ui.overlay.querySelector('#thg-si-password').value; if (!validateEmail(email)) { showError(ui.overlay, 'Enter a valid email.'); return; } if (!password || password.length < 6) { showError(ui.overlay, 'Enter your password.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const { error } = await window.supabase.auth.signInWithPassword({ email, password }); if (error) { showError(ui.overlay, error.message || 'Failed to sign in.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
      ui.overlay.querySelector('#thg-signup-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const name = ui.overlay.querySelector('#thg-su-name').value.trim(); const email = ui.overlay.querySelector('#thg-su-email').value.trim(); const password = ui.overlay.querySelector('#thg-su-password').value; if (!validateEmail(email)) { showError(ui.overlay, 'Enter a valid email.'); return; } if (!password || password.length < 8) { showError(ui.overlay, 'Password must be at least 8 characters.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const { error } = await window.supabase.auth.signUp({ email, password, options: { data: name ? { full_name: name } : {} } }); if (error) { showError(ui.overlay, error.message || 'Failed to create account.'); } else { showError(ui.overlay, 'Check your email to verify your account.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
      ui.overlay.querySelectorAll('.thg-oauth-btn').forEach(function(btn){ btn.addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const provider = btn.getAttribute('data-provider'); clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const redirectTo = location.origin + location.pathname + location.search; const { data, error } = await window.supabase.auth.signInWithOAuth({ provider, options: { redirectTo, skipBrowserRedirect: true, queryParams: { prompt: 'select_account' } } }); if (error) { const msg = /provider is not enabled/i.test(error.message||'') ? 'Google sign-in is not available yet.' : (error.message || 'Could not start sign in.'); showError(ui.overlay, msg); setModalLoading(ui.overlay, false); return; } if (data && data.url){ location.href = data.url; } else { setModalLoading(ui.overlay, false); showError(ui.overlay, 'Could not start ' + provider + ' sign in.'); } } catch(ex){ showError(ui.overlay, 'Failed to start ' + provider + ' sign in.'); setModalLoading(ui.overlay, false); } }); });
      ui.overlay.querySelector('#thg-reset-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const email = ui.overlay.querySelector('#thg-rp-email').value.trim(); if (!validateEmail(email)) { showError(ui.overlay, 'Enter a valid email.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const redirectTo = location.origin + location.pathname + location.search; const { error } = await window.supabase.auth.resetPasswordForEmail(email, { redirectTo }); if (error) { showError(ui.overlay, error.message || 'Failed to send reset link.'); } else { showError(ui.overlay, 'Reset link sent. Check your email.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
      ui.overlay.querySelector('#thg-update-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const password = ui.overlay.querySelector('#thg-up-password').value; if (!password || password.length < 8) { showError(ui.overlay, 'Password must be at least 8 characters.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const { error } = await window.supabase.auth.updateUser({ password }); if (error) { showError(ui.overlay, error.message || 'Failed to update password.'); } else { showPanel(ui.overlay, 'signin', 'Sign in'); showError(ui.overlay, 'Password updated. Please sign in.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
      ui.confirmEl.querySelector('.thg-confirm-cancel').addEventListener('click', function(){ closeConfirm(ui); });
      ui.confirmEl.addEventListener('click', function(e){ if (e.target === ui.confirmEl) closeConfirm(ui); });
      ui.confirmEl.querySelector('.thg-confirm-ok').addEventListener('click', async function(){ try { await window.supabase?.auth?.signOut?.(); } catch(_){} closeConfirm(ui); });
      window.__thgOpenAuthModal = function(opts){ openAuthModal(ui, opts); };
      // Expose a helper to programmatically trigger the header button from anywhere
      window.authGate.triggerHeaderLogin = function(opts){
        try { ui.btn && ui.btn.click(); }
        catch(_){ try { openAuthModal(ui, opts||{ next: location.pathname + location.search }); } catch(__){} }
      };
    }
  
    async function initSupabase(ui){
      state.loading = true; render(ui);
      if (!window.supabase || !window.supabase.auth){
        try {
          const mod = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
          const client = mod.createClient('https://wedevtjjmdvngyshqdro.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M');
          window.supabase = client;
        } catch(_) {}
      }
      if (!window.supabase || !window.supabase.auth){ state.supabaseReady = false; state.loading = false; render( ui); console.warn('[thg-auth] window.supabase not found.'); return; }
      state.supabaseReady = true;
      try{ const { data } = await window.supabase.auth.getSession(); state.user = data?.session?.user || null; } catch(_){ state.user = null; } finally { state.loading = false; render(ui); }
      try{
        const { data: sub } = window.supabase.auth.onAuthStateChange(function(event, session){ state.user = session?.user || null; render(ui); if (event === 'PASSWORD_RECOVERY'){ const overlay = ui.overlay; overlay.setAttribute('aria-hidden','false'); showPanel(overlay, 'update', 'Set new password'); setTimeout(function(){ const el = overlay.querySelector('#thg-up-password'); if (el) el.focus(); }, 0); } if (state.user && state.user.email){ if (state.nextUrl){ const to = state.nextUrl; state.nextUrl = null; try { closeAuthModal(ui); } catch(_){} location.href = to; } else { try { closeAuthModal(ui); } catch(_){} } } else { closeMenu(ui); } });
        state.sub = sub?.subscription || sub || null;
      } catch(_){ }
    }
  
    function observeRerenders(){ const mo = new MutationObserver(function(muts){ for (var i=0;i<muts.length;i++){ for (var j=0;j<muts[i].addedNodes.length;j++){ const n = muts[i].addedNodes[j]; if (n.nodeType !== 1) continue; hideLegacyAuthLinks(n); ensureContainer(); } } }); mo.observe(document.documentElement, { childList:true, subtree:true }); }
  
    ready(function(){ hideLegacyAuthLinks(document); injectStyles(); const ui = createUI(); bindUI(ui); observeRerenders(); initSupabase(ui); window.addEventListener('storage', function(ev){ if (ev.key === 'supabase.auth.token'){ } }); window.addEventListener('beforeunload', function(){ try { state.sub && state.sub.unsubscribe && state.sub.unsubscribe(); } catch(_){} }); });
  })();
  </script>
</head>
<body>

<!-- ===== Verified Buyer Form (Drop-in) ===== -->
<section id="buyer-intake" style="max-width: 760px; margin: 0 auto; padding: 24px;">
  <h3 style="font-family: 'Poppins', sans-serif; font-weight: 600; text-align:center; margin-bottom: 12px;">
    Get Matched to Verified Properties
  </h3>
  <p style="text-align:center; margin:0 0 16px;">OTP-verified leads only. No spam. No brokerage.</p>

  <!-- Netlify Forms attrs -->
  <form name="buyer-intake"
        method="POST"
        data-netlify="true"
        netlify-honeypot="bot-field"
        data-netlify-recaptcha="true"
        id="buyerForm"
        style="background:#FAF5EF; border-radius:12px; padding:16px; font-family:'Poppins',sans-serif">

    <!-- Netlify Forms hidden helpers -->
    <input type="hidden" name="form-name" value="buyer-intake" />
    <p style="display:none;">
      <label>Don't fill this out if you're human: <input name="bot-field" /></label>
    </p>

    <!-- UTM + referrer capture -->
    <input type="hidden" name="utm_source" id="utm_source">
    <input type="hidden" name="utm_medium" id="utm_medium">
    <input type="hidden" name="utm_campaign" id="utm_campaign">
    <input type="hidden" name="referrer"     id="referrer">
    <input type="hidden" name="otp_verified" id="otp_verified" value="false">

    <div class="grid-2">
      <label style="display:block;">
        <span>Name</span>
        <input required type="text" name="name" placeholder="Your full name"
               style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
      </label>

      <label style="display:block;">
        <span>Email</span>
        <input required type="email" name="email" placeholder="you@example.com"
               style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
        <small id="emailNotice" style="display:none;color:#b45309;margin-top:6px;display:block;">
          Please enter your account email shown at the top-right header.
        </small>
      </label>
    </div>

    <div class="grid-2 grid-right-btn">
      <label style="display:block;">
        <span>Phone (India)</span>
        <input required type="tel" name="phone" id="phone"
          inputmode="numeric"
          pattern="^[6-9][0-9]{9}$"
          title="Enter a 10-digit Indian mobile number starting with 6–9"
          placeholder="10-digit mobile number"

          style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
      </label>

      <style>
        .otp-input {
          width: 40px;
          height: 50px;
          font-size: 20px;
          text-align: center;
          border: 2px solid #ccc;
          border-radius: 8px;
        }
        .otp-input:focus {
          border-color: #0e0e0e;
          outline: none;
        }
      </style>


      <button type="button" id="sendOtpBtn"
        style="padding:10px; border:none; border-radius:8px; background:#0e0e0e; color:#fff; cursor:pointer;">
        Send OTP
      </button>

    </div>

    <div id="otpBlock" style="display:none; margin-top:12px; text-align:center;">
      <div class="otp-container" style="display:flex; gap:8px; justify-content:center; margin-bottom:12px;">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 1">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 2">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 3">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 4">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 5">
        <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" aria-label="OTP digit 6">
      </div>
      <button type="button" id="verifyOtpBtn"
              style="padding:10px 20px; border:none; border-radius:8px; background:#0e0e0e; color:#fff; cursor:pointer;">
        Verify OTP
      </button>
      <small id="otpStatus" style="display:block; margin-top:6px;"></small>
    </div>

    <!-- Buyer profiling -->
    <div class="grid-2">
      <label style="display:block;">
        <span>Preferred City / Area</span>
        <input required type="text" name="location" placeholder="e.g., Anna Nagar, OMR, Coimbatore"
               style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
      </label>

      <label style="display:block;">
        <span>Budget</span>
        <select required name="budget"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
          <option value="">Select</option>
          <option>₹50L – ₹1Cr</option>
          <option>₹1Cr – ₹2Cr</option>
          <option>₹2Cr – ₹3Cr</option>
          <option>₹3Cr+</option>
        </select>
      </label>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
      <label style="display:block;">
        <span>Property Type</span>
        <select required name="property_type"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
          <option value="">Select</option>
          <option>Apartment</option>
          <option>Villa</option>
          <option>Plot</option>
          <option>Commercial</option>
        </select>
      </label>

      <label style="display:block;">
        <span>Buying Timeline</span>
        <select required name="timeline"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
          <option value="">Select</option>
          <option>ASAP (0–30 days)</option>
          <option>1–3 months</option>
          <option>3–6 months</option>
          <option>Just researching</option>
        </select>
      </label>
    </div>

    <label style="display:block; margin-top:12px;">
      <span>Financing</span>
      <select required name="financing"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
        <option value="">Select</option>
        <option>Loan pre-approved</option>
        <option>Loan required</option>
        <option>Self-funded</option>
      </select>
    </label>

    <label style="display:block; margin-top:12px;">
      <span>Anything else?</span>
      <textarea name="notes" rows="3" placeholder="Bedrooms, amenities, exact localities..."
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"></textarea>
    </label>

    <!-- Your existing Google reCAPTCHA v2/v3 widget works with Netlify Forms 
    <div data-netlify-recaptcha="true" style="margin-top:12px;"></div>-->

    <button id="submitBtn" type="submit"
            style="margin-top:14px; width:100%; padding:12px; border:none; border-radius:10px; background:#0e0e0e; color:#fff; font-weight:600; cursor:pointer;">
      Get My Property Matches
    </button>

    <small style="display:block; margin-top:8px; opacity:0.8;">
      By submitting, you agree to be contacted by Tharaga. OTP verification is required to prevent spam.
    </small>
  </form>

  <!-- Invisible reCAPTCHA mount -->
  <div id="otp-recaptcha" style="height:0;"></div>

  <!-- Matches will render here -->
  <div id="aiMatches" style="margin-top:20px;"></div>
</section>

<!-- Firebase SDK (for OTP) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  // ——— Firebase config (keep as-is) ———
  const firebaseConfig = {
    apiKey: "AIzaSyAUNl5bZif51a8b5FC5kKqZs40KlP5lP74",
    authDomain: "tharaga-n.firebaseapp.com",
    projectId: "tharaga-n",
    appId: "1:122537471507:web:346c29119a352cc87059e6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  auth.languageCode = 'en';

  // UTM + referrer capture
  const params = new URLSearchParams(window.location.search);
  document.getElementById('utm_source').value   = params.get('utm_source')   || '';
  document.getElementById('utm_medium').value   = params.get('utm_medium')   || '';
  document.getElementById('utm_campaign').value = params.get('utm_campaign') || '';
  document.getElementById('referrer').value     = document.referrer || '';

  // Elements
  const form              = document.getElementById('buyerForm');
  const phoneInput        = document.getElementById('phone');
  const sendOtpBtn        = document.getElementById('sendOtpBtn');
  const otpBlock          = document.getElementById('otpBlock');
  const verifyOtpBtn      = document.getElementById('verifyOtpBtn');
  const otpStatus         = document.getElementById('otpStatus');
  const submitBtn         = document.getElementById('submitBtn');
  const otpVerifiedField  = document.getElementById('otp_verified');
  const otpInputs         = document.querySelectorAll('.otp-input');

  // reCAPTCHA (lazy init — do NOT call at top-level)
let recaptchaVerifier = null;
async function getRecaptcha() {
  if (!recaptchaVerifier) {
    recaptchaVerifier = new RecaptchaVerifier('otp-recaptcha', { size: 'invisible' }, auth);
    await recaptchaVerifier.render();
  }
  return recaptchaVerifier;
}

  // OTP helpers
  const getEnteredOTP = () => Array.from(otpInputs).map(i => i.value).join('');
  otpInputs.forEach((input, i) => {
    input.addEventListener('input', () => {
      input.value = input.value.replace(/\D/g,'').slice(0,1);
      if (input.value && i < otpInputs.length - 1) otpInputs[i+1].focus();
    });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !input.value && i > 0) otpInputs[i-1].focus();
      if (e.key === 'ArrowLeft'  && i > 0) otpInputs[i-1].focus();
      if (e.key === 'ArrowRight' && i < otpInputs.length-1) otpInputs[i+1].focus();
    });
  });
  otpInputs[0].addEventListener('paste', (e) => {
    const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'').slice(0,6);
    text.split('').forEach((d, idx) => { if (otpInputs[idx]) otpInputs[idx].value = d; });
    e.preventDefault();
    if (text.length === 6) otpInputs[5].focus();
  });

  let confirmationResult = null;

  // Send OTP
  sendOtpBtn.addEventListener('click', async () => {
  const raw = phoneInput.value.trim();
  if (!/^[6-9]\d{9}$/.test(raw)) { alert('Enter a valid 10-digit Indian mobile number.'); return; }

  otpBlock.style.display = 'block';
  otpStatus.textContent = 'Sending OTP…';
  sendOtpBtn.disabled = true;

  try {
    const appVerifier = await getRecaptcha();
    const e164 = '+91' + raw;
    confirmationResult = await signInWithPhoneNumber(auth, e164, appVerifier);
    otpStatus.textContent = 'OTP sent. Please check your SMS.';
  } catch (err) {
  console.error('send OTP error:', err);
  if (err.code === 'auth/too-many-requests') {
    otpStatus.textContent = 'Too many attempts. Please wait a few minutes before retrying.';
  } else if (err.code === 'auth/operation-not-allowed') {
    otpStatus.textContent = 'Phone sign-in is not enabled in Firebase.';
  } else {
    otpStatus.textContent = 'Could not send OTP. Please try again.';
  }
  if (recaptchaVerifier) {
    try {
      const wid = await recaptchaVerifier.render();
      if (window.grecaptcha && wid) window.grecaptcha.reset(wid);
    } catch (_) {}
  }
} finally {
    sendOtpBtn.disabled = false;
  }
});


  // Verify OTP
  verifyOtpBtn.addEventListener('click', async () => {
    try {
      const code = getEnteredOTP();
      if (code.length !== 6) { otpStatus.textContent = 'Please enter all 6 digits.'; return; }
      if (!confirmationResult) { otpStatus.textContent = 'Please click "Send OTP" first.'; return; }
      await confirmationResult.confirm(code);
      otpStatus.textContent = 'Verified ✅';
      otpVerifiedField.value = 'true';
      submitBtn.disabled = false;
      submitBtn.style.cursor = 'pointer';
    } catch (err) {
      console.error('verify error:', err);
      otpStatus.textContent = 'Invalid code. Please try again.';
    }
  });
</script>

<!-- Form validity + OTP gate: disable submit until ready -->
<script type="module">
  const formEl = document.getElementById('buyerForm');
  const submitBtnEl = document.getElementById('submitBtn');
  const otpVerifiedEl = document.getElementById('otp_verified');
  const phoneEl = document.getElementById('phone');
  const verifyOtpBtnEl = document.getElementById('verifyOtpBtn');
  const sendOtpBtnEl = document.getElementById('sendOtpBtn');
  const otpStatusEl = document.getElementById('otpStatus');

  function isFieldsValid(){ try { return formEl.checkValidity(); } catch(_) { return false; } }
  function updateSubmitState(){
    const fieldsOk = isFieldsValid();
    const otpOk = (otpVerifiedEl?.value === 'true');
    const ready = !!(fieldsOk && otpOk);
    if (submitBtnEl){ submitBtnEl.disabled = !ready; submitBtnEl.style.cursor = ready ? 'pointer' : 'not-allowed'; }
  }

  // Initial state — do NOT disable the button hard; rely on validation + OTP state
  updateSubmitState();

  // Re-evaluate on field changes
  const requiredSelectors = [
    '[name="name"]','[name="email"]','[name="phone"]','[name="location"]',
    '[name="budget"]','[name="property_type"]','[name="timeline"]','[name="financing"]'
  ];
  requiredSelectors.forEach((sel)=>{
    const el = formEl.querySelector(sel);
    if (!el) return;
    const evt = (el.tagName === 'SELECT') ? 'change' : 'input';
    el.addEventListener(evt, updateSubmitState);
  });

  // Email-session mismatch notifier
  (function setupEmailNotice(){
    try {
      const emailEl = formEl.querySelector('[name="email"]');
      const noticeEl = document.getElementById('emailNotice');
      if (!emailEl || !noticeEl) return;
      function check(){
        const sessionEmail = emailEl.getAttribute('data-session-email') || '';
        const val = (emailEl.value || '').trim();
        const show = !!(sessionEmail && val && sessionEmail.toLowerCase() !== val.toLowerCase());
        noticeEl.style.display = show ? 'block' : 'none';
      }
      emailEl.addEventListener('input', check);
      emailEl.addEventListener('change', check);
      setTimeout(check, 0);
    } catch(_) {}
  })();

  // If phone changes, require re-verification
  if (phoneEl){
    phoneEl.addEventListener('input', () => {
      try { if (otpVerifiedEl) otpVerifiedEl.value = 'false'; } catch(_) {}
      if (otpStatusEl) otpStatusEl.textContent = '';
      updateSubmitState();
    });
  }

  // When clicking Send OTP, also reset verified flag
  if (sendOtpBtnEl){
    sendOtpBtnEl.addEventListener('click', () => {
      try { if (otpVerifiedEl) otpVerifiedEl.value = 'false'; } catch(_) {}
      updateSubmitState();
    });
  }

  // After Verify OTP click, re-check state (the other script sets otp_verified='true' on success)
  if (verifyOtpBtnEl){ verifyOtpBtnEl.addEventListener('click', () => setTimeout(updateSubmitState, 0)); }

  // Safety: periodic check in case state is changed programmatically
  const intervalId = setInterval(updateSubmitState, 800);
  window.addEventListener('beforeunload', () => { try { clearInterval(intervalId); } catch(_) {} });
</script>

<!-- Supabase + Transformers (browser) + Match + Render -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  import { pipeline }     from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.1/dist/transformers.min.js";

  const embedder = await pipeline(
  "feature-extraction",
  "Xenova/e5-small-v2"
);

  // ——— Paste your Supabase anon config (browser-safe) ———
  const SUPABASE_URL = "https://wedevtjjmdvngyshqdro.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.supabase = supabase;

  // Reuse the same model as ingestion
  const MODEL_ID = 'Xenova/e5-small-v2';
  let extractorPromise = null;
  function getExtractor() {
    if (!extractorPromise) {
      extractorPromise = pipeline('feature-extraction', MODEL_ID, { quantized: true });
    }
    return extractorPromise;
  }
  const mkQuery = (q) => `query: ${q}`;
  const toVectorText = (arr) => `[${arr.map(x => Number(x).toFixed(6)).join(',')}]`;

  // Simple budget → min/max hints (optional)
  function parseBudgetRange(label) {
    if (label.includes('₹50L')) return { min: 5_000_000, max: 10_000_000 };
    if (label.includes('₹1Cr') && label.includes('₹2Cr')) return { min: 10_000_000, max: 20_000_000 };
    if (label.includes('₹2Cr') && label.includes('₹3Cr')) return { min: 20_000_000, max: 30_000_000 };
    if (label.includes('₹3Cr+')) return { min: 30_000_000, max: null };
    return { min: null, max: null };
  }

  const matchForm = document.getElementById('buyerForm');
  const matchSubmitBtn = document.getElementById('submitBtn');
  const matchOtpVerified = document.getElementById('otp_verified');

    // Restore pending form values (if user returned after sign-in)
  (function restorePendingForm(){
    try {
      const saved = sessionStorage.getItem('tharaga_pending_buyer_form');
      if (!saved) return;
      const obj = JSON.parse(saved);
      Object.keys(obj).forEach(k => {
        // prefer matchForm.elements[k] (works for inputs/selects/textareas)
        const el = matchForm.elements[k];
        if (el) {
          try { el.value = obj[k]; } catch (_) {}
        } else {
          // fallback: any element with matching name
          const els = matchForm.querySelectorAll(`[name="${k}"]`);
          if (els && els.length) els.forEach(e => { try { e.value = obj[k]; } catch(_){} });
        }
      });
      // gentle UX hint — only scroll if we can confirm a recent auth return
      const recently = (function(){
        try { const ts = Number(sessionStorage.getItem('tharaga_pending_form_ts')||'0'); return (Date.now() - ts) < 10*60*1000; } catch(_) { return false; }
      })();
      const authSignal = (function(){
        try { const obj = JSON.parse(localStorage.getItem('__tharaga_magic_continue')||'null'); return !!(obj && obj.user && obj.user.email); } catch(_) { return false; }
      })();
      if (recently && authSignal) {
        setTimeout(()=> {
          try {
            matchForm.scrollIntoView({behavior:'smooth', block:'center'});
            const hint = document.createElement('div');
            hint.style.cssText = 'text-align:center;margin:10px 0;color:#666;font-size:13px';
            hint.textContent = 'You returned after signing in. Click "Get My Property Matches" to continue.';
            matchForm.insertBefore(hint, matchForm.firstChild);
          } catch(_){}
        }, 350);
      }
    } catch (e) { console.warn('restore pending form failed', e); }
  })();

  // If another tab/modal signals successful auth, continue to listings if we have pending form
  window.addEventListener('storage', (e) => {
    if (!e?.key) return;
    if (e.key === '__tharaga_magic_continue' || e.key === '__tharaga_magic_confirmed') {
      if (sessionStorage.getItem('tharaga_pending_buyer_form')) {
        // User just logged in; attempt to submit immediately to compute matches then redirect
        setTimeout(async ()=>{
          try {
            const sess = await window.supabase?.auth?.getSession();
            if (!sess?.data?.session?.user) return;
            // Trigger a submit programmatically; native handler will take care of redirect
            try { document.getElementById('submitBtn')?.click(); } catch(_) {}
          } catch(_) {}
        }, 300);
      }
      try {
      const payload = JSON.parse(localStorage.getItem('__tharaga_magic_continue') || 'null');
      if (payload?.user?.email) {
        const hint = document.createElement('div');
        hint.style.cssText = "margin:10px 0;color:#333;font-size:14px;font-weight:500;text-align:center";
        hint.textContent = `Signed in as ${payload.user.email}`;
        document.querySelector("#buyer-intake")?.prepend(hint);
      }
    } catch (err) {
      console.warn("storage handler parse error", err);
    }
  }
});


 // Submit: embed → RPC → render
  matchForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  e.stopPropagation();

  // Check session
  const currentUser = await (window.ensureSupabaseSession?.()) || (await window.supabase?.auth.getSession()).data?.session?.user || null;
  if (!currentUser) {
    // persist current form to restore after auth
    try {
      const f = new FormData(matchForm);
      const obj = Object.fromEntries(f.entries());
      sessionStorage.setItem('tharaga_pending_buyer_form', JSON.stringify(obj));
      sessionStorage.setItem('tharaga_pending_form_ts', String(Date.now()));
    } catch (_) {}

    const nextUrl = location.pathname + location.search;
    const PARENT_ORIGIN = 'https://tharaga.co.in';

    // If this page is embedded inside an iframe, securely ask parent to open the global header/modal
    try {
      if (window.self !== window.parent) {
        const message = { type: 'cta', action: 'openDurableHead', meta: { from: 'feature-iframe', id: 'buyer-form', next: nextUrl, timestamp: Date.now() } };
        window.parent.postMessage(message, PARENT_ORIGIN);
        return;
      }
    } catch(_) {}

    // Open login modal without toggling the header dropdown
    if (window.authGate && typeof window.authGate.openLoginModal === 'function') {
      try { window.authGate.openLoginModal({ next: nextUrl }); return; } catch(_) {}
    }
    if (typeof window.__thgOpenAuthModal === 'function') {
      try { window.__thgOpenAuthModal({ next: nextUrl }); return; } catch(_) {}
    }
    return;
  }

  if (matchOtpVerified.value !== 'true') {
    alert('Please verify OTP first.');
    return;
  }

  matchSubmitBtn.disabled = true;
  matchSubmitBtn.textContent = 'Finding matches…';

  try {
    const f = new FormData(matchForm);
    const payload = Object.fromEntries(f.entries());

    // 1) Build the query text
    const qtext = [
      payload.location || '',
      payload.property_type || '',
      payload.budget || '',
      (payload.notes || '')
    ].filter(Boolean).join(' ').trim();

    // 2) Create embedding in browser
    const extractor = await getExtractor();
    const reps = await extractor([mkQuery(qtext)], { pooling: 'mean', normalize: true });
    const vec = reps.tolist()[0];
    if (!vec || vec.length !== 384) throw new Error(`Bad vector dim: ${vec?.length}`);
    const q_vec_text = toVectorText(vec);

    // 3) Optional: store buyer (skip if table doesn't exist or RLS prevents)
    try {
      await supabase.from('buyers').insert([{
        name: payload.name,
        email: payload.email,
        phone: payload.phone,
        location: payload.location,
        budget: payload.budget,
        property_type: payload.property_type,
        timeline: payload.timeline,
        financing: payload.financing,
        notes: payload.notes || '',
        utm_source: payload.utm_source || '',
        utm_medium: payload.utm_medium || '',
        utm_campaign: payload.utm_campaign || '',
        referrer: payload.referrer || '',
        otp_verified: true
      }]);
    } catch (err) {
      console.error(err);
      alert('Matching failed: ' + (err?.message || err));
    }

    // 4) Derive RPC filters
    const { min: _budget_min, max: _budget_max } = parseBudgetRange(payload.budget || '');
    const _city  = payload.location?.split(',')[0]?.trim() || null;
    const _ptype = payload.property_type || null;

    // 5) Call hybrid RPC (vector text signature)
    const { data, error } = await supabase.rpc('match_candidates_hybrid', {
      q_vec_text,
      _city,
      _ptype,
      _budget_min,
      _budget_max,
      _bedrooms_min: null,
      _bathrooms_min: null,
      _verified_only: false,
      _want_metro: true,
      _k: 20
    });

    if (error) throw error;

    // 6) Store compact matches in sessionStorage (reduce size; keep only fields we need)
    const minimal = (data || []).map(r => ({
      id: r.id,
      title: r.title || r.name || 'Property',
      image: (r.images && r.images[0]) || r.image || null,
      city: r.city || null,
      locality: r.locality || null,
      price_inr: r.price_inr == null ? null : Number(r.price_inr),
      bedrooms: r.bedrooms ?? null,
      bathrooms: r.bathrooms ?? null,
      sem_sim: r.sem_sim ?? r.similarity ?? r.score ?? 0,
      nearest_metro: r.nearest_metro ?? null,
      km_to_metro: r.km_to_metro ?? null
    }));

    // Store search meta too
    const meta = {
      search: {
        location: payload.location || '',
        property_type: payload.property_type || '',
        budget: payload.budget || ''
      },
      created_at: Date.now()
    };

    // Try to save into sessionStorage (works only if both pages share origin)
    try {
      sessionStorage.setItem('tharaga_matches_v1', JSON.stringify({ meta, results: minimal }));
    } catch (e) {
      console.warn('Could not save matches to sessionStorage (size?):', e);
      // keep going; we still redirect via URL params
    }

    // Build query params (lightweight filters) and redirect to listing page
    const params = new URLSearchParams({
      location: payload.location || '',
      property_type: payload.property_type || '',
      budget: payload.budget || ''
    });

    try {
      sessionStorage.removeItem('tharaga_pending_buyer_form');
      sessionStorage.removeItem('tharaga_pending_form_ts');
    } catch(_) {}

    // Redirect to listings page with filters. If embedded, request parent to navigate.
    const listingUrl = '/property-listing/index.html?' + params.toString();
    try {
      if (window.self !== window.top) {
        try {
          const PARENT_ORIGIN = 'https://tharaga.co.in';
          window.parent.postMessage({ type: 'open_listings', url: listingUrl, source: 'buyer-form' }, PARENT_ORIGIN);
        } catch(_) {
          // Fallback if origin-locked: permissive postMessage, then proceed to top redirect
          try { window.parent.postMessage({ type: 'open_listings', url: listingUrl, source: 'buyer-form' }, '*'); } catch(__) {}
        }
        // Also attempt top-level navigation directly (allowed on user activation)
        try { window.top.location.href = listingUrl; return; } catch(__) {}
      }
    } catch(_) {}
    // Top-level page: normal same-tab navigation
    window.location.href = listingUrl;

  } catch (err) {
    console.error(err);
    alert('Matching failed: ' + (err?.message || err));
  } finally {
    // Re-enable button (this runs even though we redirected — harmless)
    matchSubmitBtn.disabled = false;
    matchSubmitBtn.textContent = 'Get My Property Matches';
  }
}); // ✅ now properly closed

// ---------- end replacement ----------


  function renderMatches(rows) {
    const container = document.getElementById('aiMatches');
    container.innerHTML = `<h4 style="text-align:center; margin-bottom:12px;">Your AI Matched Properties</h4>`;
    if (!rows.length) {
      container.innerHTML += `<p style="text-align:center;">No matches yet. Try broadening filters.</p>`;
      return;
    }
    rows.forEach(r => {
      const card = document.createElement('div');
      card.className = 'match-card';
      const loc = [r.city, r.locality].filter(Boolean).join(', ');
      const price = r.price_inr != null ? `₹${r.price_inr}` : '₹N/A';
      const bb = [r.bedrooms && `${r.bedrooms} BR`, r.bathrooms && `${r.bathrooms} BA`].filter(Boolean).join(' · ');
      const metro = r.nearest_metro ? ` • 🚇 ${r.nearest_metro} (${(r.km_to_metro ?? 0).toFixed(1)} km)` : '';
      card.innerHTML = `
        <h5>${r.title || 'Property'}</h5>
        <p>${loc || ''}</p>
        <p>${price} ${bb ? ' • ' + bb : ''}${metro}</p>
        <small>Similarity: ${Number(r.sem_sim).toFixed(3)}</small>
      `;
      container.appendChild(card);
    });
  }
</script>


<!-- Attach gate to submitBtn -->
<script type="module">
let currentUser = null;
const supabaseClient = window.supabase;

async function ensureSupabaseSession() {
  try {
    const client = window.supabase;
    if (!client) return null;

    const sessRes = await client.auth.getSession();
    const sess = sessRes?.data?.session;
    if (sess?.user) return sess.user;

    // no session yet — check for confirmation_url / code in the URL
    const urlParams = new URLSearchParams(window.location.search);
    const confUrl = urlParams.get("confirmation_url") || urlParams.get("access_token") || urlParams.get("code");
    if (confUrl) {
      console.log('ensureSupabaseSession: found conf param:', confUrl);
      try {
        let res = await client.auth.exchangeCodeForSession(confUrl).catch(e => ({ error: e }));
        console.log('exchange (as-is) result:', res);
        if ((res.error || !res.data?.session) && confUrl) {
          let parsed;
          try {
            const u = new URL(confUrl);
            parsed = u.searchParams.get('code') || u.searchParams.get('access_token') || confUrl;
          } catch (_) {
            const m = confUrl.match(/code=([^&]+)/);
            parsed = m ? decodeURIComponent(m[1]) : confUrl;
          }
          if (parsed && parsed !== confUrl) {
            res = await client.auth.exchangeCodeForSession(parsed).catch(e => ({ error: e }));
            console.log('exchange (parsed) result:', res);
          }
        }

        if (!res.error && res.data?.session?.user) {
          const user = res.data.session.user;
          window.history.replaceState({}, document.title, window.location.pathname + window.location.search.replace(/(&|\?)confirmation_url=[^&]+/, ''));
          console.log('ensureSupabaseSession: exchange success for', user.email);
          return user;
        } else {
          console.warn('ensureSupabaseSession: exchange did not create session', res?.error || res);
        }
      } catch (err) {
        console.error('ensureSupabaseSession: exchangeCodeForSession failed', err);
      }
    }

  } catch (e) {
    console.error('ensureSupabaseSession top-level error', e);
  }
  return null;
}
// expose globally for other scripts to call
window.ensureSupabaseSession = ensureSupabaseSession;
// pick up the popup's postMessage if it sends one
window.addEventListener('message', (ev) => {
  try {
    if (!ev?.data) return;
    if (ev.data.type === 'tharaga_verify_clicked') {
      console.log('Received auth postMessage:', ev.data);
      // write to localStorage so the storage handler also triggers (and for parity)
      try {
        localStorage.setItem('__tharaga_magic_continue', JSON.stringify(ev.data));
      } catch (e) { console.warn('Could not write __tharaga_magic_continue', e); }
      // optionally reload to pick up new session
      setTimeout(()=> location.reload(), 250);
    }
  } catch (e) { console.warn('message handler error', e); }
});


document.addEventListener("DOMContentLoaded", async () => {
  const gateForm = document.getElementById('buyerForm');
  const gateSubmitBtn = document.getElementById('submitBtn');
  if (!gateForm || !gateSubmitBtn) return;

  // Capture click BEFORE native form validation runs; open global login if user is not signed in
  gateSubmitBtn.addEventListener('click', async (ev) => {
    // Persist form so the user returns seamlessly after auth
    try {
      const f = new FormData(gateForm);
      const obj = Object.fromEntries(f.entries());
      sessionStorage.setItem('tharaga_pending_buyer_form', JSON.stringify(obj));
      sessionStorage.setItem('tharaga_pending_form_ts', String(Date.now()));
    } catch(_) {}

    // If already logged in, allow normal submit flow
    let loggedIn = false;
    try {
      const sess = await window.supabase?.auth?.getSession();
      loggedIn = !!(sess?.data?.session?.user);
    } catch(_) {}
    if (loggedIn) return;

    // Not logged in — prevent submit and trigger the Durable header auth modal
    ev.preventDefault();
    ev.stopPropagation();
    const nextUrl = location.pathname + location.search;

    // If embedded, ask parent to open the global modal
    try {
      if (window.self !== window.parent) {
        window.parent.postMessage({ type: 'open_login_modal', next: nextUrl }, '*');
        return;
      }
    } catch(_) {}

    // Prefer opening the modal directly to avoid toggling an already-auth dropdown
    if (window.authGate && typeof window.authGate.openLoginModal === 'function') {
      try { window.authGate.openLoginModal({ next: nextUrl }); return; } catch(_) {}
    }
    if (typeof window.__thgOpenAuthModal === 'function') {
      try { window.__thgOpenAuthModal({ next: nextUrl }); return; } catch(_) {}
    }
    // Avoid programmatically clicking the header button entirely
  }, true);
});
</script>


<!-- Seamless auth sync for the submit button: if already signed in, proceed without opening login -->
<script type="module">
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      if (!window.supabase || !window.supabase.auth) {
        const mod = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
        const client = mod.createClient('https://wedevtjjmdvngyshqdro.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M');
        window.supabase = client;
      }
    } catch(_) {}

    try {
      const sess = await window.supabase?.auth?.getSession();
      if (sess?.data?.session?.user) {
        try { window.__authGateLoggedIn = true; } catch(_) {}
        // Autofill email from session into buyer form for consistency with header
        try {
          const user = sess.data.session.user;
          const emailInput = document.querySelector('#buyerForm [name="email"]');
          if (user?.email && emailInput) {
            if (!emailInput.value) emailInput.value = user.email;
            emailInput.setAttribute('data-session-email', user.email);
          }
        } catch(_) {}
      }
    } catch(_) {}
  });
</script>


</body>
</html>