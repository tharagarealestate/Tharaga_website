<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tharaga — Verified homes. Human UX. AI inside.</title>
  <meta name="description" content="Broker‑free, verified properties with AI‑matched discovery, cultural tools for India & NRI, and builder‑grade storytelling."/>
  <script type="module" src="/js/fragment-handle.js"></script>
  <script src="/js/analytics.js" defer></script>
  <script src="/js/home.js" defer></script>
  <!-- Removed globe script; no globe on hero -->
  <link rel="stylesheet" href="/css/brand.css" />
  
  <style>
    :root { --brand:#6e0d25; --brand-600:#8a1637; --ink:#111111; --cream:#f7efe7; --muted:#4b5563; --gold:#d4af37; --ring:rgba(212,175,55,.30); --font-ui:'Manrope',Inter,system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial; --font-display:'Plus Jakarta Sans','Manrope',Inter,system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial; }
    /* Metallic-glass canvas: calm, premium, high-clarity neutrals */
    body { font-family: var(--font-ui); margin:0; padding:0; background:
      radial-gradient(1200px 520px at 12% -10%, rgba(255,255,255,.78), rgba(255,255,255,0) 55%),
      radial-gradient(900px 360px at 95% 0%, rgba(212,175,55,.08), rgba(212,175,55,0) 60%),
      linear-gradient(180deg, #f3f5f8 0%, #edf1f6 36%, #e9edf2 100%);
      color:#000; }
    a { color:#0b63ff; text-decoration:none }
    a:hover { text-decoration:underline }
    header.nav { position:sticky; top:0; z-index:20; color:#fff; backdrop-filter: blur(12px) saturate(1.25); background: linear-gradient(180deg, rgba(110,13,37,.82), rgba(110,13,37,.66)); border-bottom:1px solid rgba(255,255,255,.12) }
    header.nav .inner { max-width:1100px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px; position:relative; padding-right:180px }
    .brand { font-family: var(--font-display); font-weight:800; letter-spacing:.2px; font-size:24px }
    header.nav .brand{ color:#fff }
    header.nav a, header.nav summary{ color:#fff }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #eee; font-size:12px; color:#111 }
    .hero { position:relative; padding:56px 16px 28px; background:
      linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.92)); }
    /* Remove cloudy overlay for a crisp look */
    .hero::before{ content:none }
    /* Ensure darker, high-contrast text inside hero (matches other sections) */
    .hero, .hero .h1, .hero .sub, .hero label{ color:#111 !important }
    .hero .inner { max-width:1100px; margin:0 auto; display:grid; grid-template-columns: 1fr; gap:28px; align-items:center; justify-items:center; text-align:center }
    .h1 { font-family: var(--font-display); font-weight:700; font-size:36px; line-height:1.12; margin:0 0 12px; letter-spacing:.01em; color:#111 }
    .sub { color:#111; opacity:1; font-size:16px; margin:0 0 18px; letter-spacing:.01em }
    .search-card { background:rgba(255,255,255,.72); border:1px solid rgba(110,13,37,.10); border-radius:16px; box-shadow:0 12px 36px rgba(110,13,37,.12); backdrop-filter: blur(12px) saturate(1.05); padding:14px }
    .search-grid { display:grid; grid-template-columns:1.2fr .8fr .8fr auto; gap:10px }
    .chip-row { display:flex; gap:8px; flex-wrap:wrap }
    .chip { padding:8px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-weight:600; font-size:13px }
    .chip[aria-pressed="true"] { background:var(--brand); color:#fff; border-color:var(--brand) }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--brand); background:var(--brand); color:#fff; font-weight:650; transition: background .15s ease, box-shadow .15s ease, transform .15s ease }
    .btn:hover{ background: var(--brand-600); transform: translateY(-1px); box-shadow: 0 8px 18px rgba(110,13,37,.22) }
    .btn.secondary { background:#fff; color:var(--brand) }
    /* Ensure white text on dark surfaces */
    header.nav a, header.nav summary, header.nav .brand { color:#fff }
    /* Header nav additions */
    header.nav nav.row { gap:12px; align-items:center; flex-wrap:nowrap }
    .menu-group{ display:inline-flex; align-items:center; gap:12px }
    .divider{ width:1px; height:16px; background:#e5e7eb; border-radius:1px; display:inline-block }
    details.dropdown{ position:relative }
    details.dropdown > summary{ list-style:none; cursor:pointer; display:inline-flex; align-items:center; gap:6px }
    details.dropdown > summary::-webkit-details-marker{ display:none }
    details.dropdown > summary::after{ content:""; width:0; height:0; border-left:5px solid transparent; border-right:5px solid transparent; border-top:6px solid currentColor; opacity:.8; transition:transform .15s ease }
    details.dropdown[open] > summary::after{ transform:rotate(180deg) }
    details.dropdown .menu{ position:absolute; top:calc(100% + 8px); right:0; min-width:230px; background:#fff; color:#111; border:1px solid #e5e7eb; border-radius:12px; padding:8px; box-shadow:0 12px 30px rgba(0,0,0,.1); z-index:60 }
    details.dropdown .menu a{ display:block; padding:8px 10px; border-radius:8px; color:inherit; text-decoration:none }
    details.dropdown .menu a:hover{ background:#f9fafb }
    /* Make header readable on dark plum */
    header.nav .thg-auth-wrap{ display:flex; align-items:center; gap:12px }
    header.nav .thg-auth-wrap::before{ content:""; display:inline-block; width:1px; height:16px; background:rgba(255,255,255,.22); border-radius:1px }
    header.nav .thg-auth-btn{ background:rgba(255,255,255,.12) !important; color:#fff !important; border-color:rgba(255,255,255,.85) !important }
    header.nav .thg-auth-btn:hover{ background:rgba(255,255,255,.2) !important }
    header.nav .thg-auth-btn.is-auth::after{ border-top-color:#fff !important }
    header.nav .divider{ background:rgba(255,255,255,.18) }
    /* Right-group About | Login */
    header.nav .thg-auth-wrap .about-link{ color:#fff; font-weight:700; text-decoration:none }
    header.nav .thg-auth-wrap .about-link:hover{ text-decoration:underline }
    /* Hide About from main nav across breakpoints; we render it near Login */
    header.nav nav.row a[href="/about/"]{ display:none }
    /* Hidden by default; shown only on mobile */
    .about-mobile-link{ display:none }
    .features { max-width:1100px; margin:26px auto; padding:0 16px; color:#111 }
    .feature-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:14px }
    .card { background:#fff; border:1px solid #f0d9d9; border-radius:16px; box-shadow:0 12px 36px rgba(110,13,37,.1); padding:16px }
    .how { background:linear-gradient(180deg, rgba(110,13,37,.04), rgba(110,13,37,.02)); border-top:1px solid #f2e6e6; border-bottom:1px solid #f2e6e6; }
    .how .inner { max-width:1100px; margin:0 auto; padding:24px 16px; display:grid; grid-template-columns: repeat(3, 1fr); gap:14px }
    .kpi-row { display:flex; gap:14px; flex-wrap:wrap; align-items:center }
    .kpi { font-family: var(--font-display); font-weight:700; font-size:22px }
    .footer { max-width:1100px; margin:0 auto; padding:28px 16px; color:#666; font-size:14px }
    @media (max-width: 880px) {
      .hero .inner { grid-template-columns: 1fr; text-align:center; }
      .search-grid { grid-template-columns: 1fr; }
      .feature-grid { grid-template-columns: 1fr; }
      .how .inner { grid-template-columns: 1fr; }
      /* Mobile header behavior */
      header.nav .inner { padding-right:120px; flex-wrap:wrap; gap:8px }
      .brand { font-size:22px }
      header.nav .inner .row { flex:1 1 100%; justify-content:space-between }
      header.nav nav.row { overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch; gap:10px }
      header.nav nav.row a, header.nav nav.row summary { padding:6px 0 }
      .divider{ height:14px }
      /* Keep header compact on mobile; About is rendered inside auth wrap */
      .about-mobile-link{ display:none }
      /* Mobile header: two-row layout like Zillow/NoBroker */
      header.nav{ display:block }
      header.nav .thg-auth-wrap{ position:absolute; top:10px; right:12px; padding:0 }
      /* Hide trust pill to avoid crowding on small screens */
      #home_pill_trust{ display:none }
      /* Full-width dropdown sheet for Features */
      details.dropdown .menu{ position:fixed; left:12px; right:12px; top:56px; min-width:0; border-radius:12px; }
      details.dropdown .menu a{ padding:12px }
      /* Keep login button aligned with a small divider */
      header.nav .thg-auth-wrap{ gap:10px }
      header.nav .thg-auth-wrap::before{ height:14px }
      /* Mobile typography refinements */
      .h1 { font-size:28px; line-height:1.16 }
      .sub { font-size:15px }
    }

    /* Desktop: vertically center the right-side auth/menu group within header */
    @media (min-width: 881px) {
      header.nav .thg-auth-wrap:not(.is-fixed){ top:50%; transform: translateY(-50%); }
    }

    /* Always suppress legacy About link; using new right-aligned group */
    .about-mobile-link{ display:none !important }

    /* Force plain black headings if any gradient elsewhere */
    .text-gradient{ background:none !important; -webkit-background-clip:initial !important; background-clip:initial !important; color:#111 !important }
    /* Transparent AI art next to hero */
    .ai-hero-figure{ margin:0; width:100%; display:grid; place-items:center; justify-self:center }
    .ai-hero-art{ width:min(520px,95%); height:auto; opacity:.96; filter:drop-shadow(0 18px 40px rgba(110,13,37,.22)); display:block; margin:0 auto; transform:scaleX(-1); }
  </style>

  <!-- Durable Head Code (from snippets/index.html) -->
  <!-- 0) Auto-open on load (optional) -->
  <!-- Default disabled to prevent unexpected login popup on home -->
  <script>window.AUTH_OPEN_ON_LOAD = false;</script>
  <!-- Defensive: clean malformed Durable fragments like #https:/auth... that some hosts prepend -->
  <script>
    (function(){
      try {
        var h = (location.hash||'').trim();
        if (/^#https?:\/+/.test(h)) { history.replaceState(null,'',location.href.replace(location.hash,'')); }
      } catch(_) {}
    })();
  </script>
  <!-- Show header Login/Signup button -->
  <script>window.AUTH_HIDE_HEADER = false;</script>

  <!-- 1) Configure globals BEFORE loading scripts -->
  <script>
    window.AUTH_NAV = { profile: '/profile', dashboard: '/dashboard' };
    // Optional routes:
    // window.AUTH_NAV = { profile: '/account', dashboard: '/app' };
    // window.AUTH_NAV.settings = '/settings';
    window.DURABLE_AUTH_URL = 'https://auth.tharaga.co.in/login_signup_glassdrop/';
    // Optional: auto-open the auth modal on page load
    // window.AUTH_OPEN_ON_LOAD = true; // or use ?auth_open=1
  </script>

  <!-- 2) Load auth-gate (handles iframe auth modal + cross-tab sync) -->
  <script src="https://auth.tharaga.co.in/login_signup_glassdrop/auth-gate.js" defer></script>

  <!-- 4) Inline durable auth header UI (safe to paste into Durable Head Code) -->
  <script>
  // Durable top-right authentication header and modal (Supabase-based)
  // Works standalone when pasted into Durable Head Code
  (function(){
    if (window.__thgAuthInstalledV1) return; window.__thgAuthInstalledV1 = true;

    const AUTH_NAV = Object.assign({ profile: '/profile', dashboard: '/dashboard', settings: null }, window.AUTH_NAV || {});
    const Z_BASE = 2147483000;

    window.authGate = window.authGate || {};
    window.authGate.openLoginModal = function(opts){ (window.__thgOpenAuthModal || function(){ alert('Auth not ready'); })(opts||{}); };

    function ready(fn){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn,{once:true});} else { fn(); } }
    function headerRoot(){ return document.querySelector('header, [role="banner"], [data-section="header"], .site-header, .Header, nav') || null; }
    // Instead of hiding legacy/login links, wire them to open the modal directly
    function hideLegacyAuthLinks(root){
      var scope = (root || document);
      var selector = 'a[href="#login"], a[href="#signup"], [data-auth-open]';
      scope.querySelectorAll(selector).forEach(function(el){
        if (el.__thgAuthWired) return;
        el.__thgAuthWired = true;
        el.addEventListener('click', function(ev){
          try {
            ev.preventDefault();
            // Always open the modal directly; never click the header button, to avoid
            // accidentally toggling the account dropdown when the user is already signed in.
            var next = location.pathname + location.search;
            if (window.authGate && typeof window.authGate.openLoginModal === 'function') {
              window.authGate.openLoginModal({ next });
            } else if (typeof window.__thgOpenAuthModal === 'function') {
              window.__thgOpenAuthModal({ next });
            }
          } catch(_){ }
        }, { passive:false });
      });
    }
    function clamp(str, max){ if (!str) return ''; return str.length>max ? str.slice(0,max-1)+'…' : str; }
    function getInitials(user){
      const meta = user?.user_metadata || {};
      const full = (meta.full_name || meta.name || '').trim();
      if (full) {
        const parts = full.split(/\s+/).filter(Boolean);
        const first = parts[0]?.[0] || '';
        const last = parts.length>1 ? parts[parts.length-1][0] : '';
        return (first+last || first || '').toUpperCase() || 'U';
      }
      const email = (user?.email || '').trim();
      return email ? email[0].toUpperCase() : 'U';
    }
    function getDisplayName(user){
      const meta = user?.user_metadata || {};
      const name = (meta.full_name || meta.name || meta.username || '').trim();
      return name || (user?.email || 'My Account');
    }
    // Keep buyer-form email field in sync with header auth state (same-page or embedded)
    function lockBuyerEmailInBuyerForm(email){
      try {
        const scope = document.getElementById('buyerForm') || document;
        const emailInput = scope && scope.querySelector('#buyerForm [name="email"], form#buyerForm input[name="email"]');
        if (!emailInput) return;
        emailInput.value = email || '';
        emailInput.setAttribute('data-session-email', email || '');
        emailInput.readOnly = true; emailInput.setAttribute('aria-readonly','true');
        emailInput.disabled = true;
        try { emailInput.setAttribute('autocomplete','off'); emailInput.setAttribute('autocapitalize','off'); emailInput.setAttribute('spellcheck','false'); } catch(_){}
        // create/update hidden mirror used for submission
        let hidden = document.getElementById('buyer-email-hidden');
        if (!hidden){ hidden = document.createElement('input'); hidden.type='hidden'; hidden.name='email'; hidden.id='buyer-email-hidden'; emailInput.parentElement && emailInput.parentElement.appendChild(hidden); }
        hidden.value = email || '';
        // prevent duplicate name submission
        if (emailInput.getAttribute('name')) { emailInput.setAttribute('data-original-name','email'); emailInput.removeAttribute('name'); }
      } catch(_){ }
    }
    function unlockBuyerEmailInBuyerForm(){
      try {
        const scope = document.getElementById('buyerForm') || document;
        const emailInput = scope && scope.querySelector('#buyerForm [data-session-email], form#buyerForm input[aria-readonly]');
        if (!emailInput) return;
        try { emailInput.readOnly = false; emailInput.disabled = false; emailInput.removeAttribute('aria-readonly'); emailInput.removeAttribute('data-session-email'); } catch(_){}
        try { if (!emailInput.getAttribute('name')) emailInput.setAttribute('name', emailInput.getAttribute('data-original-name') || 'email'); } catch(_){}
        const hidden = document.getElementById('buyer-email-hidden'); if (hidden && hidden.parentElement) hidden.parentElement.removeChild(hidden);
      } catch(_){ }
    }
    function setBuyerEmailLockFromUser(user){
      try { if (user && user.email) lockBuyerEmailInBuyerForm(user.email); else unlockBuyerEmailInBuyerForm(); } catch(_){}
    }
    function createEl(tag, cls, attrs){ const el = document.createElement(tag); if (cls) el.className = cls; if (attrs) for (var k in attrs) el.setAttribute(k, attrs[k]); return el; }
    function validateEmail(val){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val); }
    function ensureContainer(){
      let hdr = headerRoot();
      let wrap = document.querySelector('.thg-auth-wrap');
      if (!wrap){
        wrap = document.createElement('div');
        wrap.className = 'thg-auth-wrap';
        let parent = hdr || document.body;
        if (hdr) { const cs = getComputedStyle(hdr); if (cs.position === 'static') { hdr.style.position = 'relative'; } parent.appendChild(wrap); }
        else { wrap.classList.add('is-fixed'); parent.appendChild(wrap); }
      }
      return wrap;
    }

    function injectStyles(){
      if (document.getElementById('thg-auth-styles')) return;
      const css = `
.thg-auth-wrap{ position:absolute; top:14px; right:16px; display:flex; align-items:center; z-index:${Z_BASE}; }
@media (min-width:1024px){ .thg-auth-wrap{ top:16px; right:24px; } }
.thg-auth-wrap.is-fixed{ position:fixed; top:14px; right:16px; }

/* Header button */
.thg-auth-btn{ appearance:none;background:transparent;color:#fff;border:1px solid rgba(255,255,255,.9); border-radius:9999px;padding:8px 14px;font-weight:600;cursor:pointer;line-height:1;white-space:nowrap;display:inline-flex;align-items:center;gap:8px; transition:background .15s ease, border-color .15s ease, box-shadow .15s ease; }
.thg-auth-btn:hover{background:rgba(255,255,255,.08)}
.thg-auth-btn:focus-visible{ outline:2px solid #7dd3fc; outline-offset:2px; }
.thg-auth-btn .thg-initial{ width:22px;height:22px;border-radius:9999px;background:#fff;color:#111;display:none;align-items:center;justify-content:center;font-weight:700;font-size:11px; }
.thg-auth-btn.is-auth .thg-initial{ display:inline-flex; }
.thg-auth-btn.is-auth::after{ content:""; display:inline-block; width:0; height:0; border-left:5px solid transparent; border-right:5px solid transparent; border-top:6px solid rgba(255,255,255,.9); transition:transform .15s ease; transform-origin:center; }
.thg-auth-btn[aria-expanded="true"].is-auth::after{ transform:rotate(180deg); }
.thg-spinner{ width:14px;height:14px;border-radius:9999px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff; animation:thgspin .8s linear infinite; }
@keyframes thgspin{ to{ transform:rotate(360deg); } }

/* Account menu */
.thg-auth-menu{ position:absolute;top:calc(100% + 10px);right:0;min-width:280px;background:#0b0b0b;color:#fff; border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;box-shadow:0 12px 30px rgba(0,0,0,.45); visibility:hidden; opacity:0; transform:translateY(-6px) scale(.98); transform-origin:top right; pointer-events:none; transition:opacity .16s ease, transform .16s ease, visibility 0s linear .16s; z-index:${Z_BASE+1}; }
.thg-auth-menu[aria-hidden="false"]{ visibility:visible; opacity:1; transform:translateY(0) scale(1); pointer-events:auto; transition:opacity .16s ease, transform .16s ease, visibility 0s linear 0s; }
.thg-auth-item{ display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;text-decoration:none;color:#fff;cursor:pointer; }
.thg-auth-item:hover{background:rgba(255,255,255,.08)}
.thg-auth-item[tabindex]{outline:none}
.thg-auth-item.is-header{ cursor:default;font-weight:700;opacity:.95; }
.thg-auth-item.is-header:hover{background:transparent}
.thg-auth-sep{ height:1px;background:rgba(255,255,255,.12);margin:6px 8px;border-radius:1px; }
.thg-initial-lg{ width:28px;height:28px;border-radius:9999px;background:#fff;color:#111;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:12px; }
.thg-name-wrap{ display:flex; flex-direction:column; min-width:0; }
.thg-name{ overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:190px; }
.thg-email{ opacity:.7; font-size:12px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap; max-width:200px; }

/* Modal */
.thg-auth-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter:saturate(140%) blur(6px); display:flex; align-items:center; justify-content:center; z-index:${Z_BASE+2}; visibility:hidden; opacity:0; transition:opacity .18s ease, visibility 0s linear .18s; }
.thg-auth-overlay[aria-hidden="false"]{ visibility:visible; opacity:1; transition:opacity .18s ease, visibility 0s linear 0s; }
.thg-auth-modal{ width:100%; max-width:420px; background:linear-gradient(180deg, rgba(20,20,20,.98), rgba(12,12,12,.98)); color:#fff; border:1px solid rgba(255,255,255,.1); border-radius:16px; box-shadow:0 30px 60px rgba(0,0,0,.5); transform:translateY(10px) scale(.98); opacity:0; transition:transform .18s ease, opacity .18s ease; }
.thg-auth-overlay[aria-hidden="false"] .thg-auth-modal{ transform:translateY(0) scale(1); opacity:1; }
.thg-auth-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.08); }
.thg-auth-title{ font-weight:800; font-size:20px; }
.thg-auth-close{ appearance:none; background:linear-gradient(180deg,#f3cd4a,#eab308,#c58a04); border:0; color:#111; cursor:pointer; font-weight:800; width:32px; height:32px; line-height:32px; border-radius:9999px; box-shadow:0 2px 6px rgba(0,0,0,.25); }
.thg-auth-close:hover{ color:#fff; background:linear-gradient(180deg,#eab308,#c58a04,#7a5200); transform:scale(1.06); }
.thg-auth-body{ padding:16px 18px 18px; }

/* Tabs */
.thg-tabs{ display:flex; gap:6px; background:rgba(255,255,255,.06); padding:4px; border-radius:9999px; margin-bottom:16px; }
.thg-tab{ flex:1; text-align:center; padding:8px 10px; border-radius:9999px; cursor:pointer; font-weight:700; color:#ddd; }
.thg-tab[aria-selected="true"]{ background:#fff; color:#111; }

/* Fields */
.thg-field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
.thg-field label{ font-size:12px; opacity:.9; }
.thg-field label[for="thg-si-password"]::after{ content:" (optional — use Magic Link for fastest login)"; color:#9ca3af; font-weight:500; }
.thg-input{ appearance:none; background:#121212; color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px; }
.thg-input::placeholder{ color:#6b7280; }
.thg-input:focus{ outline:2px solid #facc15; outline-offset:2px; }

/* Actions and links */
.thg-actions{ display:flex; justify-content:space-between; align-items:center; margin:6px 0 12px; }
.thg-link{ background:none; border:0; color:#22c55e; cursor:pointer; font-size:13px; padding:0; }

/* Primary CTA (yellow) */
.thg-btn-primary{ width:100%; appearance:none; background:linear-gradient(180deg,#f8d34a,#f0b90b,#c89200); color:#111; border:1px solid rgba(250, 204, 21, .9); border-radius:12px; padding:12px 14px; font-weight:800; cursor:pointer; transition:transform .06s ease, box-shadow .06s ease, filter .12s ease; box-shadow:0 4px 0 rgba(250, 204, 21, .35); }
.thg-btn-primary:hover{ filter:brightness(1.03); }
.thg-btn-primary:active{ transform:translateY(1px); box-shadow:none; }

/* OAuth / secondary buttons */
.thg-oauth{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
.thg-oauth-btn{ appearance:none; background:#0f0f0f; color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:12px 14px; cursor:pointer; font-weight:800; display:flex; align-items:center; justify-content:center; gap:10px; }
.thg-oauth-btn:hover{ background:#141414; }
.thg-oauth-btn .g-icon{ width:18px; height:18px; }
.thg-oauth-btn.google{ border-color:#333; background:#151515; }

/* Errors, hints, loading */
.thg-error{ background:rgba(239,68,68,.12); color:#fecaca; border:1px solid rgba(239,68,68,.35); border-radius:10px; padding:10px 12px; font-size:13px; display:none; }
.thg-hint{ font-size:12px; opacity:.8; }
.thg-loading-bar{ height:2px; width:0; background:#7dd3fc; border-radius:2px; transition:width .2s ease; }

/* Confirm dialog */
.thg-confirm{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:${Z_BASE+3}; background:rgba(0,0,0,.55); backdrop-filter:blur(3px); visibility:hidden; opacity:0; transition:opacity .16s ease, visibility 0s linear .16s; }
.thg-confirm[aria-hidden="false"]{ visibility:visible; opacity:1; transition:opacity .16s ease, visibility 0s linear 0s; }
.thg-confirm-card{ width:100%; max-width:360px; background:#141414; color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:16px; box-shadow:0 24px 50px rgba(0,0,0,.5); }
.thg-confirm-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
.thg-btn{ appearance:none; border-radius:10px; padding:8px 12px; cursor:pointer; border:1px solid rgba(255,255,255,.15); background:#0f0f0f; color:#fff; }
.thg-btn-danger{ background:#ef4444; border-color:#ef4444; color:#fff; }

/* Responsive */
@media (max-width:480px){
  .thg-auth-wrap{ top:10px; right:10px; }
  .thg-auth-modal{ width:calc(100% - 16px); margin:0 8px; }
  .thg-auth-menu{ right:8px; }
}

/* tagline styling */
.thg-tagline{ color:#9ca3af; font-size:13px; margin:-4px 0 12px; }
`;
      const style = document.createElement('style');
      style.id = 'thg-auth-styles';
      style.textContent = css;
      document.head.appendChild(style);
    }

    function createUI(){
      const wrap = ensureContainer();
      // Ensure About | divider appears before the Login/Signup button
      let about = wrap.querySelector('a.about-link');
      if (!about){
        about = createEl('a', 'about-link', { href:'/about/', 'aria-label':'About Tharaga' });
        about.textContent = 'About';
        // Insert About at the start of the group
        wrap.appendChild(about);
        const sep = createEl('span','divider',{'aria-hidden':'true'});
        wrap.appendChild(sep);
      }
      let btn = wrap.querySelector('.thg-auth-btn');
      if (!btn){
        btn = createEl('button', 'thg-auth-btn', { type:'button', 'aria-haspopup':'menu', 'aria-expanded':'false', 'aria-label':'Open account menu' });
        const avatar = createEl('span', 'thg-initial');
        avatar.textContent = 'U';
        const label = document.createElement('span');
        label.className = 'thg-label';
        const spinner = createEl('span','thg-spinner',{'aria-hidden':'true'});
        btn.appendChild(avatar); btn.appendChild(label); btn.appendChild(spinner);
        wrap.appendChild(btn);
      }

      let menu = wrap.querySelector('.thg-auth-menu');
      if (!menu){
        menu = createEl('div', 'thg-auth-menu', { id:'thg-auth-menu', role:'menu', 'aria-hidden':'true' });
        menu.innerHTML = '<div class="thg-auth-item is-header" aria-disabled="true">' +
          '<span class="thg-initial-lg">U</span>' +
          '<span class="thg-name-wrap">' +
          '<span class="thg-name">User</span>' +
          '<span class="thg-email">email@example.com</span>' +
          '</span>' +
          '</div>' +
          '<div class="thg-auth-sep"></div>' +
          '<div class="thg-auth-item" role="menuitem" tabindex="0" data-action="profile"><span>Profile</span></div>' +
          '<div class="thg-auth-item" role="menuitem" tabindex="0" data-action="dashboard"><span>Dashboard</span></div>' +
          (AUTH_NAV.settings ? '<div class="thg-auth-item" role="menuitem" tabindex="0" data-action="settings"><span>Settings</span></div>' : '') +
          '<div class="thg-auth-item" role="menuitem" tabindex="0" data-action="logout"><span>Logout</span></div>';
        wrap.appendChild(menu);
      }
      btn.setAttribute('aria-controls','thg-auth-menu');

      let overlay = document.querySelector('.thg-auth-overlay');
      if (!overlay){
        overlay = createEl('div','thg-auth-overlay',{'aria-hidden':'true','aria-modal':'true','role':'dialog'});
        overlay.innerHTML = `
          <div class="thg-auth-modal" role="document" aria-labelledby="thg-auth-title">
            <div class="thg-auth-header">
              <div class="thg-auth-title" id="thg-auth-title">Sign in</div>
              <button class="thg-auth-close" type="button" aria-label="Close">✕</button>
            </div>
            <div class="thg-loading-bar" aria-hidden="true"></div>
            <div class="thg-auth-body">
              <div class="thg-tagline">"Browse only approved builder projects — safe, transparent, and verified"</div>
              <div class="thg-tabs" role="tablist" aria-label="Authentication method">
                <button class="thg-tab" role="tab" id="thg-tab-signin" aria-controls="thg-panel-signin" aria-selected="true">Sign in</button>
                <button class="thg-tab" role="tab" id="thg-tab-signup" aria-controls="thg-panel-signup" aria-selected="false">Create account</button>
              </div>
              <div class="thg-error" role="alert"></div>
              <div id="thg-panel-signin" role="tabpanel" aria-labelledby="thg-tab-signin">
                <div class="thg-field"><label for="thg-si-email">Email</label><input id="thg-si-email" class="thg-input" type="email" autocomplete="email" placeholder="you@example.com" /></div>
                <div class="thg-field"><label for="thg-si-password">Password</label><input id="thg-si-password" class="thg-input" type="password" autocomplete="current-password" placeholder="Your password" /></div>
                <div class="thg-actions"><button class="thg-link" type="button" id="thg-forgot">Forgot password?</button><span class="thg-hint"></span></div>
                <button class="thg-btn-primary" type="button" id="thg-signin-btn">Sign in</button>
                <div class="thg-oauth"><button class="thg-oauth-btn google" type="button" data-provider="google"><svg class="g-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" aria-hidden="true"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.2 32.6 29 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 6 1.2 8.1 3.2l5.7-5.7C34.6 6.1 29.6 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c10 0 19-7.3 19-20 0-1.3-.1-2.7-.4-3.5z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.5 16.6 18.9 14 24 14c3.1 0 6 1.2 8.1 3.2l5.7-5.7C34.6 6.1 29.6 4 24 4c-7.7 0-14.3 4.3-17.7 10.7z"/><path fill="#4CAF50" d="M24 44c5 0 9.6-1.9 13-5.1l-6-5.1C29.9 35.6 27.1 36 24 36c-5 0-9.3-3.4-10.8-8l-6.7 5.1C10 40.2 16.5 44 24 44z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.3 3.1-4.6 8-11.3 8-5 0-9.3-3.4-10.8-8l-6.7 5.1C10 40.2 16.5 44 24 44z"/></svg><span>Continue with Google</span></button></div>
              </div>
              <div id="thg-panel-signup" role="tabpanel" aria-labelledby="thg-tab-signup" hidden>
                <div class="thg-field"><label for="thg-su-name">Full name (optional)</label><input id="thg-su-name" class="thg-input" type="text" autocomplete="name" placeholder="Ada Lovelace" /></div>
                <div class="thg-field"><label for="thg-su-email">Email</label><input id="thg-su-email" class="thg-input" type="email" autocomplete="email" placeholder="you@example.com" /></div>
                <div class="thg-field"><label for="thg-su-password">Password</label><input id="thg-su-password" class="thg-input" type="password" autocomplete="new-password" placeholder="At least 8 characters" /></div>
                <div class="thg-actions"><span class="thg-hint">Use a strong password. You can add name later.</span></div>
                <button class="thg-btn-primary" type="button" id="thg-signup-btn">Create account</button>
                <div class="thg-oauth"><button class="thg-oauth-btn google" type="button" data-provider="google"><svg class="g-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" aria-hidden="true"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.2 32.6 29 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 6 1.2 8.1 3.2l5.7-5.7C34.6 6.1 29.6 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c10 0 19-7.3 19-20 0-1.3-.1-2.7-.4-3.5z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.5 16.6 18.9 14 24 14c3.1 0 6 1.2 8.1 3.2l5.7-5.7C34.6 6.1 29.6 4 24 4c-7.7 0-14.3 4.3-17.7 10.7z"/><path fill="#4CAF50" d="M24 44c5 0 9.6-1.9 13-5.1l-6-5.1C29.9 35.6 27.1 36 24 36c-5 0-9.3-3.4-10.8-8l-6.7 5.1C10 40.2 16.5 44 24 44z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.3 3.1-4.6 8-11.3 8-5 0-9.3-3.4-10.8-8l-6.7 5.1C10 40.2 16.5 44 24 44z"/></svg><span>Sign up with Google</span></button></div>
              </div>
              <div id="thg-panel-reset" role="tabpanel" aria-labelledby="thg-tab-reset" hidden>
                <div class="thg-field"><label for="thg-rp-email">Email</label><input id="thg-rp-email" class="thg-input" type="email" autocomplete="email" placeholder="you@example.com" /></div>
                <div class="thg-actions"><span class="thg-hint">We’ll email a password reset link.</span></div>
                <button class="thg-btn-primary" type="button" id="thg-reset-btn">Send reset link</button>
              </div>
              <div id="thg-panel-update" role="tabpanel" aria-labelledby="thg-tab-update" hidden>
                <div class="thg-field"><label for="thg-up-password">New password</label><input id="thg-up-password" class="thg-input" type="password" autocomplete="new-password" placeholder="Enter a new password" /></div>
                <div class="thg-actions"><span class="thg-hint">You’re recovering your account.</span></div>
                <button class="thg-btn-primary" type="button" id="thg-update-btn">Update password</button>
              </div>
            </div>
          </div>`;
        document.body.appendChild(overlay);
      }

      let confirmEl = document.querySelector('.thg-confirm');
      if (!confirmEl){
        confirmEl = createEl('div','thg-confirm',{'aria-hidden':'true','role':'dialog','aria-modal':'true'});
        confirmEl.innerHTML = '<div class="thg-confirm-card" role="document">' +
          '<div class="thg-confirm-msg">Are you sure you want to log out?</div>' +
          '<div class="thg-confirm-actions">' +
          '<button type="button" class="thg-btn thg-confirm-cancel">Cancel</button>' +
          '<button type="button" class="thg-btn thg-btn-danger thg-confirm-ok">Log out</button>' +
          '</div></div>';
        document.body.appendChild(confirmEl);
      }

      // Respect global flag to hide the header button completely
      try {
        if (window.AUTH_HIDE_HEADER === true || window.AUTH_NO_HEADER === true) {
          if (wrap) wrap.style.display = 'none';
        }
      } catch(_){ }
      return { wrap, btn, menu, overlay, confirmEl };
    }

    const state = { user: null, loading: true, nextUrl: null, supabaseReady: false, sub: null };

    function setButtonLoading(ui, isLoading){ const spinner = ui.btn.querySelector('.thg-spinner'); const label = ui.btn.querySelector('.thg-label'); if (isLoading){ ui.btn.classList.remove('is-auth'); if (label) label.textContent = 'Loading…'; if (spinner) spinner.style.display = 'inline-block'; ui.btn.setAttribute('aria-expanded','false'); } else { if (spinner) spinner.style.display = 'none'; } }

    function render(ui){
      const label = ui.btn.querySelector('.thg-label');
      const avatar = ui.btn.querySelector('.thg-initial');
      if (state.loading){ setButtonLoading(ui, true); return; }
      setButtonLoading(ui, false);
      if (state.user && state.user.email){
        const name = getDisplayName(state.user);
        ui.btn.classList.add('is-auth');
        avatar.textContent = getInitials(state.user);
        label.textContent = clamp(name, 24);
        ui.btn.prepend(avatar);
        const initEl = ui.menu.querySelector('.thg-initial-lg');
        const nameEl = ui.menu.querySelector('.thg-name');
        const emailEl = ui.menu.querySelector('.thg-email');
        if (initEl) initEl.textContent = getInitials(state.user);
        if (nameEl) nameEl.textContent = clamp(name, 28);
        if (emailEl) emailEl.textContent = clamp(state.user.email || '', 30);
      } else {
        ui.btn.classList.remove('is-auth');
        ui.btn.setAttribute('aria-expanded','false');
        label.textContent = 'Login / Signup';
        avatar.textContent = 'U';
        ui.btn.prepend(avatar);
        closeMenu(ui);
      }
    }

    function openMenu(ui){ if (!state.user) return; ui.menu.setAttribute('aria-hidden','false'); ui.btn.setAttribute('aria-expanded','true'); const items = ui.menu.querySelectorAll('.thg-auth-item[role="menuitem"]'); if (items[0]) setTimeout(function(){ items[0].focus(); }, 0); }
    function closeMenu(ui){ ui.menu.setAttribute('aria-hidden','true'); ui.btn.setAttribute('aria-expanded','false'); }
    function toggleMenu(ui){ const isHidden = ui.menu.getAttribute('aria-hidden') === 'true'; if (isHidden) openMenu(ui); else closeMenu(ui); }

    function showError(uiOverlay, msg){ const el = uiOverlay.querySelector('.thg-error'); if (!el) return; el.textContent = msg; el.style.display = 'block'; }
    function clearError(uiOverlay){ const el = uiOverlay.querySelector('.thg-error'); if (!el) return; el.textContent = ''; el.style.display = 'none'; }
    function setModalLoading(uiOverlay, loading){ const bar = uiOverlay.querySelector('.thg-loading-bar'); if (!bar) return; if (loading){ bar.style.width = '75%'; } else { bar.style.width = '0'; } }
    function showPanel(uiOverlay, id, title){ ['signin','signup','reset','update'].forEach(function(key){ const panel = uiOverlay.querySelector('#thg-panel-'+key); if (panel) panel.hidden = (key !== id); }); const tEl = uiOverlay.querySelector('#thg-auth-title'); if (tEl) tEl.textContent = title; clearError(uiOverlay); }
    function openAuthModal(ui, opts){ state.nextUrl = opts?.next || null; ui.overlay.setAttribute('aria-hidden','false'); showPanel(ui.overlay, 'signin', 'Sign in'); setTimeout(function(){ const el = ui.overlay.querySelector('#thg-si-email'); if (el) el.focus(); }, 0); }
    function closeAuthModal(ui){ ui.overlay.setAttribute('aria-hidden','true'); }
    function openConfirm(ui){ ui.confirmEl.setAttribute('aria-hidden','false'); }
    // Broadcast current auth state (email only) to child iframes, sibling tabs, and embedded forms
    function broadcastAuth(user){
      var loggedIn = !!(user && user.email);
      try { window.__authGateLoggedIn = loggedIn; } catch(_) {}
      try {
        localStorage.setItem('__tharaga_magic_continue', JSON.stringify({ user: loggedIn ? { email: user.email } : null, ts: Date.now() }));
      } catch(_) {}
      try {
        var evtType = loggedIn ? 'THARAGA_AUTH_SUCCESS' : 'THARAGA_AUTH_SIGNED_OUT';
        if ('BroadcastChannel' in window){
          window.__thgAuthBC = window.__thgAuthBC || new BroadcastChannel('tharaga-auth');
          window.__thgAuthBC.postMessage(loggedIn ? { type: evtType, user: { email: user.email } } : { type: evtType });
        }
      } catch(_) {}
      try {
        var payload = loggedIn ? { type: 'THARAGA_AUTH_SUCCESS', user: { email: user.email } } : { type: 'THARAGA_AUTH_SIGNED_OUT' };
        // Notify any embedded iframes (cross-origin safe via postMessage)
        var iframes = document.querySelectorAll('iframe');
        for (var i=0;i<iframes.length;i++){
          try { iframes[i].contentWindow && iframes[i].contentWindow.postMessage(payload, '*'); } catch(__) {}
        }
        // If this page itself is inside an iframe, also notify parent
        try { if (window.parent && window.parent !== window) window.parent.postMessage(payload, '*'); } catch(__) {}
      } catch(_) {}
    }
    function closeConfirm(ui){ ui.confirmEl.setAttribute('aria-hidden','true'); }

    function bindUI(ui){
      ui.btn.addEventListener('click', function(e){ e.preventDefault(); if (state.user && state.user.email){ toggleMenu(ui); } else { openAuthModal(ui, { next: location.pathname + location.search }); } });
      ui.btn.addEventListener('keydown', function(e){ if ((e.key === 'ArrowDown' || e.key === 'Enter') && state.user && state.user.email){ e.preventDefault(); openMenu(ui); } });
      ui.menu.addEventListener('click', function(e){ const item = e.target.closest('.thg-auth-item[role="menuitem"]'); if (!item) return; const act = item.getAttribute('data-action'); if (act === 'profile'){ closeMenu(ui); location.href = AUTH_NAV.profile; return; } if (act === 'dashboard'){ closeMenu(ui); location.href = AUTH_NAV.dashboard; return; } if (act === 'settings' && AUTH_NAV.settings){ closeMenu(ui); location.href = AUTH_NAV.settings; return; } if (act === 'logout'){ closeMenu(ui); openConfirm(ui); } });
      ui.menu.addEventListener('keydown', function(e){ if (e.key === 'Escape'){ e.preventDefault(); closeMenu(ui); ui.btn.focus(); return; } if (['ArrowDown','ArrowUp','Home','End'].indexOf(e.key) === -1) return; e.preventDefault(); const items = Array.prototype.slice.call(ui.menu.querySelectorAll('.thg-auth-item[role="menuitem"]')); const idx = items.indexOf(document.activeElement); if (!items.length) return; if (e.key === 'Home'){ items[0].focus(); return; } if (e.key === 'End'){ items[items.length - 1].focus(); return; } const next = e.key === 'ArrowDown' ? (idx + 1 + items.length) % items.length : (idx - 1 + items.length) % items.length; items[next].focus(); });
      document.addEventListener('click', function(e){ if (ui.menu.getAttribute('aria-hidden') === 'true') return; if (!ui.menu.contains(e.target) && e.target !== ui.btn && !ui.btn.contains(e.target)){ closeMenu(ui); } });
      const tabSignIn = ui.overlay.querySelector('#thg-tab-signin');
      const tabSignUp = ui.overlay.querySelector('#thg-tab-signup');
      function selectTab(which){ const a = which==='signin'; tabSignIn.setAttribute('aria-selected', a ? 'true' : 'false'); tabSignUp.setAttribute('aria-selected', a ? 'false' : 'true'); showPanel(ui.overlay, a ? 'signin' : 'signup', a ? 'Sign in' : 'Create account'); const first = ui.overlay.querySelector(a ? '#thg-si-email' : '#thg-su-name'); if (first) first.focus(); }
      tabSignIn.addEventListener('click', function(){ selectTab('signin'); });
      tabSignUp.addEventListener('click', function(){ selectTab('signup'); });
      ui.overlay.addEventListener('click', function(e){ if (e.target === ui.overlay) closeAuthModal(ui); });
      ui.overlay.querySelector('.thg-auth-close').addEventListener('click', function(){ closeAuthModal(ui); });
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && ui.overlay.getAttribute('aria-hidden') === 'false') closeAuthModal(ui); });
      const forgotBtn = ui.overlay.querySelector('#thg-forgot');
      forgotBtn.addEventListener('click', function(){ showPanel(ui.overlay, 'reset', 'Reset password'); const el = ui.overlay.querySelector('#thg-rp-email'); const source = ui.overlay.querySelector('#thg-si-email'); if (source && el && source.value) el.value = source.value; if (el) el.focus(); });
      ui.overlay.querySelector('#thg-signin-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const email = ui.overlay.querySelector('#thg-si-email').value.trim(); const password = ui.overlay.querySelector('#thg-si-password').value; if (!validateEmail(email)) { showError(ui.overlay, 'Enter a valid email.'); return; } if (!password || password.length < 6) { showError(ui.overlay, 'Enter your password.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const { error } = await window.supabase.auth.signInWithPassword({ email, password }); if (error) { showError(ui.overlay, error.message || 'Failed to sign in.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
      ui.overlay.querySelector('#thg-signup-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const name = ui.overlay.querySelector('#thg-su-name').value.trim(); const email = ui.overlay.querySelector('#thg-su-email').value.trim(); const password = ui.overlay.querySelector('#thg-su-password').value; if (!validateEmail(email)) { showError(ui.overlay, 'Enter a valid email.'); return; } if (!password || password.length < 8) { showError(ui.overlay, 'Password must be at least 8 characters.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const { error } = await window.supabase.auth.signUp({ email, password, options: { data: name ? { full_name: name } : {} } }); if (error) { showError(ui.overlay, error.message || 'Failed to create account.'); } else { showError(ui.overlay, 'Check your email to verify your account.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
      ui.overlay.querySelectorAll('.thg-oauth-btn').forEach(function(btn){ btn.addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const provider = btn.getAttribute('data-provider'); clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const redirectTo = location.origin + location.pathname + location.search; const { data, error } = await window.supabase.auth.signInWithOAuth({ provider, options: { redirectTo, skipBrowserRedirect: true, queryParams: { prompt: 'select_account' } } }); if (error) { const msg = /provider is not enabled/i.test(error.message||'') ? 'Google sign-in is not available yet.' : (error.message || 'Could not start sign in.'); showError(ui.overlay, msg); setModalLoading(ui.overlay, false); return; } if (data && data.url){ location.href = data.url; } else { setModalLoading(ui.overlay, false); showError(ui.overlay, 'Could not start ' + provider + ' sign in.'); } } catch(ex){ showError(ui.overlay, 'Failed to start ' + provider + ' sign in.'); setModalLoading(ui.overlay, false); } }); });
      ui.overlay.querySelector('#thg-reset-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const email = ui.overlay.querySelector('#thg-rp-email').value.trim(); if (!validateEmail(email)) { showError(ui.overlay, 'Enter a valid email.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const redirectTo = location.origin + location.pathname + location.search; const { error } = await window.supabase.auth.resetPasswordForEmail(email, { redirectTo }); if (error) { showError(ui.overlay, error.message || 'Failed to send reset link.'); } else { showError(ui.overlay, 'Reset link sent. Check your email.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
      ui.overlay.querySelector('#thg-update-btn').addEventListener('click', async function(){ if (!state.supabaseReady){ showError(ui.overlay, 'Authentication is not initialized.'); return; } const password = ui.overlay.querySelector('#thg-up-password').value; if (!password || password.length < 8) { showError(ui.overlay, 'Password must be at least 8 characters.'); return; } clearError(ui.overlay); setModalLoading(ui.overlay, true); try{ const { error } = await window.supabase.auth.updateUser({ password }); if (error) { showError(ui.overlay, error.message || 'Failed to update password.'); } else { showPanel(ui.overlay, 'signin', 'Sign in'); showError(ui.overlay, 'Password updated. Please sign in.'); } } catch(ex){ showError(ui.overlay, 'Network error. Please try again.'); } finally { setModalLoading(ui.overlay, false); } });
      ui.confirmEl.querySelector('.thg-confirm-cancel').addEventListener('click', function(){ closeConfirm(ui); });
      ui.confirmEl.addEventListener('click', function(e){ if (e.target === ui.confirmEl) closeConfirm(ui); });
      ui.confirmEl.querySelector('.thg-confirm-ok').addEventListener('click', async function(){
        try { await window.supabase?.auth?.signOut?.(); } catch(_){ }
        // Proactively broadcast sign-out so embedded forms unlock immediately
        try { broadcastAuth(null); } catch(_){ }
        closeConfirm(ui);
      });
      window.__thgOpenAuthModal = function(opts){ openAuthModal(ui, opts); };
      // Expose a helper to programmatically open the auth modal (never toggles dropdown)
      window.authGate.triggerHeaderLogin = function(opts){
        try { openAuthModal(ui, opts||{ next: location.pathname + location.search }); }
        catch(_){ try { window.__thgOpenAuthModal && window.__thgOpenAuthModal(opts||{ next: location.pathname + location.search }); } catch(__){} }
      };
    }

    async function initSupabase(ui){
      state.loading = true; render(ui);
      if (!window.supabase || !window.supabase.auth){
        try {
          const mod = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
          const client = mod.createClient('https://wedevtjjmdvngyshqdro.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M');
          window.supabase = client;
        } catch(_) {}
      }
      if (!window.supabase || !window.supabase.auth){ state.supabaseReady = false; state.loading = false; render( ui); console.warn('[thg-auth] window.supabase not found.'); return; }
      state.supabaseReady = true;
      try{ const { data } = await window.supabase.auth.getSession(); state.user = data?.session?.user || null; } catch(_){ state.user = null; } finally { state.loading = false; render(ui); try { broadcastAuth(state.user); } catch(__) {} try { setBuyerEmailLockFromUser(state.user); } catch(__) {} }
      try{
        const { data: sub } = window.supabase.auth.onAuthStateChange(function(event, session){ state.user = session?.user || null; render(ui); try { broadcastAuth(state.user); } catch(__) {} try { setBuyerEmailLockFromUser(state.user); } catch(__) {} if (event === 'PASSWORD_RECOVERY'){ const overlay = ui.overlay; overlay.setAttribute('aria-hidden','false'); showPanel(overlay, 'update', 'Set new password'); setTimeout(function(){ const el = overlay.querySelector('#thg-up-password'); if (el) el.focus(); }, 0); } if (state.user && state.user.email){ if (state.nextUrl){ const to = state.nextUrl; state.nextUrl = null; try { closeAuthModal(ui); } catch(_){} location.href = to; } else { try { closeAuthModal(ui); } catch(_){} } } else { closeMenu(ui); } });
        state.sub = sub?.subscription || sub || null;
      } catch(_){ }
    }

    function observeRerenders(){ const mo = new MutationObserver(function(muts){ for (var i=0;i<muts.length;i++){ for (var j=0;j<muts[i].addedNodes.length;j++){ const n = muts[i].addedNodes[j]; if (n.nodeType !== 1) continue; hideLegacyAuthLinks(n); ensureContainer(); } } }); mo.observe(document.documentElement, { childList:true, subtree:true }); }

    ready(function(){
      hideLegacyAuthLinks(document);
      injectStyles();
      const ui = createUI();
      bindUI(ui);
      // If there is no header on the host page, we use a fixed fallback button.
      // On white/light backgrounds (like the Netlify snippet page), the default
      // white-on-dark styling can be invisible. Add a light-theme override only
      // for this fallback state to ensure visibility without affecting host sites
      // that have their own headers.
      try {
        if (ui.wrap && ui.wrap.classList.contains('is-fixed') && !document.getElementById('thg-auth-fixed-contrast')){
          const style = document.createElement('style');
          style.id = 'thg-auth-fixed-contrast';
          style.textContent = [
            '.thg-auth-wrap.is-fixed .thg-auth-btn{color:#111;border:1px solid rgba(0,0,0,.85);background:rgba(0,0,0,.03)}',
            '.thg-auth-wrap.is-fixed .thg-auth-btn:hover{background:rgba(0,0,0,.06)}',
            '.thg-auth-wrap.is-fixed .thg-auth-btn:focus-visible{outline:2px solid #2563eb;outline-offset:2px}',
            '.thg-auth-wrap.is-fixed .thg-auth-btn.is-auth::after{border-top-color:rgba(0,0,0,.85)}',
            '.thg-auth-wrap.is-fixed .thg-auth-menu{background:#fff;color:#111;border:1px solid rgba(0,0,0,.12);box-shadow:0 12px 30px rgba(0,0,0,.12)}',
            '.thg-auth-wrap.is-fixed .thg-auth-item:hover{background:rgba(0,0,0,.06)}',
            '.thg-auth-wrap.is-fixed .thg-initial{background:#111;color:#fff}',
            '.thg-auth-wrap.is-fixed .thg-initial-lg{background:#111;color:#fff}'
          ].join('\n');
          document.head && document.head.appendChild(style);
        }
      } catch(_){ }
      observeRerenders();
      initSupabase(ui);

      // Auto-open the auth modal on first load if configured or URL hints present
      try {
        const qp = new URLSearchParams(location.search);
        const hash = (location.hash || '').trim();
        const shouldAutoOpen = (window.AUTH_OPEN_ON_LOAD === true)
          || qp.has('auth_open') || qp.get('login') === '1' || qp.get('open') === '1'
          || hash === '#login' || hash === '#signup' || hash === '#auth';
        if (shouldAutoOpen) {
          setTimeout(function(){ try { if (!state.user) { openAuthModal(ui, { next: location.pathname + location.search }); } } catch(_){} }, 0);
        }
      } catch(_){ }

      // Allow child iframes (e.g., Netlify buyer-form) to request opening the global login
      // Secure origin-validated postMessage listener (also supports legacy types)
      const ALLOWED_IFRAME_ORIGINS = ['https://auth.tharaga.co.in', location.origin];

      function openDurableHeaderBehavior(meta){
        try {
          var el = document.getElementById('durable-head')
            || document.querySelector('header, [role="banner"], [data-section="header"], .site-header, nav')
            || document.querySelector('.thg-auth-wrap');
          if (el && el.scrollIntoView) {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          // If not authenticated, open the auth modal directly. If authenticated, do nothing.
          var isAuthed = !!(state && state.user && state.user.email);
          if (!isAuthed) {
            try { openAuthModal(ui, { next: (meta && meta.next) || (location.pathname + location.search) }); }
            catch(_) { try { window.__thgOpenAuthModal && window.__thgOpenAuthModal({ next: location.pathname + location.search }); } catch(__){} }
          }
        } catch (err) { console.error('openDurableHeaderBehavior error:', err); }
      }
      window.openDurableHeaderBehavior = openDurableHeaderBehavior;

      window.addEventListener('message', function(ev){
        try {
          var data = ev && ev.data;
          if (!data || typeof data !== 'object') return;
          // Loosen origin checks for safe CTA from known child frames (e.g., Netlify buyer-form)
          if (ev.origin && ALLOWED_IFRAME_ORIGINS.indexOf(ev.origin) === -1) {
            var extraOk = false;
            try {
              var o = ev.origin || '';
              if (/^https:\/\//.test(o)) {
                if (o.indexOf('tharaga.co.in') !== -1 || o.indexOf('auth.tharaga.co.in') !== -1 || o.indexOf('netlify.app') !== -1) extraOk = true;
                if (!extraOk && Array.isArray(window.ALLOWED_CHILD_ORIGINS) && window.ALLOWED_CHILD_ORIGINS.indexOf(o) !== -1) extraOk = true;
              }
            } catch(_) {}
            if (!extraOk) return;
          }

          if (data.type === 'cta' && data.action === 'openDurableHead'){
            console.log('Parent received openDurableHead from', ev.origin, data);
            openDurableHeaderBehavior(data.meta || {});
            return;
          }

          if (data.type === 'open_login_modal' || data.type === 'auth_open' || data.type === 'login_open' || data.type === 'trigger_header_login'){
            // If already authenticated, ignore the request so no dropdown toggles.
            if (state && state.user && state.user.email) { return; }
            // Otherwise open the modal directly (never click the header button)
            try { openAuthModal(ui, { next: data.next || (location.pathname + location.search) }); } catch(_){ }
          }

          // Navigation request from embedded forms to open listings in same tab
          if (data.type === 'open_listings' && typeof data.url === 'string'){
            try {
              var o = ev.origin || '';
              var allowed = ALLOWED_IFRAME_ORIGINS.indexOf(o) !== -1 || /tharaga\.co\.in|auth\.tharaga\.co\.in|netlify\.app/.test(o);
              if (!allowed) return;
            } catch(_) {}
            try { location.href = data.url; } catch(_) {}
            return;
          }
        } catch(_){ }
      });

      window.addEventListener('storage', function(ev){ if (ev.key === 'supabase.auth.token'){ } });
      window.addEventListener('beforeunload', function(){ try { state.sub && state.sub.unsubscribe && state.sub.unsubscribe(); } catch(_){} });
    });
  })();
  </script>
  
</head>
<body>
  <header class="nav">
    <div class="inner">
      <div class="row"><a class="brand" href="/" style="font-size:26px">THARAGA</a><span class="pill" id="home_pill_trust">Verified • Broker‑free</span></div>
      <nav class="row" aria-label="Primary">
        <span class="menu-group">
          <details class="dropdown">
            <summary>Features</summary>
            <div class="menu" role="menu">
              <a href="/tools/vastu/">Vastu</a>
              <a href="/tools/environment/">Climate & environment</a>
              <a href="/tools/voice-tamil/">Voice (Tamil)</a>
              <a href="/tools/verification/">Verification</a>
              <a href="/tools/roi/">ROI</a>
              <a href="/tools/currency-risk/">Currency risk</a>
            </div>
          </details>
          <span class="divider" aria-hidden="true"></span>
          <a href="/pricing/">Pricing</a>
        </span>
        <a href="/about/">About</a>
      </nav>
      <a class="about-mobile-link" href="/about/">About</a>
    </div>
  </header>

  <section class="hero" style="color:#111">
    <div class="inner">
      <div>
        <h1 class="h1" id="hero_title">Classy homes. Clear choices. Calm experience.</h1>
        <p class="sub" id="hero_sub">Verified listings with explainable AI. Culture‑aware tools like Vastu, climate, and voice—so families decide with confidence.</p>
        <div class="kpi-row" style="margin:12px 0 16px">
          <div class="pill"><span class="kpi" id="kpi_time">28h</span> saved per buyer</div>
          <div class="pill"><span class="kpi" id="kpi_pps">₹1,200</span> avg price/sqft gain</div>
          <div class="pill">RERA & document hygiene checks</div>
        </div>

        <div class="search-card" role="search" aria-label="Quick search">
          <div class="search-grid">
            <div>
              <label class="sub" for="q">City or locality</label>
              <input id="q" class="input" placeholder="e.g., Velachery, Chennai" list="cities" />
              <datalist id="cities">
                <option>Chennai</option><option>Coimbatore</option><option>Madurai</option><option>Trichy</option><option>Salem</option>
              </datalist>
            </div>
            <div>
              <label class="sub" for="minPrice">Budget min (₹)</label>
              <input id="minPrice" class="input" type="number" min="0" step="50000" placeholder="20,00,000" />
            </div>
            <div>
              <label class="sub" for="maxPrice">Budget max (₹)</label>
              <input id="maxPrice" class="input" type="number" min="0" step="50000" placeholder="80,00,000" />
            </div>
            <div style="display:flex;align-items:flex-end;gap:8px">
              <button id="browseBtn" class="btn" type="button">Browse matches</button>
              <button id="resumeBtn" class="btn secondary" type="button" hidden>Resume</button>
            </div>
          </div>
          <div class="chip-row" style="margin-top:10px" aria-label="BHK quick select">
            <button class="chip" data-bhk="1" aria-pressed="false">1 BHK</button>
            <button class="chip" data-bhk="2" aria-pressed="true">2 BHK</button>
            <button class="chip" data-bhk="3" aria-pressed="false">3 BHK</button>
            <button class="chip" data-type="Villa" aria-pressed="false">Villa</button>
            <button class="chip" data-type="Plot" aria-pressed="false">Plot</button>
            <button class="chip" data-metro="1" aria-pressed="false">Near Metro</button>
          </div>
        </div>

        <div class="row" style="gap:14px;margin-top:14px">
          <a class="btn" href="/property-listing/">Explore verified listings</a>
          <a class="btn secondary" href="/search-filter-home/">Advanced search</a>
        </div>
      </div>
    </div>
  </section>

  

  <section class="how" id="how">
    <div class="inner">
      <div class="card">
        <div class="h1" style="font-size:18px">1. Tell us what matters</div>
        <p class="sub">City, budget, 2‑3 must‑haves. We store this locally to personalize the site.</p>
      </div>
      <div class="card">
        <div class="h1" style="font-size:18px">2. We score options</div>
        <p class="sub">Value per sq ft, recency, commute, amenities, and risk signals.</p>
      </div>
      <div class="card">
        <div class="h1" style="font-size:18px">3. You decide faster</div>
        <p class="sub">Request details, schedule tours, or share with family—without spam.</p>
      </div>
    </div>
  </section>

  <section class="features" id="builders">
    <div class="row" style="justify-content:space-between;align-items:flex-end;margin-bottom:10px">
      <div>
        <div class="h1" style="font-size:22px">For builders who hate noise</div>
        <div class="sub">Lead scoring, campaign insights, and buyer context so your team focuses only on real demand.</div>
      </div>
      <a href="/builder-deals/" class="btn">Start listing</a>
    </div>
    <div class="feature-grid">
      <div class="card"><h3 class="h1" style="font-size:18px">Cinematic storytelling</h3><p class="sub">Reels, hotspots, 360 tours—buyers feel the project before they visit.</p></div>
      <div class="card"><h3 class="h1" style="font-size:18px">WhatsApp‑first CRM</h3><p class="sub">Auto‑summaries and nudges; no heavy dashboards required.</p></div>
      <div class="card"><h3 class="h1" style="font-size:18px">Smart scoring</h3><p class="sub">Predict intent using activity and context—not just forms.</p></div>
    </div>
  </section>

  <section class="features" aria-labelledby="ctaTitle">
    <div class="card glass-edge" style="display:flex;align-items:center;justify-content:space-between;gap:14px">
      <div>
        <div id="ctaTitle" class="h1" style="font-size:22px">Talk to a calm assistant</div>
        <div class="sub">Ask in your language. Get curated picks on WhatsApp.</div>
      </div>
      <button class="btn" type="button" id="openAssistant2">Open assistant</button>
    </div>
  </section>

  <div class="footer">© <span id="year"></span> Tharaga • <a href="/about/">About</a> • <a href="/compliance-trust/">Trust</a> • <a href="/auth-email-landing/">Email confirmation</a></div>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    document.getElementById('openAuthBtn')?.addEventListener('click', function(){ try { window.__thgOpenAuthModal && window.__thgOpenAuthModal(); } catch(_){} });
    function openAssistant(){
      try {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(9,7,8,.72);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;padding:22px;z-index:80';
        const box = document.createElement('div');
        box.style.cssText = 'width:min(760px,96vw);border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.12);box-shadow:0 24px 50px rgba(0,0,0,.35)';
        const iframe = document.createElement('iframe');
        const qs = new URLSearchParams({ embed: 'cta', open: '1', theme: 'friendly_host', blur: '14' }).toString();
        iframe.src = '/cta-embed.html?' + qs;
        iframe.title = 'Tharaga assistant';
        iframe.style.cssText = 'display:block;width:100%;height:520px;border:0;background:transparent';
        box.appendChild(iframe);
        modal.appendChild(box);
        modal.addEventListener('click', (e)=>{ if (e.target === modal) document.body.removeChild(modal); });
        document.body.appendChild(modal);
      } catch(_){ location.href = '/cta-embed.html?embed=cta&open=1'; }
    }
    document.getElementById('openAssistant')?.addEventListener('click', openAssistant);
    document.getElementById('openAssistant2')?.addEventListener('click', openAssistant);
  </script>
</body>
</html>
