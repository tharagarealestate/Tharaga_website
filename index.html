<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tharaga — Home</title>
  <script type="module" src="/js/fragment-handle.js"></script>
  <script src="/login_signup_glassdrop/auth-gate.js" defer></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: #fafafa;
      color: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      flex-direction: column;
    }
    h1 { font-size: 2rem; margin-bottom: 1rem; }
    p  { max-width: 600px; margin-bottom: 2rem; }
    nav a {
      margin: 0 1rem;
      text-decoration: none;
      font-weight: 500;
      color: #0055ff;
    }
    nav a:hover { text-decoration: underline; }
    footer { margin-top: 2rem; font-size: 0.9rem; color: #666; }
  </style>
  <style>
  /* Auth header UI (top-right) */
  .auth-account-wrap{
    position:absolute; top:14px; right:16px; display:flex; align-items:center; z-index:2147483000;
  }
  @media (min-width:1024px){ .auth-account-wrap{ top:16px; right:24px; } }
  .auth-account-wrap.is-fixed{ position:fixed; top:14px; right:16px; }
  .auth-account-btn{
    appearance:none;background:transparent;color:#111;border:1px solid rgba(0,0,0,.6);
    border-radius:9999px;padding:8px 14px;font-weight:600;cursor:pointer;line-height:1;white-space:nowrap;
  }
  .auth-account-btn:hover{background:rgba(0,0,0,.06)}
  .auth-account-menu{
    position:absolute;top:calc(100% + 10px);right:0;min-width:180px;background:#0b0b0b;color:#fff;
    border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:8px;box-shadow:0 12px 30px rgba(0,0,0,.4);
    display:none;z-index:2147483001;
  }
  .auth-account-menu[aria-hidden="false"]{display:block}
  .auth-account-item{
    display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;text-decoration:none;color:#fff;cursor:pointer;
  }
  .auth-account-item:hover{background:rgba(255,255,255,.08)}
  .auth-account-initial{
    width:26px;height:26px;border-radius:999px;background:#fff;color:#111;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;
  }
  </style>
</head>
<body>
  <h1>Welcome to Tharaga</h1>
  <p>
    This is the unified website. Use the links below or Durable can embed
    each section directly using its own route.
  </p>
  <nav>
    <a href="/about/">About</a>
    <a href="/buyer-form/">Buyer Form</a>
    <a href="/property-listing/">Properties</a>
    <a href="/rating/">Rating</a>
    <a href="/reel-grid/">Reels</a>
    <a href="/registration/">Registration</a>
    <a href="/search-filter-home/">Search Filter</a>
    <a href="#" id="loginSignupLink">Login/Signup</a>
    <a href="/Reset_password/">Reset password</a>
    <a href="/login_signup_glassdrop/">login popup</a>
    <a href="auth-landing/">auth landing</a>
    <a href="auth-email-landing/">auth email landing</a>
  </nav>
  <footer>© <span id="year"></span> Tharaga</footer>
  <script>
  // Top-right auth widget: replaces Login/Signup with "Hi, {Name}" and dropdown
  (function(){
    if (window.__authHeaderInstalledV2) return; window.__authHeaderInstalledV2 = true;
    function ready(fn){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn);} else { fn(); } }

    function headerRoot(){
      return document.querySelector('header, [role="banner"], [data-section="header"], .site-header, .Header, nav') || null;
    }

    function hideLegacyAuthLinks(root){
      (root||document).querySelectorAll('a[href="#login"], a[href="#signup"], [data-auth-open]')
        .forEach(function(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); });
    }

    function ensureContainer(){
      var hdr = headerRoot();
      var wrap = document.querySelector('.auth-account-wrap');
      if (!wrap){
        wrap = document.createElement('div');
        wrap.className = 'auth-account-wrap';
        var parent = hdr || document.body;
        if (hdr) {
          var cs = getComputedStyle(hdr);
          if (cs.position === 'static') { hdr.style.position = 'relative'; }
          parent.appendChild(wrap);
        } else {
          wrap.classList.add('is-fixed');
          parent.appendChild(wrap);
        }
      }
      return wrap;
    }

    function ensureUI(){
      var wrap = ensureContainer();
      var btn = wrap.querySelector('.auth-account-btn');
      if (!btn){
        btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'auth-account-btn';
        btn.textContent = 'Login / Signup';
        wrap.appendChild(btn);
      }
      var menu = wrap.querySelector('.auth-account-menu');
      if (!menu){
        menu = document.createElement('div');
        menu.className = 'auth-account-menu';
        menu.setAttribute('aria-hidden','true');
        menu.innerHTML =
          '<div class="auth-account-item" data-action="profile"><span class="auth-account-initial">U</span><span>Profile</span></div>' +
          '<div class="auth-account-item" data-action="logout"><span>Logout</span></div>';
        wrap.appendChild(menu);
      }
      return {wrap:wrap, btn:btn, menu:menu};
    }

    function initialFromUser(user){
      var name = (user && user.user_metadata && user.user_metadata.full_name) || '';
      var email = (user && user.email) || '';
      var base = (name || email || '').trim();
      return base ? base[0].toUpperCase() : 'U';
    }

    function firstName(user){
      try {
        var full = (user && user.user_metadata && user.user_metadata.full_name) || '';
        if (full) return full.split(/\s+/)[0];
        var email = (user && user.email) || '';
        if (email) return email.split('@')[0].replace(/\b\w/g, function(c){ return c.toUpperCase(); });
      } catch(_) {}
      return 'There';
    }

    function render(ui, user){
      ui.btn.textContent = user ? ('Hi, ' + firstName(user)) : 'Login / Signup';
      var init = ui.menu.querySelector('.auth-account-initial');
      if (init) init.textContent = initialFromUser(user);
    }

    function toggleMenu(menu, show){ menu.setAttribute('aria-hidden', show ? 'false' : 'true'); }

    function bind(ui, state){
      ui.btn.addEventListener('click', function(e){
        e.preventDefault();
        if (!state.user) {
          window.authGate && window.authGate.openLoginModal && window.authGate.openLoginModal({ next: location.pathname + location.search });
          return;
        }
        var open = ui.menu.getAttribute('aria-hidden') === 'true';
        toggleMenu(ui.menu, open);
      });
      ui.menu.addEventListener('click', async function(e){
        var item = e.target.closest('.auth-account-item'); if (!item) return;
        var act = item.getAttribute('data-action');
        if (act === 'profile'){
          window.authGate && window.authGate.openLoginModal && window.authGate.openLoginModal({ next: location.pathname + location.search });
          toggleMenu(ui.menu,false);
        }
        if (act === 'logout'){
          try { await (window.supabase && window.supabase.auth && window.supabase.auth.signOut && window.supabase.auth.signOut()); } catch(_){ }
          try { localStorage.removeItem('__tharaga_magic_continue'); localStorage.removeItem('__tharaga_magic_confirmed'); } catch(_){}
          state.user = null; render(ui, state.user); toggleMenu(ui.menu,false);
        }
      });
      document.addEventListener('click', function(e){
        if (ui.menu.getAttribute('aria-hidden') === 'true') return;
        if (!ui.menu.contains(e.target) && e.target !== ui.btn && !ui.btn.contains(e.target)){
          toggleMenu(ui.menu,false);
        }
      });
      document.addEventListener('keydown', function(e){ if (e.key==='Escape') toggleMenu(ui.menu,false); });
    }

    async function getUser(){
      try {
        if (window.supabase && window.supabase.auth){
          var res = await window.supabase.auth.getUser();
          return (res && res.data && res.data.user) ? res.data.user : null;
        }
      } catch(_){ }
      try {
        var payload = JSON.parse(localStorage.getItem('__tharaga_magic_continue')||'null');
        if (payload && payload.user) return { email: payload.user.email || null, user_metadata:{} };
      } catch(_){ }
      if (window.__authGateLoggedIn) return { email:null, user_metadata:{} };
      return null;
    }

    function observeRerenders(){
      var mo = new MutationObserver(function(muts){
        for (var i=0;i<muts.length;i++){
          for (var j=0;j<muts[i].addedNodes.length;j++){
            var n = muts[i].addedNodes[j];
            if (n.nodeType !== 1) continue;
            hideLegacyAuthLinks(n);
            ensureContainer();
          }
        }
      });
      mo.observe(document.documentElement, { childList:true, subtree:true });
    }

    ready(async function(){
      hideLegacyAuthLinks(document);
      var ui = ensureUI();
      var state = { user: await getUser() };
      render(ui, state.user);
      bind(ui, state);
      observeRerenders();

      if (window.supabase && window.supabase.auth){
        try {
          window.supabase.auth.onAuthStateChange(function(_ev, session){
            state.user = (session && session.user) || null;
            render(ui, state.user);
          });
        } catch(_){ }
      }
      window.addEventListener('storage', function(ev){
        if (ev.key === '__tharaga_magic_continue' && ev.newValue){
          try {
            var p = JSON.parse(ev.newValue);
            state.user = p && p.user ? { email:p.user.email||null, user_metadata:{} } : state.user || { email:null, user_metadata:{} };
            render(ui, state.user);
          } catch(_){ }
        }
      });
    });
  })();
  </script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>
  <script>
    (function(){
      var link = document.getElementById('loginSignupLink');
      if (!link) return;
      link.addEventListener('click', function(e){
        e.preventDefault();
        if (window.authGate && typeof window.authGate.openLoginModal === 'function') {
          window.authGate.openLoginModal({ next: location.pathname + location.search });
        } else {
          // Fallback: navigate to the auth page directly
          location.href = '/login_signup_glassdrop/';
        }
      });
    })();
  </script>
</body>
</html>
