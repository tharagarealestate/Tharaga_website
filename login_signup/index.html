<!-- AUTH GATE: paste before </body> on your site -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
<style>
  /* Minimal polished modal + button styles (copy as-is or adapt) */
  :root{--accent:#0f172a;--muted:#6b7280;--bg:rgba(3,7,18,0.6)}
  .auth-overlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(3px);display:none}
  .auth-modal{width:420px;max-width:95%;background:#fff;border-radius:12px;padding:20px;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  .auth-modal h2{margin:0 0 6px;font-size:20px}
  .auth-modal p{color:var(--muted);margin:0 0 12px;font-size:13px}
  .auth-row{display:flex;gap:8px;margin-bottom:10px}
  .auth-row input{flex:1;padding:10px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px}
  .btn{padding:10px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer}
  .btn-primary{background:#0f172a;color:#fff}
  .btn-ghost{background:transparent;border:1px solid #e6e9ef;color:var(--accent)}
  .auth-actions{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:8px}
  .auth-footer{font-size:13px;color:var(--muted);margin-top:12px;text-align:center}
  .small{font-size:13px;color:var(--muted)}
  .close-x{position:absolute;right:10px;top:8px;border:0;background:transparent;font-size:18px;cursor:pointer}
</style>

<!-- Modal -->
<div id="authOverlay" class="auth-overlay" aria-hidden="true">
  <div class="auth-modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <button id="authClose" class="close-x" title="Close">✕</button>
    <div id="authBody">
      <h2 id="authTitle">Sign in to continue</h2>
      <p id="authSubtitle" class="small">Create an account or sign in to access partner portals and listings.</p>

      <div style="margin-top:12px">
        <!-- Email input -->
        <div class="auth-row">
          <input id="authEmail" placeholder="you@domain.com" type="email" autocomplete="email" />
        </div>

        <!-- Password input (optional; used for sign-in / sign-up) -->
        <div class="auth-row">
          <input id="authPassword" placeholder="Password (optional — magic link is recommended)" type="password" autocomplete="current-password" />
        </div>

        <!-- Actions -->
        <div class="auth-actions">
          <button id="btnSignIn" class="btn btn-primary">Sign in / Magic link</button>
          <button id="btnSignUp" class="btn btn-ghost">Sign up (email+password)</button>
        </div>

        <div style="margin-top:10px">
          <span class="small">Or</span>
          <button id="btnSignOut" class="btn" style="margin-left:8px;display:none">Sign out</button>
        </div>

        <div id="authMsg" class="auth-footer" aria-live="polite"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
/*
  Auth gate script (module)
  - Requirements: fill SUPABASE_URL and SUPABASE_ANON_KEY below
  - How it works:
      * Intercepts clicks on links that match configured protected domains OR have data-protected="true".
      * If not logged in -> opens modal; stores pending target in window.__pendingAuthTarget.
      * After login success, navigates to stored target (same tab) or opens new tab depending on attribute.
*/

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://wedevtjjmdvngyshqdro.supabase.co';    // <-- REPLACE
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M';                  // <-- REPLACE

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ----------------- UI bindings -----------------
const overlay = document.getElementById('authOverlay');
const closeBtn = document.getElementById('authClose');
const btnSignIn = document.getElementById('btnSignIn');
const btnSignUp = document.getElementById('btnSignUp');
const btnSignOut = document.getElementById('btnSignOut');
const emailInput = document.getElementById('authEmail');
const passInput = document.getElementById('authPassword');
const authMsg = document.getElementById('authMsg');

function showModal(pendingTarget = null) {
  window.__pendingAuthTarget = pendingTarget;
  overlay.style.display = 'flex';
  overlay.setAttribute('aria-hidden', 'false');
}
function hideModal() {
  overlay.style.display = 'none';
  overlay.setAttribute('aria-hidden', 'true');
}

closeBtn.onclick = () => hideModal();
overlay.onclick = (e) => { if (e.target === overlay) hideModal(); }

// run on page init
(async function onInit() {
  try {
    const { data } = await supabase.auth.getSession();
    if (data?.session) {
      // if user already logged in and we have a saved target — go there
      const raw = localStorage.getItem('post_auth_target');
      if (raw) {
        const pending = JSON.parse(raw);
        localStorage.removeItem('post_auth_target');
        if (pending.openInNewTab) window.open(pending.href, '_blank');
        else window.location.href = pending.href;
      } else {
        // optionally, if ?post_auth=1 and no target, send to homepage or last path
        const params = new URLSearchParams(location.search);
        if (params.get('post_auth') === '1') window.location.href = '/';
      }
    }
  } catch (e) {
    console.error('auth init err', e);
  }
})();

// ----------------- Auth helpers -----------------
async function isLoggedIn() {
  try {
    const { data } = await supabase.auth.getSession();
    return !!(data && data.session);
  } catch (err) {
    return false;
  }
}

async function currentUserEmail() {
  const { data } = await supabase.auth.getUser();
  return data?.user?.email ?? null;
}

async function signInMagic(email) {
  authMsg.textContent = 'Sending magic link... (check spam).';
  // ensure we have saved pending target (could be null)
  // (this value already saved on click interception)
  const redirectTo = `${window.location.origin}/login_signup?post_auth=1`;
  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: {
      emailRedirectTo: window.location.origin  // must be allowed in Supabase auth settings
    }
  });
  if (error) authMsg.textContent = 'Error: ' + error.message;
  else authMsg.textContent = 'Magic link sent. Check your email to continue.';
}

async function signUpWithPassword(email, password) {
  authMsg.textContent = 'Creating account...';
  const { data, error } = await supabase.auth.signUp({
    email,
    password
  });
  if (error) authMsg.textContent = 'Error: ' + error.message;
  else {
    authMsg.textContent = 'Account created. Confirm via email if required.';
    // Supabase signs user in automatically depending on settings; we'll monitor onAuthStateChange below
  }
}

async function signOut() {
  await supabase.auth.signOut();
  authMsg.textContent = 'Signed out.';
  btnSignOut.style.display = 'none';
}

// Monitor auth state and auto-continue pending navigation
supabase.auth.onAuthStateChange(async (event, session) => {
  if (session && session.access_token) {
    btnSignOut.style.display = 'inline-block';
    hideModal();

    // first check in-memory pending, otherwise check localStorage
    const pending = window.__pendingAuthTarget || (() => {
      const raw = localStorage.getItem('post_auth_target');
      return raw ? JSON.parse(raw) : null;
    })();

    if (pending) {
      localStorage.removeItem('post_auth_target');
      if (pending.openInNewTab) window.open(pending.href, '_blank');
      else window.location.href = pending.href;
      window.__pendingAuthTarget = null;
    } else {
      authMsg.textContent = 'Signed in.';
    }
  } else {
    btnSignOut.style.display = 'none';
  }
});

// Hook up buttons
btnSignIn.onclick = async (ev) => {
  ev.preventDefault();
  const email = emailInput.value.trim();
  const pwd = passInput.value;
  if (!email) { authMsg.textContent = 'Enter an email.'; return; }
  // If password present -> try sign-in with password (optional)
  if (pwd) {
    authMsg.textContent = 'Signing in...';
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pwd });
    if (error) authMsg.textContent = 'Error: ' + error.message;
    else {
      authMsg.textContent = 'Signed in.';
    }
  } else {
    // send magic link / OTP (recommended)
    await signInMagic(email);
  }
};

btnSignUp.onclick = async (ev) => {
  ev.preventDefault();
  const email = emailInput.value.trim();
  const pwd = passInput.value;
  if (!email || !pwd) { authMsg.textContent = 'Provide email and password to sign up.'; return; }
  await signUpWithPassword(email, pwd);
};

btnSignOut.onclick = async (ev) => { ev.preventDefault(); await signOut(); };

// ----------------- Link protection -----------------
/*
  Protected behavior:
  - Auto-detect external real-estate portals and protect them
  - OR protect any element with data-protected="true"
  - To explicitly protect an <a> tag add: data-protected="true" data-open-new-tab="true"
*/
const defaultProtectedDomains = [
  'nobroker', 'magicbricks', '99acres', 'housing.com', 'makaan', 'quikrhomes'
];

function isDomainProtected(href) {
  try {
    const url = new URL(href, location.href);
    return defaultProtectedDomains.some(d => url.hostname.includes(d));
  } catch (err) {
    return false;
  }
}

async function handleDocumentClick(e) {
  const a = e.target.closest && e.target.closest('a');
  const btn = e.target.closest && e.target.closest('button');
  let targetEl = a || btn;
  if (!targetEl) return;

  // if element has explicit data-protected attribute
  const explicit = targetEl.dataset && targetEl.dataset.protected === 'true';

  // If anchor: check href domain
  if (a) {
    const href = a.getAttribute('href');
    if (!href || href.startsWith('#') || href.startsWith('mailto:') || href.startsWith('tel:')) return;
    const openInNewTab = a.dataset.openNewTab === 'true' || a.target === '_blank';

    const domainProtected = isDomainProtected(href);
    if (!explicit && !domainProtected) return; // not protected

    // Protected: stop default until auth check
    e.preventDefault();

    // If already logged in -> proceed
    if (await isLoggedIn()) {
      if (openInNewTab) window.open(href, '_blank');
      else location.href = href;
      return;
    }

    // -> Use localStorage so the target survives when user opens magic link in new tab

    const pending = { href, openInNewTab };
    localStorage.setItem('post_auth_target', JSON.stringify(pending));
    showModal(pending);
    // pre-fill email if we have it from previous session
    const maybeEmail = await currentUserEmail();
    if (maybeEmail) emailInput.value = maybeEmail;
    return;
  }

  // If button has data-protected, intercept (for non-link CTAs)
  if (btn && btn.dataset && btn.dataset.protected === 'true') {
    e.preventDefault();
    if (await isLoggedIn()) {
      // allow default (trigger original handler) by re-dispatching click
      btn.removeAttribute('data-protected'); // prevent loop
      btn.click();
      btn.dataset.protected = 'true'; // restore if needed
      return;
    } else {
      window.__pendingAuthTarget = null;
      showModal(null);
      return;
    }
  }
}

// Listen to clicks on document (delegation)
document.addEventListener('click', handleDocumentClick, true);

// MutationObserver to re-scan newly added links (Softr or client-side rendered content)
const observer = new MutationObserver((mutations) => {
  // For performance we do not auto-modify DOM, but we could add data attributes here if you prefer
  // Keep this hook if you want automatic marking of external links
});
observer.observe(document.body, { childList: true, subtree: true });

// ----------------- Helper: auto-mark links you can change this list -----------------
// If you prefer, mark specific links in your HTML:
// <a href="https://nobroker.in/..." data-protected="true">...</a>
// The script will respect data-protected and data-open-new-tab attributes

// ----------------- End module -----------------
</script>
