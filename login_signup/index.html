<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login / Sign up ‚Ä¢ Tharaga</title>
  <meta name="description" content="Secure login and signup for Tharaga partner portals and listings." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>
  :root{
    /* Tharaga ‚Äî refined brand palette */
    --bg: #071026;          /* deep midnight navy (page background) */
    --bg-spot-1: #10213a;   /* radial gradient tone */
    --bg-spot-2: #0f1724;   /* radial gradient tone */
    --card-text: #071026;   /* text on light cards */
    --muted: #94a3b8;       /* muted slate */
    --txt: #f1f5f9;         /* primary page text (light) */
    --acc: #16a34a;         /* emerald accent (trust) */
    --acc2: #2563eb;        /* royal/brand blue (authority) */
    --warn: #f59e0b;        /* warm amber */
    --err: #dc2626;         /* error red */
    --input-bg: #ffffff;    /* clean input surface */
    --input-border: #cbd5e1;/* soft slate border for inputs */
    --line: rgba(148,163,184,.2); /* thin line used for card borders */
    --glass-01: rgba(255,255,255,0.04); /* subtle glass on dark */
    --shadow-lg: 0 10px 40px rgba(2,6,23,.65);
    --radius-md: 10px;
    --radius-lg: 16px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:
      radial-gradient(1200px 800px at 80% -10%, var(--bg-spot-1) 0%, transparent 60%),
      radial-gradient(900px 700px at -10% 20%, var(--bg-spot-2) 0%, transparent 60%),
      var(--bg);
    color:var(--txt);
  }

  .container{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:18px 20px;
    color:var(--txt);
  }
  header a, header button{
    color:var(--txt);
    text-decoration:none;
    font-weight:600;
    opacity:.92;
  }
  header a:hover{opacity:1}

  main{display:grid;place-items:center;padding:24px}

  /* Card ‚Äî light elevated surface to pop on dark page */
  .card{
    width:420px;
    max-width:95vw;
    background: linear-gradient(180deg, #FBF7F3, #F3F4F6); /* warm, premium paper */
    backdrop-filter:saturate(180%) blur(8px);
    border:1px solid var(--line);
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow-lg);
    padding:22px;
    color:var(--card-text);
  }

  h1{font-size:22px;margin:0 0 6px;color:var(--txt)}
  p.muted{color:var(--muted);margin:0 0 16px;font-size:14px}

  label{
    display:block;
    font-size:13px;
    margin:10px 0 6px;
    color:#334155; /* darker label on light card */
    font-weight:600;
  }

  /* Inputs ‚Äî clear, high contrast, elegant */
  input{
    width:100%;
    padding:12px 12px;
    border-radius:var(--radius-md);
    border:1px solid var(--input-border);
    background:var(--input-bg);
    color:var(--card-text);
    outline:none;
    transition:box-shadow .15s, border-color .12s, transform .06s;
  }
  input:focus{
    border-color:var(--acc2);
    box-shadow:0 0 0 6px rgba(37,99,235,.08);
  }

  .toggle-eye{
    position:absolute;
    top:50%;
    right:12px;
    transform:translateY(-50%);
    cursor:pointer;
    font-size:14px;
    opacity:.7;
  }
  .toggle-eye:hover{opacity:1}

  .row{display:flex;gap:10px}

  .btn{
    cursor:pointer;
    border:0;
    border-radius:10px;
    padding:12px 14px;
    font-weight:700;
    color:var(--txt);
  }

  .btn-primary{
    background:linear-gradient(180deg,var(--acc2),#1d4ed8);
    color:white;
    box-shadow:0 6px 18px rgba(29,78,216,.22);
  }

  .btn-ghost{
    background:transparent;
    border:1px solid rgba(255,255,255,.06); /* subtle ghost on dark header */
    color:var(--txt);
  }

  .btn-danger{
    background:linear-gradient(180deg,var(--err),#b91c1c);
    color:white;
  }

  .hint{font-size:12px;color:var(--muted);margin-top:8px}

  .msg{margin-top:12px;font-size:14px}
  .msg.ok{color:var(--acc)}      /* green success */
  .msg.err{color:var(--err)}    /* red error */

  .divider{
    height:1px;
    background:linear-gradient(90deg,transparent,#cbd5e1,transparent);
    margin:16px 0;
  }

  /* Pills used on dark hero ‚Äî light glass with warm highlight */
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    background:var(--glass-01);
    border:1px solid rgba(255,255,255,.04);
    font-size:12px;
    color:var(--txt);
  }

  footer{
    padding:18px 20px;
    color:var(--muted);
    font-size:12px;
    text-align:center;
  }

  .hidden{display:none !important}
  .flex{display:flex;align-items:center;gap:10px}
  .right{margin-left:auto}
  .copy{cursor:pointer;font-size:12px;opacity:.8}
  .copy:hover{opacity:1}
  .small-link{font-size:12px;color:var(--acc2);text-decoration:none}
  .small-link:hover{text-decoration:underline}

  /* Success confirmation block ‚Äî rich, premium green */
  .success-block{
    background:#052f18;          /* deep green surface */
    border:1px solid #14532d;    /* dark green border */
    border-radius:12px;
    padding:12px;
    margin-top:12px;
    color:#d1fae5;               /* light mint text */
  }
</style>

</head>
<body>
  <div class="container">
    <header>
      <a href="/">‚Üê Back to Tharaga</a>
      <span class="pill">Verified Listings ‚Ä¢ Direct Owner</span>
    </header>

    <main>
      <section class="card" aria-live="polite">
        <h1>Sign in to continue</h1>
        <p class="muted">"Browse only approved builder projects ‚Äî safe, transparent, and verified"</p>

        <!-- session-state area (hidden until logged in) -->
        <div id="authed" class="hidden">
          <div class="success-block">
            <div class="flex">
              <strong>You're signed in</strong>
              <span id="userEmail" class="right"></span>
            </div>
            <div id="continueWrap" class="flex" style="margin-top:8px">
              <button id="continueBtn" class="btn btn-primary">Continue</button>
              <a id="viewHome" class="btn btn-ghost" href="/">Go Home</a>
              <button id="signOutBtn" class="btn btn-danger right">Sign out</button>
            </div>
          </div>
        </div>

        <!-- auth form (hidden if logged in) -->
        <form id="authForm" autocomplete="on">
          <label for="email">Email</label>
          <input id="email" name="email" type="email" placeholder="you@domain.com" autocomplete="email" required>

          <div class="row">
            <div style="flex:1">
              <label for="password">Password <span class="hint">(optional ‚Äî use Magic Link for fastest login)</span></label>
              <input id="password" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" id="toggleEye" class="toggle-eye">üëÅ>
         	 <!-- <span id="toggleEye" class="toggle-eye">üëÅ</span> -->
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="magicBtn" class="btn btn-primary" type="button">Continue with Magic Link</button>
            <button id="pwdBtn" class="btn btn-ghost" type="button">Sign in with Password</button>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="signupBtn" class="btn btn-ghost" type="button">Create Account</button>
            <a id="forgotLink" class="small-link right" href="/reset-password">Forgot password?</a>

          </div>

          <div id="msg" class="msg" role="status"></div>
        </form>

        <div class="divider"></div>

        <div class="hint">
          Tip: If you reached this page after clicking a partner link, we'll return you there after sign-in.
        </div>
      </section>
    </main>

    <footer>
      ¬© <span id="year"></span> Tharaga
    </footer>
  </div>

  <!-- Auth + Gate Logic -->
  <script type="module">
    // ========================= CONFIG =========================
    // Fill these with your project values
    const SUPABASE_URL = 'https://wedevtjjmdvngyshqdro.supabase.co'; // <-- REQUIRED
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M';         // <-- REQUIRED

    // Domains we auto-protect when using the gate snippet on other pages
    const PROTECTED_DOMAINS = ['nobroker', 'magicbricks', '99acres', 'housing.com', 'makaan', 'quikrhomes'];

    // Callback page for magic links / email confirmations. Keep under your domain and add to Supabase Redirect URLs.
    const POST_AUTH_CALLBACK = `${location.origin}/login_signup?post_auth=1`;

    // ========================= IMPORT =========================
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========================= UI HOOKS ========================
    const yearEl = document.getElementById('year');
    yearEl.textContent = new Date().getFullYear();

    const form = document.getElementById('authForm');
    const authed = document.getElementById('authed');
    const magicBtn = document.getElementById('magicBtn');
    const pwdBtn = document.getElementById('pwdBtn');
    const signupBtn = document.getElementById('signupBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const continueBtn = document.getElementById('continueBtn');
    const emailEl = document.getElementById('email');
    const pwdEl = document.getElementById('password');
    const msgEl = document.getElementById('msg');
    const userEmail = document.getElementById('userEmail');
	const toggleEye=document.getElementById('toggleEye');

    // ========================= HELPERS =========================
    const storage = {
      get(){ try { return JSON.parse(localStorage.getItem('post_auth_target')||'null'); } catch { return null } },
      set(v){ localStorage.setItem('post_auth_target', JSON.stringify(v)); },
      clear(){ localStorage.removeItem('post_auth_target'); }
    };

    function setMsg(text, ok=false){
      msgEl.textContent = text || '';
      msgEl.className = 'msg' + (text? (ok? ' ok':' err') : '');
    }

    function getNextFromQuery(){
      const p = new URLSearchParams(location.search);
      return p.get('next');
    }

    function ensurePendingTargetFromQuery(){
      // If ?next=something is present and no stored target, store it.
      const next = getNextFromQuery();
      if (next && !storage.get()) {
        try {
          const href = decodeURIComponent(next);
          const openInNewTab = false;
          storage.set({ href, openInNewTab });
        } catch {}
      }
    }

    function showAuthed(email){
      userEmail.textContent = email ? `‚Ä¢ ${email}` : '';
      authed.classList.remove('hidden');
      form.classList.add('hidden');
    }
    function showForm(){
      authed.classList.add('hidden');
      form.classList.remove('hidden');
    }
	// === Password eye toggle ===
    toggleEye.addEventListener('click',()=>{
      const t=pwdEl.type==='password'?'text':'password';
      pwdEl.type=t;
      toggleEye.textContent=t==='password'?'üëÅ':'üôà';
    });

    // ========================= INIT ===========================
    ensurePendingTargetFromQuery();

    // When page loads, if already signed in and have pending target, continue.
    (async function onInit(){
      try {
        const { data } = await supabase.auth.getSession();
        const session = data?.session;
        const pending = storage.get();
        if (session) {
          showAuthed(session.user?.email);
          if (pending) {
            // small delay for UI feel
            setTimeout(()=>{
              storage.clear();
              if (pending.openInNewTab) window.open(pending.href, '_blank');
              else location.href = pending.href;
            }, 400);
          }
        } else {
          showForm();
        }
      } catch (e) {
        console.error(e);
        showForm();
      }
    })();

    // Supabase will fire this when magic link lands or password sign-in completes
    supabase.auth.onAuthStateChange((event, session) => {
      if (session?.access_token) {
        showAuthed(session.user?.email);
        const pending = storage.get();
        if (pending) {
          storage.clear();
          if (pending.openInNewTab) window.open(pending.href, '_blank');
          else location.href = pending.href;
        } else if (new URLSearchParams(location.search).get('post_auth') === '1') {
          // If we came from an email and no target, go home
          setTimeout(()=>{ location.href = '/'; }, 500);
        }
      }
    });

    // ========================= ACTIONS ========================
    magicBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      if (!email) return setMsg('Enter a valid email');
      setMsg('Sending magic link‚Ä¶');
      // Ensure a pending target exists; if none, default to referer or home
      if (!storage.get()) {
        const fallback = document.referrer && new URL(document.referrer).origin === location.origin
          ? new URL(document.referrer).pathname
          : '/';
        storage.set({ href: fallback, openInNewTab: false });
      }
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: POST_AUTH_CALLBACK }
      });
      if (error) setMsg(error.message);
      else setMsg('Magic link sent! Check your inbox (and spam).', true);
    });

    pwdBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = pwdEl.value;
      if (!email || !password) return setMsg('Enter email + password');
      setMsg('Signing in‚Ä¶');
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) setMsg(error.message);
      else setMsg('Signed in ‚úì', true);
    });

    signupBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = pwdEl.value;
      if (!email || !password) return setMsg('Enter email + password to create account');
      setMsg('Creating account‚Ä¶');
      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: POST_AUTH_CALLBACK }
      });
      if (error) setMsg(error.message);
      else setMsg('Account created. Check your email to confirm.', true);
    });

    signOutBtn?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      storage.clear();
      showForm();
      setMsg('Signed out.', true);
    });

    continueBtn?.addEventListener('click', () => {
      const pending = storage.get();
      storage.clear();
      if (pending) {
        if (pending.openInNewTab) window.open(pending.href, '_blank');
        else location.href = pending.href;
      } else {
        location.href = '/';
      }
    });

    // ========================= OPTIONAL: "Gate snippet" for other pages =========================
    // Copy the function below into any page where you want to protect links/buttons.
    // Example usage:
    //   enableAuthGate({ selector: 'a', protectedDomains: PROTECTED_DOMAINS });
    //   // to explicitly protect any element: add data-protected="true", data-open-new-tab="true"
    
    window.enableAuthGate = function enableAuthGate({ selector = 'a', protectedDomains = PROTECTED_DOMAINS } = {}){
      document.addEventListener('click', async (e) => {
        const el = e.target.closest(selector);
        if (!el) return;
        const isExplicit = el.dataset?.protected === 'true';
        const href = el.getAttribute?.('href');
        const isButton = !href; // for buttons/CTAs
        const openInNewTab = el.dataset?.openNewTab === 'true' || el.target === '_blank';

        let needsProtect = isExplicit;
        if (!needsProtect && href) {
          try {
            const url = new URL(href, location.href);
            needsProtect = protectedDomains.some(d => url.hostname.includes(d));
          } catch {}
        }
        if (!needsProtect) return;

        // Check auth
        const { data } = await supabase.auth.getSession();
        if (data?.session) return; // already logged in, allow default

        // Block and send to login page
        e.preventDefault();
        const target = href ? { href, openInNewTab } : { href: location.pathname + location.search + location.hash, openInNewTab:false };
        localStorage.setItem('post_auth_target', JSON.stringify(target));
        location.href = `/login_signup?next=${encodeURIComponent(target.href)}`;
      }, true);
    }
  </script>
</body>
</html>
