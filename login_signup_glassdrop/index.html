<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login / Sign up ‚Ä¢ Tharaga</title>
  <meta name="description" content="Secure login and signup for Tharaga partner portals and listings." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <script type="module" src="/js/fragment-handle.js" defer></script>

  <style>
    :root{
      /* Tharaga Brand Palette */
      --bg:#0a0a0a;          /* Deep Obsidian Background */
      --card:#151515;        /* Charcoal Card Surface */
      --muted:#9ca3af;       /* Muted Platinum Gray */
      --txt:#f5f5f5;         /* Platinum White Text */
      --acc:#d4af37;         /* Regal Gold (primary accent) */
      --acc2:#16a34a;        /* Emerald Green (secondary accent) */
      --warn:#f59e0b;        /* Amber Gold (warnings, classy) */
      --err:#dc2626;         /* Rich Crimson (errors) */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 80% -10%,#1c1c1c 0%,transparent 60%),
        radial-gradient(900px 700px at -10% 20%,#111111 0%,transparent 60%),
        var(--bg);
      color:var(--txt);
    }
    .container{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 20px;color:var(--txt);
    }
    header a, header button{color:var(--txt);text-decoration:none;font-weight:600;opacity:.85}
    header a:hover{opacity:1;color:var(--acc)}
    main{display:grid;place-items:center;padding:24px}
    .card{
      width:420px;max-width:95vw;
      background:linear-gradient(180deg,#1a1a1a,#0f0f0f);
      backdrop-filter:saturate(180%) blur(10px);
      border:1px solid rgba(212,175,55,.25); /* subtle gold tint */
      border-radius:16px;
      box-shadow:0 0 40px rgba(0,0,0,.55);
      padding:22px;
      color:var(--txt);
    }
    h1{font-size:22px;margin:0 0 6px;color:var(--acc)}
    p.muted{color:var(--muted);margin:0 0 16px;font-size:14px}
    label{display:block;font-size:13px;margin:10px 0 6px;color:var(--txt)}
    input{
      position: relative;width:100%;padding:12px 12px;border-radius:10px;padding-right: 40px;;
      border:1px solid #333333;
      background:#1e1e1e;
      color:var(--txt);
      outline:none;
    }
    input:focus{
      border-color:var(--acc);
      box-shadow:0 0 0 3px rgba(212,175,55,.25);
    }

    /* wrapper around input + icon */
.input-pill {
  position: relative;   /* anchor for the absolute icon */
  width: 100%;
}

/* make sure the input leaves room for the icon */
.input-pill input {
  width: 100%;
  padding-right: 44px;  /* provide space so text doesn't overlap the eye */
  box-sizing: border-box;
}
    .toggle-eye{position:absolute;top:50%;right:12px;transform:translateY(-50%);cursor:pointer;font-size:14px;opacity:.7;color:var(--muted)}
    .toggle-eye:hover{opacity:1;color:var(--acc)}
    .row{display:flex;gap:10px}
    .btn{cursor:pointer;border:0;border-radius:10px;padding:12px 14px;font-weight:700;color:var(--txt)}
    .btn-primary{background:linear-gradient(180deg,var(--acc),#b8860b);color:black}
    .btn-ghost{background:transparent;border:1px solid #333333;color:var(--muted)}
    .btn-danger{background:linear-gradient(180deg,var(--err),#7f1d1d);color:white}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .msg{margin-top:12px;font-size:14px}
    .msg.ok{color:var(--acc2)}
    .msg.err{color:#fca5a5}
    .divider{height:1px;background:linear-gradient(90deg,transparent,#2d2d2d,transparent);margin:16px 0}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border:1px solid #333333;
      border-radius:999px;
      background:rgba(20,20,20,.6);
      font-size:12px;
      color:var(--muted)
    }
    footer{padding:18px 20px;color:var(--muted);font-size:12px;text-align:center}
    .hidden{display:none !important}
    .flex{display:flex;align-items:center;gap:10px}
    .right{margin-left:auto}
    .copy{cursor:pointer;font-size:12px;opacity:.8;color:var(--muted)}
    .copy:hover{opacity:1;color:var(--acc)}
    .small-link{font-size:12px;color:var(--acc2);text-decoration:none}
    .small-link:hover{text-decoration:underline;color:var(--acc)}
    .success-block{
      background:#0f1f12;
      border:1px solid #224422;
      border-radius:12px;
      padding:12px;
      margin-top:12px;
      color:var(--acc2)
    }

    /* Fullscreen dark glass backdrop */
    .auth-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(6px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
    }

    /* Centered modal (your .card) */
    .auth-modal {
    animation: popupSlide 0.35s ease-out;
    max-height: 95vh;
    overflow-y: auto;
    }

    /* Sweet little animation */
    @keyframes popupSlide {
    0% { transform: translateY(40px) scale(0.96); opacity: 0; }
    100% { transform: translateY(0) scale(1); opacity: 1; }
    }

    .close-btn {
    position: fixed;
    top: 15px;
    right: 20px;
    background: linear-gradient(180deg, var(--acc), #b8860b, #8b6508);
    border: none;
    font-size: 24px;
    font-weight: bold;
    color: #111; /* near-black for readability */
    cursor: pointer;
    z-index: 9999;

    /* Better aesthetics */
    padding: 6px 12px;
    border-radius: 50%; /* circular button */
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
    transition: all 0.3s ease;
  }

  .close-btn:hover {
    color: #fff; /* white icon on hover */
    background: linear-gradient(180deg, #b8860b, #8b6508, #5a3a02);
    transform: scale(1.1); /* subtle zoom */
  }
    
</style>


</head>

<body>
  <div class="auth-overlay">
    <main>
    <section class="card auth-modal" aria-live="polite">
      <h1>Sign in to continue</h1>
        <p class="muted">"Browse only approved builder projects ‚Äî safe, transparent, and verified"</p>

        <div id="authed" class="hidden">
          <div class="success-block">
            <div class="flex">
              <strong>You're signed in</strong>
              <span id="userEmail" class="right"></span>
            </div>
            <div id="continueWrap" class="flex" style="margin-top:8px">
              <button id="continueBtn" class="btn btn-primary">Continue</button>
              <a id="viewHome" class="btn btn-ghost" href="/">Go Home</a>
              <button id="signOutBtn" class="btn btn-danger right">Sign out</button>
            </div>
          </div>
        </div>

        <form id="authForm" autocomplete="on">
          <label for="email">Email</label>
          <input id="email" name="email" type="email" placeholder="you@domain.com" autocomplete="email" required>

          <div class="row">
            <div style="flex:1">
              <label for="password">Password <span class="hint">(optional ‚Äî use Magic Link for fastest login)</span></label>

              <div class="input-pill" style="position:relative;">
                <input id="password" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                <span id="toggleEye" class="toggle-eye" role="button" aria-label="Show password">üëÅ</span>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="magicBtn" class="btn btn-primary" type="button">Continue with Magic Link</button>
            <button id="pwdBtn" class="btn btn-ghost" type="button">Sign in with Password</button>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="signupBtn" class="btn btn-ghost" type="button">Create Account</button>
            <a id="forgotLink" class="small-link right" href="/reset_password/">Forgot password?</a>

          </div>

          <div id="msg" class="msg" role="status"></div>
        </form>

        <div class="divider"></div>

        <div class="hint">
          Tip: If you reached this page after clicking a partner link, we'll return you there after sign-in.
        </div>
        <button class="close-btn" onclick="(window.self!==window.parent) ? window.parent.postMessage({type:'close_login_modal'}, '*') : window.history.back()">√ó</button>


    </section>
    </main>
  </div>

  <script type="module">
    //let hasRedirected = false;
    // ========================= CONFIG =========================
    const SUPABASE_URL = 'https://wedevtjjmdvngyshqdro.supabase.co'; // <-- REQUIRED
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M'; // <-- REQUIRED

    const __qs = new URLSearchParams(location.search);
    const FALLBACK_PARENT_ORIGIN = 'https://tharaga.co.in';
    const PARENT_ORIGIN = (__qs.get('parent_origin') || FALLBACK_PARENT_ORIGIN || location.origin).replace(/\/$/, '');
    const POST_AUTH_CALLBACK = `${PARENT_ORIGIN}/login_signup/?post_auth=1`;

    // ========================= IMPORT =========================
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabase = supabase; // expose for DevTools

    // ---------- robust redirect token handler ----------
    async function handleRedirectTokens() {
      try {
        const { data } = await supabase.auth.getSession();
        if (data?.session) return data.session;
      } catch (e) {
        console.warn('getSession thrown', e);
      }

      const isPostAuth = new URLSearchParams(location.search).get('post_auth') === '1';

      const rawHash = (location.hash || '').replace(/^#/, '');
      const params = new URLSearchParams(rawHash || location.search || '');
      const access_token = params.get('access_token');
      const refresh_token = params.get('refresh_token');

      if (access_token && refresh_token) {
        // --- Notify other tabs / parent that magic link landed --- //
          try {
            // derive a sensible 'next' if available
            let pendingNext = null;
            try {
              pendingNext = JSON.parse(localStorage.getItem('post_auth_target') || 'null')?.href || new URLSearchParams(location.search).get('next') || null;
            } catch (_e) {
              pendingNext = new URLSearchParams(location.search).get('next') || null;
            }

            const payload = {
              ts: Date.now(),
              next: pendingNext,
              user: data?.session?.user ? { id: data.session.user.id, email: data.session.user.email } : null
            };

            // Write only the CONFIRMED key here ‚Äî do NOT auto-write __tharaga_magic_continue.
            try { localStorage.setItem('__tharaga_magic_confirmed', JSON.stringify(payload)); } catch (e) { console.warn('Could not write magic confirmed', e); }

            // If embedded inside an iframe, also postMessage to parent (use parent_origin if passed)
            const parentOrigin = new URLSearchParams(location.search).get('parent_origin');
            if (window.self !== window.parent) {
              try {
                // parent should validate origin; we send payload.user and payload.next
                window.parent.postMessage({ type: 'signed_in', user: payload.user, next: payload.next }, parentOrigin || '*');
              } catch (e) { /* ignore */ }
            }
          } catch (e) {
            console.warn('notify-magic-confirmed failed', e);
          }
      }

      if (isPostAuth) {
        return null;
      }
      return null;
    }

    (async () => {
      console.log('PAGE LOAD - location.href:', location.href);
      console.log('PAGE LOAD - location.hash:', location.hash);
      console.log('PAGE LOAD - location.search:', location.search);

      const session = await handleRedirectTokens();
      console.log('handleRedirectTokens -> session?', !!session);
    })();
  

    // ========================= UI HOOKS ========================
    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();


    const form = document.getElementById('authForm');
    const authed = document.getElementById('authed');
    const magicBtn = document.getElementById('magicBtn');
    const pwdBtn = document.getElementById('pwdBtn');
    const signupBtn = document.getElementById('signupBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const continueBtn = document.getElementById('continueBtn');
    const emailEl = document.getElementById('email');
    const pwdEl = document.getElementById('password');
    const msgEl = document.getElementById('msg');
    const userEmail = document.getElementById('userEmail');
	const toggleEye=document.getElementById('toggleEye');

    // ========================= HELPERS =========================
    const storage = {
      get(){ try { return JSON.parse(localStorage.getItem('post_auth_target')||'null'); } catch { return null } },
      set(v){ localStorage.setItem('post_auth_target', JSON.stringify(v)); },
      clear(){ localStorage.removeItem('post_auth_target'); }
    };

    function setMsg(text, ok=false){
      msgEl.textContent = text || '';
      msgEl.className = 'msg' + (text? (ok? ' ok':' err') : '');
    }

    function getNextFromQuery(){
      const p = new URLSearchParams(location.search);
      return p.get('next');
    }

    function isSafeRedirect(href) {
      try {
        const url = new URL(href, location.origin);
        return url.origin === location.origin || url.origin === new URL(PARENT_ORIGIN).origin;
      } catch { return false; }
    }

    function ensurePendingTargetFromQuery(){
      const next = new URLSearchParams(location.search).get('next');
      if (!next || storage.get()) return;
      try {
        const url = new URL(next, location.origin);
        if (isSafeRedirect(url.href)) {
          storage.set({ href: url.href, openInNewTab: false });
        } else {
          console.warn('Rejected unsafe next redirect (ensure isSafeRedirect allows PARENT_ORIGIN):', url.href);
        }
      } catch (e) {
        console.warn('Invalid next param', e);
      }
    }


    function showAuthed(email){
      userEmail.textContent = email ? `‚Ä¢ ${email}` : '';
      authed.classList.remove('hidden');
      form.classList.add('hidden');
    }
    function showForm(){
      authed.classList.add('hidden');
      form.classList.remove('hidden');
    }

	// === Password eye toggle ===
    toggleEye.addEventListener('click',()=>{
      const t=pwdEl.type==='password'?'text':'password';
      pwdEl.type=t;
      toggleEye.textContent=t==='password'?'üëÅ':'üôà';
    });

    // ========================= INIT ===========================
    ensurePendingTargetFromQuery();

    (async function onInit(){
      try {
        const { data } = await supabase.auth.getSession();
        const session = data?.session;
        const pending = storage.get();
        const isPostAuth = new URLSearchParams(location.search).get('post_auth') === '1';

        // If already signed in
        if (session) {
          showAuthed(session.user?.email);

          // If this is the tab that processed the magic link
          if (isPostAuth) {
            setMsg('Thanks ‚Äî you are signed in. Returning to the app‚Ä¶', true);
            const pendingNextFromStorage = storage.get()?.href;
            const nextFromQuery = new URLSearchParams(location.search).get('next');
            const targetNext = pendingNextFromStorage || nextFromQuery;

            const continuePayload = {
              ts: Date.now(),
              next: targetNext,
              user: session?.user ? { id: session.user.id, email: session.user.email } : null
            };

            // 1) Signal other tabs (auth-gate listens for this key)
            try {
              localStorage.setItem('__tharaga_magic_continue', JSON.stringify(continuePayload));
              localStorage.setItem('__tharaga_magic_confirmed', JSON.stringify({ ts: Date.now() }));
            } catch (e) {
              console.warn('Could not write magic-continue to localStorage', e);
            }

            // 2) If embedded inside an iframe, also postMessage to parent (immediate)
            try {
              if (window.self !== window.parent) {
                const parentOrigin = new URLSearchParams(location.search).get('parent_origin');
                window.parent.postMessage({
                  type: 'signed_in',
                  user: continuePayload.user,
                  next: continuePayload.next
                }, parentOrigin || '*');
              }
            } catch (e) { /* ignore */ }

            // Automatic redirect to the `next` page if available
            if (targetNext && isSafeRedirect(targetNext)) {
                setTimeout(() => {
                    storage.clear(); // Clear storage before redirecting
                    location.href = targetNext;
                }, 1000); // Give some time for message to propagate
            } else if (window.self !== window.parent) {
                // If embedded and no safe next target, try to close the modal directly
                setTimeout(() => {
                  window.parent.postMessage({type:'close_login_modal'}, new URLSearchParams(location.search).get('parent_origin') || '*');
                }, 500);
            } else {
                // Fallback for standalone tab if no next target (go home)
                setTimeout(() => {
                  storage.clear();
                  location.href = '/';
                }, 1000);
            }

            return;
          }

          // Normal behaviour (not a magic-link tab): resume pending redirect automatically
          if (pending && isSafeRedirect(pending.href)) {
            setTimeout(() => {
              storage.clear();
              if (pending.openInNewTab) window.open(pending.href, '_blank');
              else location.href = pending.href;
            }, 400);
          } else if (pending) {
            console.warn('Blocked unsafe pending redirect:', pending.href);
            storage.clear();
          }

          return;
        }

        // Not signed in
        showForm();
      } catch (e) {
        console.error(e);
        showForm();
      }
    })();

    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
      // This listener handles state changes. For magic links, the page will already have been handled by onInit().
      if (session?.access_token) {
        showAuthed(session.user?.email);

        const pending = storage.get();
        const nextFromQuery = new URLSearchParams(location.search).get('next');
        const targetNext = pending?.href || nextFromQuery;

        if (window.self !== window.parent) {
          const msg = {
            type: 'signed_in',
            user: { id: session.user?.id, email: session.user?.email },
            next: targetNext
          };
          window.parent.postMessage(msg, new URLSearchParams(location.search).get('parent_origin') || '*');
        }

        const isPostAuth = new URLSearchParams(location.search).get('post_auth') === '1';

        // Auto-redirect for magic links if not embedded, or if password sign-in has a pending target
        if (isPostAuth || (event === 'SIGNED_IN' && pending && isSafeRedirect(pending.href))) {
          setMsg('Signed in. Returning to the app...', true);
          setTimeout(() => {
            const redirectTarget = isPostAuth ? targetNext : pending?.href;
            if (redirectTarget && isSafeRedirect(redirectTarget)) {
              storage.clear();
              location.href = redirectTarget;
            } else {
              storage.clear();
              location.href = '/';
            }
          }, 1000);
        } else {
          setMsg('Signed in ‚úì', true); // Password sign-in, wait for user to click continue
        }
      }
    });


    // unsubscribe on unload (optional, good practice)
    window.addEventListener('beforeunload', () => subscription?.unsubscribe());

    // ========================= ACTIONS ========================
    magicBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      if (!email) return setMsg('Enter a valid email');
      setMsg('Sending magic link‚Ä¶');
      // Ensure a pending target exists
      if (!storage.get()) {
        const fallback = document.referrer && new URL(document.referrer).origin === location.origin
          ? new URL(document.referrer).pathname
          : '/';
        storage.set({ href: fallback, openInNewTab: false });
      }
      console.debug && console.debug('magic link redirect target ->', POST_AUTH_CALLBACK);
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: POST_AUTH_CALLBACK }
      });
      if (error) setMsg(error.message);
      else setMsg('Magic link sent! Check your inbox (and spam).', true);
    });

    pwdBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = pwdEl.value;
      if (!email || !password) return setMsg('Enter email + password');
      setMsg('Signing in‚Ä¶');
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) setMsg(error.message);
      else setMsg('Signed in ‚úì', true);
    });

    signupBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = pwdEl.value;
      if (!email || !password) return setMsg('Enter email + password to create account');
      setMsg('Creating account‚Ä¶');
      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: POST_AUTH_CALLBACK }
      });
      if (error) setMsg(error.message);
      else setMsg('Account created. Check your email to confirm.', true);
    });

    signOutBtn?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      storage.clear();
      showForm();
      setMsg('Signed out.', true);
    });

    continueBtn?.addEventListener('click', () => {
      const pending = storage.get();
      try {
        localStorage.setItem('__tharaga_magic_continue', JSON.stringify({ ts: Date.now(), next: pending?.href || null }));
      } catch (e) {}

      if (pending && isSafeRedirect(pending.href)) {
        if (pending.openInNewTab) {
          window.open(pending.href, '_blank');
        } else {
          location.href = pending.href;
        }
      } else {
        location.href = '/';
      }
      storage.clear();
    });

    // ========================= OPTIONAL: "Gate snippet" for other pages =========================
    
    window.enableAuthGate = function enableAuthGate({ selector = 'a', protectedDomains = [] } = {}){
      document.addEventListener('click', async (e) => {
        const el = e.target.closest(selector);
        if (!el) return;
        const isExplicit = el.dataset?.protected === 'true';
        const href = el.getAttribute?.('href');
        const isButton = !href;
        const openInNewTab = el.dataset?.openNewTab === 'true' || el.target === '_blank';

        let needsProtect = isExplicit;
        if (!needsProtect && href) {
          try {
            const url = new URL(href, location.href);
            needsProtect = protectedDomains.some(d => url.hostname.includes(d));
          } catch {}
        }
        if (!needsProtect) return;

        // Check auth
        const { data } = await supabase.auth.getSession();
        if (data?.session) return;

        // Block and send to login page
        e.preventDefault();
        const target = href ? { href, openInNewTab } : { href: location.pathname + location.search + location.hash, openInNewTab:false };
        localStorage.setItem('post_auth_target', JSON.stringify(target));
        location.href = `/login_signup?next=${encodeURIComponent(target.href)}`;
      }, true);
    }
  </script>
</body>
</html>