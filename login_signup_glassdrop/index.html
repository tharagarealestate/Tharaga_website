<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login / Sign up ‚Ä¢ Tharaga</title>
  <meta name="description" content="Secure login and signup for Tharaga partner portals and listings." />
   <!-- ---------- EMBED DETECTION: add class early so CSS can react ---------- -->
  <script>
    // If this page is inside an iframe, mark document so CSS can adapt
    if (window.self !== window.top) {
      try { document.documentElement.classList.add('embedded'); } catch (e) {}
    }
  </script>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>
    :root{
      --bg:#0a0a0a; --card:#151515; --muted:#9ca3af; --txt:#f5f5f5; --acc:#d4af37; --acc2:#16a34a; --warn:#f59e0b; --err:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 80% -10%,#1c1c1c 0%,transparent 60%),
        radial-gradient(900px 700px at -10% 20%,#111111 0%,transparent 60%),
        var(--bg);
      color:var(--txt);
    }
    /*.container{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px 20px;color:var(--txt);
    }
    header a, header button{color:var(--txt);text-decoration:none;font-weight:600;opacity:.85}
    header a:hover{opacity:1;color:var(--acc)}
    main{display:grid;place-items:center;padding:24px} */
    .card{
      width:420px;max-width:95vw;
      background:linear-gradient(180deg,#1a1a1a,#0f0f0f);
      backdrop-filter:saturate(180%) blur(10px);
      border:1px solid rgba(212,175,55,.25); /* subtle gold tint */
      border-radius:16px;
      box-shadow:0 10px 40px rgba(0,0,0,.55);
      padding:22px;
      color:var(--txt);
    }
     /* Fullscreen dark glass backdrop used only when NOT embedded */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }

    /* Centered modal wrapper (the card sits inside) */
    .auth-modal { animation: popupSlide 0.35s ease-out; max-height:95vh; overflow-y:auto; }

    @keyframes popupSlide { 0% { transform: translateY(40px) scale(.96); opacity:0 } 100% { transform: translateY(0) scale(1); opacity:1 } }

    /* Close button (standalone page) */
    .close-btn {
      position: fixed;
      top: 15px; right: 20px;
      background: linear-gradient(180deg, var(--acc), #b8860b, #8b6508);
      border: none; font-size: 24px; font-weight: bold; color: #111; cursor:pointer; z-index:9999;
      padding: 6px 12px; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,.25); transition:all .2s;
    }
    .close-btn:hover { transform: scale(1.06); color:#fff; }

    /* small screen tweaks */
    @media (max-width:420px){
      .card{width:96vw;padding:16px}
      .close-btn{top:8px;right:8px}
    }

    /* ---------- EMBEDDED MODE OVERRIDES ---------- */
    /* When embedded (iframe), we want the parent overlay to do the dimming. */
    .embedded body, .embedded html {
      /* ensure iframe background is transparent */
      background: transparent !important;
    }

    /* make page-level overlay transparent so parent overlay shows through */
    .embedded .auth-overlay {
      background: transparent !important;
      pointer-events: none; /* allow only the modal to receive pointer events */
    }

    /* enable pointer events on the modal only */
    .embedded .auth-overlay .auth-modal {
      pointer-events: auto;
      background: transparent; /* keep modal wrapper transparent */
      display:flex; align-items:center; justify-content:center;
      min-height:0;
    }

    /* the card itself remains visually distinct inside the iframe */
    .embedded .card {
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.5);
      margin: 0 auto;
    }

    /* place the close button inside the iframe card area (not fixed full-screen) */
    .embedded .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 10002;
      transform: none;
    }

    /* ensure the modal content can scroll within the card if needed */
    .embedded .auth-overlay { align-items: center; justify-content: center; padding: 10px; }
  </style>
</head>

<body>
  <!-- page-level overlay. In embedded mode this becomes transparent so parent overlay shows -->
  <div class="auth-overlay" id="authOverlay">
    <main>
    <section class="card auth-modal" aria-live="polite" id="authCard">
      <!-- everything you already have inside main goes here -->
      <h1>Sign in to continue</h1>
        <p class="muted">"Browse only approved builder projects ‚Äî safe, transparent, and verified"</p>

        <!-- session-state area (hidden until logged in) -->
        <div id="authed" class="hidden">
          <div class="success-block">
            <div class="flex">
              <strong>You're signed in</strong>
              <span id="userEmail" class="right"></span>
            </div>
            <div id="continueWrap" class="flex" style="margin-top:8px">
              <button id="continueBtn" class="btn btn-primary">Continue</button>
              <a id="viewHome" class="btn btn-ghost" href="/">Go Home</a>
              <button id="signOutBtn" class="btn btn-danger right">Sign out</button>
            </div>
          </div>
        </div>

        <!-- auth form (hidden if logged in) -->
        <form id="authForm" autocomplete="on">
          <label for="email">Email</label>
          <input id="email" name="email" type="email" placeholder="you@domain.com" autocomplete="email" required>

          <div class="row">
            <div style="flex:1">
              <label for="password">Password <span class="hint">(optional ‚Äî use Magic Link for fastest login)</span></label>

              <!-- NEW: input wrapper that becomes the positioning context -->
              <div class="input-pill" style="position:relative;">
                <input id="password" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                <span id="toggleEye" class="toggle-eye" role="button" aria-label="Show password">üëÅ</span>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="magicBtn" class="btn btn-primary" type="button">Continue with Magic Link</button>
            <button id="pwdBtn" class="btn btn-ghost" type="button">Sign in with Password</button>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="signupBtn" class="btn btn-ghost" type="button">Create Account</button>
            <a id="forgotLink" class="small-link right" href="#">Forgot password?</a>

          </div>

          <div id="msg" class="msg" role="status"></div>
        </form>
    </section>
    </main>
  </div>
  <!-- single close button; it will be positioned absolute inside card when embedded -->
  <button class="close-btn" id="closeBtn" aria-label="Close">√ó</button>

  <!-- Auth + Gate Logic -->
  <script type="module">
    let hasRedirected = false;
    // ========================= CONFIG =========================
    // Fill these with your project values
    const SUPABASE_URL = 'https://wedevtjjmdvngyshqdro.supabase.co'; // <-- REQUIRED
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M';         // <-- REQUIRED

    // Domains we auto-protect when using the gate snippet on other pages
    //const PROTECTED_DOMAINS = ['nobroker', 'magicbricks', '99acres', 'housing.com', 'makaan', 'quikrhomes'];

    // Callback page for magic links / email confirmations. Keep under your domain and add to Supabase Redirect URLs.
    const POST_AUTH_CALLBACK = `${location.origin}/login_signup/?post_auth=1`;

    // ========================= IMPORT =========================
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabase = supabase; // expose for DevTools

    // ---------- INSERT: robust redirect token handler ----------
async function handleRedirectTokens() {
  // 1) SDK may already have a session stored (fast path)
  try {
    const { data } = await supabase.auth.getSession();
    if (data?.session) {
      return data.session;
    }
  } catch (e) {
    console.warn('getSession thrown', e);
  }

  // 2) Parse fragment (#access_token=...) first, then query
  const rawHash = window.location.hash.replace(/^#/, '');
  const params = new URLSearchParams(rawHash || window.location.search || '');
  const access_token = params.get('access_token');
  const refresh_token = params.get('refresh_token');

  if (access_token && refresh_token) {
    // try to set the session
    const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
    if (error) {
      console.error('Failed to setSession from redirect tokens', error);
      return null;
    }
    // Clean tokens from URL but keep other query params intact
    const cleanedSearch = location.search
      .replace(/([?&])access_token=[^&]*(&?)/g,'$1')
      .replace(/([?&])refresh_token=[^&]*(&?)/g,'$1')
      .replace(/(^\?|&$)/,'');
    history.replaceState(null, '', location.pathname + (cleanedSearch ? '?' + cleanedSearch : ''));

    return data?.session ?? null;
  }
  
  if (new URLSearchParams(location.search).get('post_auth') === '1') {
  history.replaceState(null, '', location.pathname);
  return null;
  }
}

// Call it once on load
(async () => {
  console.log('PAGE LOAD - location.href:', location.href);
  console.log('PAGE LOAD - location.hash:', location.hash);
  console.log('PAGE LOAD - location.search:', location.search);

  const session = await handleRedirectTokens();
  console.log('handleRedirectTokens -> session?', !!session);
  // don't return here; let the rest of onInit() decide UI state
})();



    // ========================= UI HOOKS ========================
    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();


    const form = document.getElementById('authForm');
    const authed = document.getElementById('authed');
    const magicBtn = document.getElementById('magicBtn');
    const pwdBtn = document.getElementById('pwdBtn');
    const signupBtn = document.getElementById('signupBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const continueBtn = document.getElementById('continueBtn');
    const emailEl = document.getElementById('email');
    const pwdEl = document.getElementById('password');
    const msgEl = document.getElementById('msg');
    const userEmail = document.getElementById('userEmail');
	const toggleEye=document.getElementById('toggleEye');

    // ========================= HELPERS =========================
    const storage = {
      get(){ try { return JSON.parse(localStorage.getItem('post_auth_target')||'null'); } catch { return null } },
      set(v){ localStorage.setItem('post_auth_target', JSON.stringify(v)); },
      clear(){ localStorage.removeItem('post_auth_target'); }
    };

    function setMsg(text, ok=false){
      msgEl.textContent = text || '';
      msgEl.className = 'msg' + (text? (ok? ' ok':' err') : '');
    }

    function getNextFromQuery(){
      const p = new URLSearchParams(location.search);
      return p.get('next');
    }

    function isSafeRedirect(href) {
      try {
        const url = new URL(href, location.origin);
        // allow only same-origin or explicitly allowed origins (extend array if needed)
        return url.origin === location.origin;
      } catch { return false; }
    }

    function ensurePendingTargetFromQuery(){
      const next = new URLSearchParams(location.search).get('next');
      if (!next || storage.get()) return;
      try {
        const url = new URL(next, location.origin); // handles relative or absolute
        if (isSafeRedirect(url.href)) {
          storage.set({ href: url.href, openInNewTab: false });
        } else {
          console.warn('Rejected unsafe next redirect:', url.href);
        }
      } catch (e) {
        console.warn('Invalid next param', e);
      }
    }


    function showAuthed(email){
      userEmail.textContent = email ? `‚Ä¢ ${email}` : '';
      authed.classList.remove('hidden');
      form.classList.add('hidden');
    }
    function showForm(){
      authed.classList.add('hidden');
      form.classList.remove('hidden');
    }

	// === Password eye toggle ===
    toggleEye.addEventListener('click',()=>{
      const t=pwdEl.type==='password'?'text':'password';
      pwdEl.type=t;
      toggleEye.textContent=t==='password'?'üëÅ':'üôà';
    });

    // ========================= INIT ===========================
    ensurePendingTargetFromQuery();

    // When page loads, if already signed in and have pending target, continue.
    (async function onInit(){
      try {
        const { data } = await supabase.auth.getSession();
        const session = data?.session;
        const pending = storage.get();
        if (session) {
          showAuthed(session.user?.email);
          if (pending && isSafeRedirect(pending.href)) {
            setTimeout(()=>{
              storage.clear();
              if (pending.openInNewTab) window.open(pending.href, '_blank');
              else location.href = pending.href;
            }, 400);
          } else if (pending) {
            console.warn('Blocked unsafe pending redirect:', pending.href);
            storage.clear();
          }
        } else {
          showForm();
        }
      } catch (e) {
        console.error(e);
        showForm();
      }
    })();

    // Supabase will fire this when magic link lands or password sign-in completes
    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
  if (session?.access_token) {
    showAuthed(session.user?.email);

    const pending = storage.get();

    // If embedded inside an iframe, postMessage to parent so they can resume flow
    if (window.self !== window.parent) {
      const msg = {
        type: 'signed_in',
        user: { id: session.user?.id, email: session.user?.email },
        next: pending?.href || new URLSearchParams(location.search).get('next') || null
      };
      // Use specific origin instead of '*' when you know the parent origin.
      window.parent.postMessage(msg, PARENT_ORIGIN);

      // Optionally clear local pending target (iframe can keep its copy)
      // storage.clear();
    } else {
      // Not embedded ‚Äî fallback to original behaviour (redirect to pending or home)
      if (pending && isSafeRedirect(pending.href)) {
        storage.clear();
        if (pending.openInNewTab) window.open(pending.href, '_blank');
        else location.href = pending.href;
      } else if (new URLSearchParams(location.search).get('post_auth') === '1') {
        setTimeout(()=>{ location.href = '/'; }, 500);
      }
    }
  }
});


// unsubscribe on unload (optional, good practice)
window.addEventListener('beforeunload', () => subscription?.unsubscribe());

    // ========================= ACTIONS ========================
    magicBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      if (!email) return setMsg('Enter a valid email');
      setMsg('Sending magic link‚Ä¶');
      // Ensure a pending target exists; if none, default to referer or home
      if (!storage.get()) {
        const fallback = document.referrer && new URL(document.referrer).origin === location.origin
          ? new URL(document.referrer).pathname
          : '/';
        storage.set({ href: fallback, openInNewTab: false });
      }
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: POST_AUTH_CALLBACK }
      });
      if (error) setMsg(error.message);
      else setMsg('Magic link sent! Check your inbox (and spam).', true);
    });

    pwdBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = pwdEl.value;
      if (!email || !password) return setMsg('Enter email + password');
      setMsg('Signing in‚Ä¶');
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) setMsg(error.message);
      else setMsg('Signed in ‚úì', true);
    });

    signupBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = pwdEl.value;
      if (!email || !password) return setMsg('Enter email + password to create account');
      setMsg('Creating account‚Ä¶');
      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: "${location.origin}/login_signup/?post_auth=1" }
      });
      if (error) setMsg(error.message);
      else setMsg('Account created. Check your email to confirm.', true);
    });

    signOutBtn?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      storage.clear();
      showForm();
      setMsg('Signed out.', true);
    });

    continueBtn?.addEventListener('click', () => {
  const pending = storage.get();

  if (pending && isSafeRedirect(pending.href)) {
    if (pending.openInNewTab) {
      window.open(pending.href, '_blank');
    } else {
      location.href = pending.href;
    }
  } else if (pending) {
    console.warn('Blocked unsafe pending redirect:', pending.href);
    location.href = '/'; // fallback if pending exists but unsafe
  } else {
    location.href = '/'; // fallback if no pending redirect
  }

  storage.clear();
});

    // ========================= OPTIONAL: "Gate snippet" for other pages =========================
    // Copy the function below into any page where you want to protect links/buttons.
    // Example usage:
    //   enableAuthGate({ selector: 'a', protectedDomains: PROTECTED_DOMAINS });
    //   // to explicitly protect any element: add data-protected="true", data-open-new-tab="true"
    
    window.enableAuthGate = function enableAuthGate({ selector = 'a', protectedDomains = PROTECTED_DOMAINS } = {}){
      document.addEventListener('click', async (e) => {
        const el = e.target.closest(selector);
        if (!el) return;
        const isExplicit = el.dataset?.protected === 'true';
        const href = el.getAttribute?.('href');
        const isButton = !href; // for buttons/CTAs
        const openInNewTab = el.dataset?.openNewTab === 'true' || el.target === '_blank';

        let needsProtect = isExplicit;
        if (!needsProtect && href) {
          try {
            const url = new URL(href, location.href);
            needsProtect = protectedDomains.some(d => url.hostname.includes(d));
          } catch {}
        }
        if (!needsProtect) return;

        // Check auth
        const { data } = await supabase.auth.getSession();
        if (data?.session) return; // already logged in, allow default

        // Block and send to login page
        e.preventDefault();
        const target = href ? { href, openInNewTab } : { href: location.pathname + location.search + location.hash, openInNewTab:false };
        localStorage.setItem('post_auth_target', JSON.stringify(target));
        location.href = `/login_signup?next=${encodeURIComponent(target.href)}`;
      }, true);
    }
  </script>
</body>
</html>
