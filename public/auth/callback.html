<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Signing you in…</title>
  <style>
    body{font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#f6f7fb}
    .box{max-width:720px;padding:28px;border-radius:12px;background:#fff;box-shadow:0 6px 30px rgba(20,20,40,0.06);text-align:center}
    #detail{opacity:.85;margin-top:10px;font-size:14px}
    pre.debug{background:#111;color:#fff;padding:12px;border-radius:8px;max-height:240px;overflow:auto;text-align:left;font-size:12px}
  </style>
  <script>
    if (window.top !== window.self) {
      try { window.top.location = window.location.href; } catch(_) {}
    }
  </script>
</head>
<body>
  <div class="box">
    <h2 id="status">Finalizing sign-in…</h2>
    <div id="detail">Please wait — completing authentication.</div>
    <div id="debugOutput" style="margin-top:14px;display:none">
      <h4>Debug</h4>
      <pre id="debugPre" class="debug"></pre>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const debugMode = new URL(location.href).searchParams.has('debug') || false;
    const debugOutputEl = document.getElementById('debugOutput');
    const debugPre = document.getElementById('debugPre');
    if (debugMode) debugOutputEl.style.display = 'block';

    const dbg = (k,v) => {
      const line = `${new Date().toISOString()} | ${k} : ${typeof v === 'string' ? v : JSON.stringify(v)}`;
      console.info('THARAGA_AUTH_DEBUG', line);
      if (debugMode) {
        debugPre.textContent += line + '\n';
      }
    };

    const SUPABASE_URL = window.__SUPABASE_URL__ || 'https://wedevtjjmdvngyshqdro.supabase.co';
    const SUPABASE_ANON = window.__SUPABASE_ANON__ || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlZGV2dGpqbWR2bmd5c2hxZHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzYwMzgsImV4cCI6MjA3MTA1MjAzOH0.Ex2c_sx358dFdygUGMVBohyTVto6fdEQ5nydDRh9m6M';
    const supabase = window.supabase || createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession: true } });

    const statusEl = document.getElementById('status');
    const detailEl = document.getElementById('detail');
    const qp = new URLSearchParams(location.search);
    const next = qp.get('next') || qp.get('redirect_to') || '/';

    const BROADCAST_CHANNEL_NAME = 'tharaga-auth';
    const bc = ('BroadcastChannel' in window) ? new BroadcastChannel(BROADCAST_CHANNEL_NAME) : null;

    function setLocalMarker(obj){
      try { localStorage.setItem('__tharaga_magic_confirmed', JSON.stringify(obj)); } catch(e){}
    }

    function notifySuccess(){
      dbg('notify', { next });
      try { bc && bc.postMessage({ type:'THARAGA_AUTH_SUCCESS', next }); } catch(e){ dbg('bc.err', e); }
      try {
        if (window.opener && !window.opener.closed) {
          window.opener.postMessage({ type: 'THARAGA_AUTH_SUCCESS', next }, location.origin);
          dbg('postMessage to opener', true);
        }
      } catch (e) { dbg('postMessage.err', e); }
      setLocalMarker({ ts: Date.now(), next });
    }

    function finalRedirect(){
      setTimeout(() => {
        try { window.close(); dbg('window.close() attempted', true); } catch(e){ dbg('window.close.err', e); }
        try { location.replace(next); dbg('location.replace', next); } catch(e){ dbg('location.replace.err', e); }
      }, 700);
    }

    function onSuccessDisplay(){
      statusEl.textContent = 'You are signed in — returning to the app';
      detailEl.textContent = 'If the previous tab does not update automatically, please close this tab.';
    }

    function onFailDisplay(msg){
      statusEl.textContent = 'Sign-in failed';
      detailEl.textContent = msg || 'The link may be expired. Return to the app and request a new link.';
    }

    async function finishWithSession(note){
      dbg('finishWithSession', note);
      onSuccessDisplay();
      notifySuccess();
      finalRedirect();
    }

    async function attempt() {
      dbg('start', { href: location.href, hash: location.hash, search: location.search });
      try {
        // Prefer explicit fragment tokens first (offline-friendly)
        if (location.hash && location.hash.includes('access_token')) {
          const hashParams = new URLSearchParams(location.hash.replace(/^#/, '?'));
          const access_token = hashParams.get('access_token');
          const refresh_token = hashParams.get('refresh_token');
          dbg('hashParams', { access_token: !!access_token, refresh_token: !!refresh_token });
          if (access_token && refresh_token) {
            if (!supabase || !supabase.auth || typeof supabase.auth.setSession !== 'function') {
              throw new Error('Supabase client or setSession() not available');
            }
            const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
            if (error) throw error;
            dbg('setSession succeeded', data);
            await finishWithSession('setSession');
            return;
          }
        }

        if (supabase && supabase.auth && typeof supabase.auth.getSessionFromUrl === 'function') {
          dbg('using', 'getSessionFromUrl');
          await supabase.auth.getSessionFromUrl({ storeSession: true }).catch(e => { dbg('getSessionFromUrl.err', e); throw e; });
          dbg('getSessionFromUrl', 'ok');
          await finishWithSession('getSessionFromUrl');
          return;
        }

        const code = qp.get('code');
        if (code && supabase && supabase.auth && typeof supabase.auth.exchangeCodeForSession === 'function') {
          dbg('exchanging code', code);
          const { data, error } = await supabase.auth.exchangeCodeForSession(code);
          if (error) throw error;
          dbg('exchangeCodeForSession', data);
          await finishWithSession('exchangeCodeForSession');
          return;
        }

        const token = qp.get('token') || qp.get('token_hash');
        if (token) {
          dbg('found token param', token);
          await finishWithSession('token param present');
          return;
        }

        dbg('no-auth-token', { hash: location.hash, search: location.search });
        onFailDisplay('No auth token found in the URL — returning to the app.');
        try { localStorage.setItem('__tharaga_magic_error', JSON.stringify({ts:Date.now(), msg:'no_auth_token'})); } catch(e){}
        setTimeout(() => location.replace(next), 1200);

      } catch (err) {
        dbg('callbackError', err?.message || err);
        console.error('THARAGA_AUTH_CALLBACK_ERROR', err);
        onFailDisplay('Returning to the app…');
        try { localStorage.setItem('__tharaga_magic_error', JSON.stringify({ts:Date.now(), msg: err?.message || 'error'})); } catch(e){}
        setTimeout(() => location.replace(next), 1200);
      }
    }

    attempt();
  </script>
</body>
</html>

